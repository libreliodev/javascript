svgedit={NS:{HTML:"http://www.w3.org/1999/xhtml",MATH:"http://www.w3.org/1998/Math/MathML",SE:"http://svg-edit.googlecode.com",SVG:"http://www.w3.org/2000/svg",XLINK:"http://www.w3.org/1999/xlink",XML:"http://www.w3.org/XML/1998/namespace",XMLNS:"http://www.w3.org/2000/xmlns/"}},svgedit.getReverseNS=function(){"use strict";var reverseNS={};return $.each(this.NS,function(name,URI){reverseNS[URI]=name.toLowerCase()}),reverseNS},function(){"use strict";var proxied=jQuery.fn.attr,svgns="http://www.w3.org/2000/svg";jQuery.fn.attr=function(key,value){var i,attr,len=this.length;if(!len)return proxied.apply(this,arguments);for(i=0;len>i;++i){var elem=this[i];if(elem.namespaceURI!==svgns)return proxied.apply(this,arguments);if(void 0!==value)elem.setAttribute(key,value);else if($.isArray(key)){for(var j=key.length,obj={};j--;){var aname=key[j];attr=elem.getAttribute(aname),(attr||"0"===attr)&&(attr=isNaN(attr)?attr:attr-0),obj[aname]=attr}return obj}if("object"!=typeof key)return attr=elem.getAttribute(key),(attr||"0"===attr)&&(attr=isNaN(attr)?attr:attr-0),attr;var v;for(v in key)elem.setAttribute(v,key[v])}return this}}(),jQuery&&function(){var win=$(window),doc=$(document);$.extend($.fn,{contextMenu:function(o,callback){return void 0==o.menu?!1:(void 0==o.inSpeed&&(o.inSpeed=150),void 0==o.outSpeed&&(o.outSpeed=75),0==o.inSpeed&&(o.inSpeed=-1),0==o.outSpeed&&(o.outSpeed=-1),$(this).each(function(){var el=$(this),offset=$(el).offset(),menu=$("#"+o.menu);menu.addClass("contextMenu"),$(this).bind("mousedown",function(e){var evt=e;$(this).mouseup(function(e){var srcElement=$(this);if(srcElement.unbind("mouseup"),2===evt.button||o.allowLeft||evt.ctrlKey&&svgedit.browser.isMac()){if(e.stopPropagation(),$(".contextMenu").hide(),el.hasClass("disabled"))return!1;var x=e.pageX,y=e.pageY,x_off=win.width()-menu.width(),y_off=win.height()-menu.height();x>x_off-15&&(x=x_off-15),y>y_off-30&&(y=y_off-30),doc.unbind("click"),menu.css({top:y,left:x}).fadeIn(o.inSpeed),menu.find("A").mouseover(function(){menu.find("LI.hover").removeClass("hover"),$(this).parent().addClass("hover")}).mouseout(function(){menu.find("LI.hover").removeClass("hover")}),doc.keypress(function(e){switch(e.keyCode){case 38:menu.find("LI.hover").length?(menu.find("LI.hover").removeClass("hover").prevAll("LI:not(.disabled)").eq(0).addClass("hover"),menu.find("LI.hover").length||menu.find("LI:last").addClass("hover")):menu.find("LI:last").addClass("hover");break;case 40:0==menu.find("LI.hover").length?menu.find("LI:first").addClass("hover"):(menu.find("LI.hover").removeClass("hover").nextAll("LI:not(.disabled)").eq(0).addClass("hover"),menu.find("LI.hover").length||menu.find("LI:first").addClass("hover"));break;case 13:menu.find("LI.hover A").trigger("click");break;case 27:doc.trigger("click")}}),menu.find("A").unbind("mouseup"),menu.find("LI:not(.disabled) A").mouseup(function(){return doc.unbind("click").unbind("keypress"),$(".contextMenu").hide(),callback&&callback($(this).attr("href").substr(1),$(srcElement),{x:x-offset.left,y:y-offset.top,docX:x,docY:y}),!1}),setTimeout(function(){doc.click(function(){return doc.unbind("click").unbind("keypress"),menu.fadeOut(o.outSpeed),!1})},0)}})}),$("#"+o.menu).each($.browser.mozilla?function(){$(this).css({MozUserSelect:"none"})}:$.browser.msie?function(){$(this).bind("selectstart.disableTextSelect",function(){return!1})}:function(){$(this).bind("mousedown.disableTextSelect",function(){return!1})}),$(el).add($("UL.contextMenu")).bind("contextmenu",function(){return!1})}),$(this))},disableContextMenuItems:function(o){return void 0==o?($(this).find("LI").addClass("disabled"),$(this)):($(this).each(function(){if(void 0!=o)for(var d=o.split(","),i=0;i<d.length;i++)$(this).find('A[href="'+d[i]+'"]').parent().addClass("disabled")}),$(this))},enableContextMenuItems:function(o){return void 0==o?($(this).find("LI.disabled").removeClass("disabled"),$(this)):($(this).each(function(){if(void 0!=o)for(var d=o.split(","),i=0;i<d.length;i++)$(this).find('A[href="'+d[i]+'"]').parent().removeClass("disabled")}),$(this))},disableContextMenu:function(){return $(this).each(function(){$(this).addClass("disabled")}),$(this)},enableContextMenu:function(){return $(this).each(function(){$(this).removeClass("disabled")}),$(this)},destroyContextMenu:function(){return $(this).each(function(){$(this).unbind("mousedown").unbind("mouseup")}),$(this)}})}(jQuery),function(){"use strict";svgedit.browser||(svgedit.browser={});var NS=svgedit.NS,supportsSvg_=function(){return!!document.createElementNS&&!!document.createElementNS(NS.SVG,"svg").createSVGRect}();if(svgedit.browser.supportsSvg=function(){return supportsSvg_},!svgedit.browser.supportsSvg())return void(window.location="browser-not-supported.html");var userAgent=navigator.userAgent,svg=document.createElementNS(NS.SVG,"svg"),isOpera_=!!window.opera,isWebkit_=userAgent.indexOf("AppleWebKit")>=0,isGecko_=userAgent.indexOf("Gecko/")>=0,isIE_=userAgent.indexOf("MSIE")>=0,isChrome_=userAgent.indexOf("Chrome/")>=0,isWindows_=userAgent.indexOf("Windows")>=0,isMac_=userAgent.indexOf("Macintosh")>=0,isTouch_="ontouchstart"in window,supportsSelectors_=function(){return!!svg.querySelector}(),supportsXpath_=function(){return!!document.evaluate}(),supportsPathReplaceItem_=function(){var path=document.createElementNS(NS.SVG,"path");path.setAttribute("d","M0,0 10,10");var seglist=path.pathSegList,seg=path.createSVGPathSegLinetoAbs(5,5);try{return seglist.replaceItem(seg,0),!0}catch(err){}return!1}(),supportsPathInsertItemBefore_=function(){var path=document.createElementNS(NS.SVG,"path");path.setAttribute("d","M0,0 10,10");var seglist=path.pathSegList,seg=path.createSVGPathSegLinetoAbs(5,5);try{return seglist.insertItemBefore(seg,0),!0}catch(err){}return!1}(),supportsGoodTextCharPos_=function(){var svgroot=document.createElementNS(NS.SVG,"svg"),svgcontent=document.createElementNS(NS.SVG,"svg");document.documentElement.appendChild(svgroot),svgcontent.setAttribute("x",5),svgroot.appendChild(svgcontent);var text=document.createElementNS(NS.SVG,"text");text.textContent="a",svgcontent.appendChild(text);var pos=text.getStartPositionOfChar(0).x;return document.documentElement.removeChild(svgroot),0===pos}(),supportsPathBBox_=function(){var svgcontent=document.createElementNS(NS.SVG,"svg");document.documentElement.appendChild(svgcontent);var path=document.createElementNS(NS.SVG,"path");path.setAttribute("d","M0,0 C0,0 10,10 10,0"),svgcontent.appendChild(path);var bbox=path.getBBox();return document.documentElement.removeChild(svgcontent),bbox.height>4&&bbox.height<5}(),supportsHVLineContainerBBox_=function(){var svgcontent=document.createElementNS(NS.SVG,"svg");document.documentElement.appendChild(svgcontent);var path=document.createElementNS(NS.SVG,"path");path.setAttribute("d","M0,0 10,0");var path2=document.createElementNS(NS.SVG,"path");path2.setAttribute("d","M5,0 15,0");var g=document.createElementNS(NS.SVG,"g");g.appendChild(path),g.appendChild(path2),svgcontent.appendChild(g);var bbox=g.getBBox();return document.documentElement.removeChild(svgcontent),15==bbox.width}(),supportsEditableText_=function(){return isOpera_}(),supportsGoodDecimals_=function(){var rect=document.createElementNS(NS.SVG,"rect");rect.setAttribute("x",.1);var crect=rect.cloneNode(!1),retValue=-1==crect.getAttribute("x").indexOf(",");return retValue||$.alert('NOTE: This version of Opera is known to contain bugs in SVG-edit.\nPlease upgrade to the <a href="http://opera.com">latest version</a> in which the problems have been fixed.'),retValue}(),supportsNonScalingStroke_=function(){var rect=document.createElementNS(NS.SVG,"rect");return rect.setAttribute("style","vector-effect:non-scaling-stroke"),"non-scaling-stroke"===rect.style.vectorEffect}(),supportsNativeSVGTransformLists_=function(){var rect=document.createElementNS(NS.SVG,"rect"),rxform=rect.transform.baseVal,t1=svg.createSVGTransform();return rxform.appendItem(t1),rxform.getItem(0)==t1}();svgedit.browser.isOpera=function(){return isOpera_},svgedit.browser.isWebkit=function(){return isWebkit_},svgedit.browser.isGecko=function(){return isGecko_},svgedit.browser.isIE=function(){return isIE_},svgedit.browser.isChrome=function(){return isChrome_},svgedit.browser.isWindows=function(){return isWindows_},svgedit.browser.isMac=function(){return isMac_},svgedit.browser.isTouch=function(){return isTouch_},svgedit.browser.supportsSelectors=function(){return supportsSelectors_},svgedit.browser.supportsXpath=function(){return supportsXpath_},svgedit.browser.supportsPathReplaceItem=function(){return supportsPathReplaceItem_},svgedit.browser.supportsPathInsertItemBefore=function(){return supportsPathInsertItemBefore_},svgedit.browser.supportsPathBBox=function(){return supportsPathBBox_},svgedit.browser.supportsHVLineContainerBBox=function(){return supportsHVLineContainerBBox_},svgedit.browser.supportsGoodTextCharPos=function(){return supportsGoodTextCharPos_},svgedit.browser.supportsEditableText=function(){return supportsEditableText_},svgedit.browser.supportsGoodDecimals=function(){return supportsGoodDecimals_},svgedit.browser.supportsNonScalingStroke=function(){return supportsNonScalingStroke_},svgedit.browser.supportsNativeTransformLists=function(){return supportsNativeSVGTransformLists_}}(),function(){"use strict";function transformToString(xform){var m=xform.matrix,text="";switch(xform.type){case 1:text="matrix("+[m.a,m.b,m.c,m.d,m.e,m.f].join(",")+")";break;case 2:text="translate("+m.e+","+m.f+")";break;case 3:text=m.a==m.d?"scale("+m.a+")":"scale("+m.a+","+m.d+")";break;case 4:var cx=0,cy=0;if(0!=xform.angle){var K=1-m.a;cy=(K*m.f+m.b*m.e)/(K*K+m.b*m.b),cx=(m.e-m.b*cy)/K}text="rotate("+xform.angle+" "+cx+","+cy+")"}return text}svgedit.transformlist||(svgedit.transformlist={});var svgroot=document.createElementNS(svgedit.NS.SVG,"svg"),listMap_={};svgedit.transformlist.SVGTransformList=function(elem){this._elem=elem||null,this._xforms=[],this._update=function(){{var i,tstr="";svgroot.createSVGMatrix()}for(i=0;i<this.numberOfItems;++i){var xform=this._list.getItem(i);tstr+=transformToString(xform)+" "}this._elem.setAttribute("transform",tstr)},this._list=this,this._init=function(){var str=this._elem.getAttribute("transform");if(str)for(var re=/\s*((scale|matrix|rotate|translate)\s*\(.*?\))\s*,?\s*/,m=!0;m;)if(m=str.match(re),str=str.replace(re,""),m&&m[1]){var x=m[1],bits=x.split(/\s*\(/),name=bits[0],val_bits=bits[1].match(/\s*(.*?)\s*\)/);val_bits[1]=val_bits[1].replace(/(\d)-/g,"$1 -");var val_arr=val_bits[1].split(/[, ]+/),letters="abcdef".split(""),mtx=svgroot.createSVGMatrix();$.each(val_arr,function(i,item){val_arr[i]=parseFloat(item),"matrix"==name&&(mtx[letters[i]]=val_arr[i])});var xform=svgroot.createSVGTransform(),fname="set"+name.charAt(0).toUpperCase()+name.slice(1),values="matrix"==name?[mtx]:val_arr;"scale"==name&&1==values.length?values.push(values[0]):"translate"==name&&1==values.length?values.push(0):"rotate"==name&&1==values.length&&values.push(0,0),xform[fname].apply(xform,values),this._list.appendItem(xform)}},this._removeFromOtherLists=function(item){if(item){var id,found=!1;for(id in listMap_){var i,len,tl=listMap_[id];for(i=0,len=tl._xforms.length;len>i;++i)if(tl._xforms[i]==item){found=!0,tl.removeItem(i);break}if(found)break}}},this.numberOfItems=0,this.clear=function(){this.numberOfItems=0,this._xforms=[]},this.initialize=function(newItem){this.numberOfItems=1,this._removeFromOtherLists(newItem),this._xforms=[newItem]},this.getItem=function(index){if(index<this.numberOfItems&&index>=0)return this._xforms[index];throw{code:1}},this.insertItemBefore=function(newItem,index){var retValue=null;if(index>=0)if(index<this.numberOfItems){this._removeFromOtherLists(newItem);var i,newxforms=new Array(this.numberOfItems+1);for(i=0;index>i;++i)newxforms[i]=this._xforms[i];newxforms[i]=newItem;var j;for(j=i+1;i<this.numberOfItems;++j,++i)newxforms[j]=this._xforms[i];this.numberOfItems++,this._xforms=newxforms,retValue=newItem,this._list._update()}else retValue=this._list.appendItem(newItem);return retValue},this.replaceItem=function(newItem,index){var retValue=null;return index<this.numberOfItems&&index>=0&&(this._removeFromOtherLists(newItem),this._xforms[index]=newItem,retValue=newItem,this._list._update()),retValue},this.removeItem=function(index){if(index<this.numberOfItems&&index>=0){var i,j,retValue=this._xforms[index],newxforms=new Array(this.numberOfItems-1);for(i=0;index>i;++i)newxforms[i]=this._xforms[i];for(j=i;j<this.numberOfItems-1;++j,++i)newxforms[j]=this._xforms[i+1];return this.numberOfItems--,this._xforms=newxforms,this._list._update(),retValue}throw{code:1}},this.appendItem=function(newItem){return this._removeFromOtherLists(newItem),this._xforms.push(newItem),this.numberOfItems++,this._list._update(),newItem}},svgedit.transformlist.resetListMap=function(){listMap_={}},svgedit.transformlist.removeElementFromListMap=function(elem){elem.id&&listMap_[elem.id]&&delete listMap_[elem.id]},svgedit.transformlist.getTransformList=function(elem){if(!svgedit.browser.supportsNativeTransformLists()){var id=elem.id||"temp",t=listMap_[id];return t&&"temp"!==id||(listMap_[id]=new svgedit.transformlist.SVGTransformList(elem),listMap_[id]._init(),t=listMap_[id]),t}return elem.transform?elem.transform.baseVal:elem.gradientTransform?elem.gradientTransform.baseVal:elem.patternTransform?elem.patternTransform.baseVal:null}}(),function(){"use strict";svgedit.math||(svgedit.math={});var NEAR_ZERO=1e-14,svg=document.createElementNS(svgedit.NS.SVG,"svg");svgedit.math.transformPoint=function(x,y,m){return{x:m.a*x+m.c*y+m.e,y:m.b*x+m.d*y+m.f}},svgedit.math.isIdentity=function(m){return 1===m.a&&0===m.b&&0===m.c&&1===m.d&&0===m.e&&0===m.f},svgedit.math.matrixMultiply=function(){for(var args=arguments,i=args.length,m=args[i-1];i-->1;){var m1=args[i-1];m=m1.multiply(m)}return Math.abs(m.a)<NEAR_ZERO&&(m.a=0),Math.abs(m.b)<NEAR_ZERO&&(m.b=0),Math.abs(m.c)<NEAR_ZERO&&(m.c=0),Math.abs(m.d)<NEAR_ZERO&&(m.d=0),Math.abs(m.e)<NEAR_ZERO&&(m.e=0),Math.abs(m.f)<NEAR_ZERO&&(m.f=0),m},svgedit.math.hasMatrixTransform=function(tlist){if(!tlist)return!1;for(var num=tlist.numberOfItems;num--;){var xform=tlist.getItem(num);if(1==xform.type&&!svgedit.math.isIdentity(xform.matrix))return!0}return!1},svgedit.math.transformBox=function(l,t,w,h,m){var transformPoint=svgedit.math.transformPoint,tl=transformPoint(l,t,m),tr=transformPoint(l+w,t,m),bl=transformPoint(l,t+h,m),br=transformPoint(l+w,t+h,m),minx=Math.min(tl.x,tr.x,bl.x,br.x),maxx=Math.max(tl.x,tr.x,bl.x,br.x),miny=Math.min(tl.y,tr.y,bl.y,br.y),maxy=Math.max(tl.y,tr.y,bl.y,br.y);return{tl:tl,tr:tr,bl:bl,br:br,aabox:{x:minx,y:miny,width:maxx-minx,height:maxy-miny}}},svgedit.math.transformListToTransform=function(tlist,min,max){if(null==tlist)return svg.createSVGTransformFromMatrix(svg.createSVGMatrix());if(min=min||0,max=max||tlist.numberOfItems-1,min=parseInt(min,10),max=parseInt(max,10),min>max){var temp=max;max=min,min=temp}var i,m=svg.createSVGMatrix();for(i=min;max>=i;++i){var mtom=i>=0&&i<tlist.numberOfItems?tlist.getItem(i).matrix:svg.createSVGMatrix();m=svgedit.math.matrixMultiply(m,mtom)}return svg.createSVGTransformFromMatrix(m)},svgedit.math.getMatrix=function(elem){var tlist=svgedit.transformlist.getTransformList(elem);return svgedit.math.transformListToTransform(tlist).matrix},svgedit.math.snapToAngle=function(x1,y1,x2,y2){var snap=Math.PI/4,dx=x2-x1,dy=y2-y1,angle=Math.atan2(dy,dx),dist=Math.sqrt(dx*dx+dy*dy),snapangle=Math.round(angle/snap)*snap;return{x:x1+dist*Math.cos(snapangle),y:y1+dist*Math.sin(snapangle),a:snapangle}},svgedit.math.rectsIntersect=function(r1,r2){return r2.x<r1.x+r1.width&&r2.x+r2.width>r1.x&&r2.y<r1.y+r1.height&&r2.y+r2.height>r1.y}}(),function(){"use strict";svgedit.units||(svgedit.units={});var elementContainer_,NS=svgedit.NS,wAttrs=["x","x1","cx","rx","width"],hAttrs=["y","y1","cy","ry","height"],unitAttrs=["r","radius"].concat(wAttrs,hAttrs),typeMap_={};svgedit.units.init=function(elementContainer){elementContainer_=elementContainer;var svg=document.createElementNS(NS.SVG,"svg");document.body.appendChild(svg);var rect=document.createElementNS(NS.SVG,"rect");rect.setAttribute("width","1em"),rect.setAttribute("height","1ex"),rect.setAttribute("x","1in"),svg.appendChild(rect);var bb=rect.getBBox();document.body.removeChild(svg);var inch=bb.x;typeMap_={em:bb.width,ex:bb.height,"in":inch,cm:inch/2.54,mm:inch/25.4,pt:inch/72,pc:inch/6,px:1,"%":0}},svgedit.units.getTypeMap=function(){return typeMap_},svgedit.units.shortFloat=function(val){var digits=elementContainer_.getRoundDigits();return isNaN(val)?$.isArray(val)?svgedit.units.shortFloat(val[0])+","+svgedit.units.shortFloat(val[1]):parseFloat(val).toFixed(digits)-0:+(+val).toFixed(digits)},svgedit.units.convertUnit=function(val,unit){return unit=unit||elementContainer_.getBaseUnit(),svgedit.units.shortFloat(val/typeMap_[unit])},svgedit.units.setUnitAttr=function(elem,attr,val){elem.setAttribute(attr,val)};var attrsToConvert={line:["x1","x2","y1","y2"],circle:["cx","cy","r"],ellipse:["cx","cy","rx","ry"],foreignObject:["x","y","width","height"],rect:["x","y","width","height"],image:["x","y","width","height"],use:["x","y","width","height"],text:["x","y"]};svgedit.units.convertAttrs=function(element){var elName=element.tagName,unit=elementContainer_.getBaseUnit(),attrs=attrsToConvert[elName];if(attrs){var i,len=attrs.length;for(i=0;len>i;i++){var attr=attrs[i],cur=element.getAttribute(attr);cur&&(isNaN(cur)||element.setAttribute(attr,cur/typeMap_[unit]+unit))}}},svgedit.units.convertToNum=function(attr,val){if(!isNaN(val))return val-0;var num;if("%"===val.substr(-1)){num=val.substr(0,val.length-1)/100;var width=elementContainer_.getWidth(),height=elementContainer_.getHeight();return wAttrs.indexOf(attr)>=0?num*width:hAttrs.indexOf(attr)>=0?num*height:num*Math.sqrt(width*width+height*height)/Math.sqrt(2)}var unit=val.substr(-2);return num=val.substr(0,val.length-2),num*typeMap_[unit]},svgedit.units.isValidUnit=function(attr,val,selectedElement){var valid=!1;if(unitAttrs.indexOf(attr)>=0)isNaN(val)?(val=val.toLowerCase(),$.each(typeMap_,function(unit){if(!valid){var re=new RegExp("^-?[\\d\\.]+"+unit+"$");re.test(val)&&(valid=!0)}})):valid=!0;else if("id"==attr){var result=!1;try{var elem=elementContainer_.getElement(val);result=null==elem||elem===selectedElement}catch(e){}return result}return valid=!0}}(),function(){"use strict";function groupBBFix(selected){if(svgedit.browser.supportsHVLineContainerBBox())try{return selected.getBBox()}catch(e){}var ret,copy,ref=$.data(selected,"ref"),matched=null;ref?(copy=$(ref).children().clone().attr("visibility","hidden"),$(svgroot_).append(copy),matched=copy.filter("line, path")):matched=$(selected).find("line, path");var issue=!1;if(matched.length)if(matched.each(function(){var bb=this.getBBox();bb.width&&bb.height||(issue=!0)}),issue){var elems=ref?copy:$(selected).children();ret=getStrokedBBox(elems)}else ret=selected.getBBox();else ret=selected.getBBox();return ref&&copy.remove(),ret}svgedit.utilities||(svgedit.utilities={});var KEYSTR="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",NS=svgedit.NS,visElems="a,circle,ellipse,foreignObject,g,image,line,path,polygon,polyline,rect,svg,text,tspan,use",visElems_arr=visElems.split(","),editorContext_=null,domdoc_=null,domcontainer_=null,svgroot_=null;svgedit.utilities.init=function(editorContext){editorContext_=editorContext,domdoc_=editorContext.getDOMDocument(),domcontainer_=editorContext.getDOMContainer(),svgroot_=editorContext.getSVGRoot()},svgedit.utilities.toXml=function(str){return str.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/,"&#x27;")},svgedit.utilities.fromXml=function(str){return $("<p/>").html(str).text()},svgedit.utilities.encode64=function(input){if(input=svgedit.utilities.encodeUTF8(input),window.btoa)return window.btoa(input);var chr1,chr2,chr3,enc1,enc2,enc3,enc4,output=new Array(4*Math.floor((input.length+2)/3)),i=0,p=0;do chr1=input.charCodeAt(i++),chr2=input.charCodeAt(i++),chr3=input.charCodeAt(i++),enc1=chr1>>2,enc2=(3&chr1)<<4|chr2>>4,enc3=(15&chr2)<<2|chr3>>6,enc4=63&chr3,isNaN(chr2)?enc3=enc4=64:isNaN(chr3)&&(enc4=64),output[p++]=KEYSTR.charAt(enc1),output[p++]=KEYSTR.charAt(enc2),output[p++]=KEYSTR.charAt(enc3),output[p++]=KEYSTR.charAt(enc4);while(i<input.length);return output.join("")},svgedit.utilities.decode64=function(input){if(window.atob)return window.atob(input);var chr1,chr2,enc1,enc2,enc3,output="",chr3="",enc4="",i=0;input=input.replace(/[^A-Za-z0-9\+\/\=]/g,"");do enc1=KEYSTR.indexOf(input.charAt(i++)),enc2=KEYSTR.indexOf(input.charAt(i++)),enc3=KEYSTR.indexOf(input.charAt(i++)),enc4=KEYSTR.indexOf(input.charAt(i++)),chr1=enc1<<2|enc2>>4,chr2=(15&enc2)<<4|enc3>>2,chr3=(3&enc3)<<6|enc4,output+=String.fromCharCode(chr1),64!=enc3&&(output+=String.fromCharCode(chr2)),64!=enc4&&(output+=String.fromCharCode(chr3)),chr1=chr2=chr3="",enc1=enc2=enc3=enc4="";while(i<input.length);return unescape(output)},svgedit.utilities.encodeUTF8=function(argString){if(null===argString||"undefined"==typeof argString)return"";var start,end,string=String(argString),utftext="",stringl=0;start=end=0,stringl=string.length;var n;for(n=0;stringl>n;n++){var c1=string.charCodeAt(n),enc=null;if(128>c1)end++;else if(c1>127&&2048>c1)enc=String.fromCharCode(c1>>6|192,63&c1|128);else if(55296!=(63488&c1))enc=String.fromCharCode(c1>>12|224,c1>>6&63|128,63&c1|128);else{if(55296!=(64512&c1))throw new RangeError("Unmatched trail surrogate at "+n);var c2=string.charCodeAt(++n);if(56320!=(64512&c2))throw new RangeError("Unmatched lead surrogate at "+(n-1));c1=((1023&c1)<<10)+(1023&c2)+65536,enc=String.fromCharCode(c1>>18|240,c1>>12&63|128,c1>>6&63|128,63&c1|128)}null!==enc&&(end>start&&(utftext+=string.slice(start,end)),utftext+=enc,start=end=n+1)}return end>start&&(utftext+=string.slice(start,stringl)),utftext},svgedit.utilities.convertToXMLReferences=function(input){var n,output="";for(n=0;n<input.length;n++){var c=input.charCodeAt(n);128>c?output+=input[n]:c>127&&(output+="&#"+c+";")}return output},svgedit.utilities.text2xml=function(sXML){sXML.indexOf("<svg:svg")>=0&&(sXML=sXML.replace(/<(\/?)svg:/g,"<$1").replace("xmlns:svg","xmlns"));var out,dXML;try{dXML=window.DOMParser?new DOMParser:new ActiveXObject("Microsoft.XMLDOM"),dXML.async=!1}catch(e){throw new Error("XML Parser could not be instantiated")}try{out=dXML.loadXML?dXML.loadXML(sXML)?dXML:!1:dXML.parseFromString(sXML,"text/xml")}catch(e2){throw new Error("Error parsing XML string")}return out},svgedit.utilities.bboxToObj=function(bbox){return{x:bbox.x,y:bbox.y,width:bbox.width,height:bbox.height}},svgedit.utilities.walkTree=function(elem,cbFn){if(elem&&1==elem.nodeType){cbFn(elem);for(var i=elem.childNodes.length;i--;)svgedit.utilities.walkTree(elem.childNodes.item(i),cbFn)}},svgedit.utilities.walkTreePost=function(elem,cbFn){if(elem&&1==elem.nodeType){for(var i=elem.childNodes.length;i--;)svgedit.utilities.walkTree(elem.childNodes.item(i),cbFn);cbFn(elem)}},svgedit.utilities.getUrlFromAttr=function(attrVal){if(attrVal){if(0===attrVal.indexOf('url("'))return attrVal.substring(5,attrVal.indexOf('"',6));if(0===attrVal.indexOf("url('"))return attrVal.substring(5,attrVal.indexOf("'",6));if(0===attrVal.indexOf("url("))return attrVal.substring(4,attrVal.indexOf(")"))}return null},svgedit.utilities.getHref=function(elem){return elem.getAttributeNS(NS.XLINK,"href")},svgedit.utilities.setHref=function(elem,val){elem.setAttributeNS(NS.XLINK,"xlink:href",val)},svgedit.utilities.findDefs=function(){var svgElement=editorContext_.getSVGContent(),defs=svgElement.getElementsByTagNameNS(NS.SVG,"defs");return defs.length>0?defs=defs[0]:(defs=svgElement.ownerDocument.createElementNS(NS.SVG,"defs"),svgElement.firstChild?svgElement.insertBefore(defs,svgElement.firstChild.nextSibling):svgElement.appendChild(defs)),defs},svgedit.utilities.getPathBBox=function(path){var i,seglist=path.pathSegList,tot=seglist.numberOfItems,bounds=[[],[]],start=seglist.getItem(0),P0=[start.x,start.y];for(i=0;tot>i;i++){var seg=seglist.getItem(i);if("undefined"!=typeof seg.x)if(bounds[0].push(P0[0]),bounds[1].push(P0[1]),seg.x1){var j,P1=[seg.x1,seg.y1],P2=[seg.x2,seg.y2],P3=[seg.x,seg.y];for(j=0;2>j;j++){var calc=function(t){return Math.pow(1-t,3)*P0[j]+3*Math.pow(1-t,2)*t*P1[j]+3*(1-t)*Math.pow(t,2)*P2[j]+Math.pow(t,3)*P3[j]},b=6*P0[j]-12*P1[j]+6*P2[j],a=-3*P0[j]+9*P1[j]-9*P2[j]+3*P3[j],c=3*P1[j]-3*P0[j];if(0!=a){var b2ac=Math.pow(b,2)-4*c*a;if(!(0>b2ac)){var t1=(-b+Math.sqrt(b2ac))/(2*a);t1>0&&1>t1&&bounds[j].push(calc(t1));var t2=(-b-Math.sqrt(b2ac))/(2*a);t2>0&&1>t2&&bounds[j].push(calc(t2))}}else{if(0==b)continue;var t=-c/b;t>0&&1>t&&bounds[j].push(calc(t))}}P0=P3}else bounds[0].push(seg.x),bounds[1].push(seg.y)}var x=Math.min.apply(null,bounds[0]),w=Math.max.apply(null,bounds[0])-x,y=Math.min.apply(null,bounds[1]),h=Math.max.apply(null,bounds[1])-y;return{x:x,y:y,width:w,height:h}},svgedit.utilities.getBBox=function(elem){var selected=elem||editorContext_.geSelectedElements()[0];if(1!=elem.nodeType)return null;var ret=null,elname=selected.nodeName;switch(elname){case"text":if(""===selected.textContent)selected.textContent="a",ret=selected.getBBox(),selected.textContent="";else try{ret=selected.getBBox()}catch(e){}break;case"path":if(svgedit.browser.supportsPathBBox())try{ret=selected.getBBox()}catch(e2){}else ret=svgedit.utilities.getPathBBox(selected);break;case"g":case"a":ret=groupBBFix(selected);break;default:if("use"===elname&&(ret=groupBBFix(selected,!0)),"use"===elname||"foreignObject"===elname&&svgedit.browser.isWebkit()){ret||(ret=selected.getBBox());var bb={};bb.width=ret.width,bb.height=ret.height,bb.x=ret.x+parseFloat(selected.getAttribute("x")||0),bb.y=ret.y+parseFloat(selected.getAttribute("y")||0),ret=bb}else if(~visElems_arr.indexOf(elname))try{ret=selected.getBBox()}catch(e3){var fo=$(selected).closest("foreignObject");if(fo.length)try{ret=fo[0].getBBox()}catch(e4){ret=null}else ret=null}}return ret&&(ret=svgedit.utilities.bboxToObj(ret)),ret},svgedit.utilities.getRotationAngle=function(elem,to_rad){var selected=elem||editorContext_.getSelectedElements()[0],tlist=svgedit.transformlist.getTransformList(selected);if(!tlist)return 0;var i,N=tlist.numberOfItems;for(i=0;N>i;++i){var xform=tlist.getItem(i);if(4==xform.type)return to_rad?xform.angle*Math.PI/180:xform.angle}return 0},svgedit.utilities.getRefElem=function(attrVal){return svgedit.utilities.getElem(svgedit.utilities.getUrlFromAttr(attrVal).substr(1))},svgedit.utilities.getElem=svgedit.browser.supportsSelectors()?function(id){return svgroot_.querySelector("#"+id)}:svgedit.browser.supportsXpath()?function(id){return domdoc_.evaluate('svg:svg[@id="svgroot"]//svg:*[@id="'+id+'"]',domcontainer_,function(){return svgedit.NS.SVG},9,null).singleNodeValue}:function(id){return $(svgroot_).find("[id="+id+"]")[0]},svgedit.utilities.assignAttributes=function(node,attrs,suspendLength,unitCheck){suspendLength||(suspendLength=0);var handle=null;svgedit.browser.isOpera()||svgroot_.suspendRedraw(suspendLength);var i;for(i in attrs){var ns="xml:"===i.substr(0,4)?NS.XML:"xlink:"===i.substr(0,6)?NS.XLINK:null;ns?node.setAttributeNS(ns,i,attrs[i]):unitCheck?svgedit.units.setUnitAttr(node,i,attrs[i]):node.setAttribute(i,attrs[i])}svgedit.browser.isOpera()||svgroot_.unsuspendRedraw(handle)},svgedit.utilities.cleanupElement=function(element){var attr,handle=svgroot_.suspendRedraw(60),defaults={"fill-opacity":1,"stop-opacity":1,opacity:1,stroke:"none","stroke-dasharray":"none","stroke-linejoin":"miter","stroke-linecap":"butt","stroke-opacity":1,"stroke-width":1,rx:0,ry:0};for(attr in defaults){var val=defaults[attr];element.getAttribute(attr)==val&&element.removeAttribute(attr)}svgroot_.unsuspendRedraw(handle)},svgedit.utilities.snapToGrid=function(value){var stepSize=editorContext_.getSnappingStep(),unit=editorContext_.getBaseUnit();return"px"!==unit&&(stepSize*=svgedit.units.getTypeMap()[unit]),value=Math.round(value/stepSize)*stepSize},svgedit.utilities.preg_quote=function(str,delimiter){return String(str).replace(new RegExp("[.\\\\+*?\\[\\^\\]$(){}=!<>|:\\"+(delimiter||"")+"-]","g"),"\\$&")}}(),function(){"use strict";svgedit.sanitize||(svgedit.sanitize={});var NS=svgedit.NS,REVERSE_NS=svgedit.getReverseNS(),svgWhiteList_={a:["class","clip-path","clip-rule","fill","fill-opacity","fill-rule","filter","id","mask","opacity","stroke","stroke-dasharray","stroke-dashoffset","stroke-linecap","stroke-linejoin","stroke-miterlimit","stroke-opacity","stroke-width","style","systemLanguage","transform","xlink:href","xlink:title"],circle:["class","clip-path","clip-rule","cx","cy","fill","fill-opacity","fill-rule","filter","id","mask","opacity","r","requiredFeatures","stroke","stroke-dasharray","stroke-dashoffset","stroke-linecap","stroke-linejoin","stroke-miterlimit","stroke-opacity","stroke-width","style","systemLanguage","transform"],clipPath:["class","clipPathUnits","id"],defs:[],style:["type"],desc:[],ellipse:["class","clip-path","clip-rule","cx","cy","fill","fill-opacity","fill-rule","filter","id","mask","opacity","requiredFeatures","rx","ry","stroke","stroke-dasharray","stroke-dashoffset","stroke-linecap","stroke-linejoin","stroke-miterlimit","stroke-opacity","stroke-width","style","systemLanguage","transform"],feGaussianBlur:["class","color-interpolation-filters","id","requiredFeatures","stdDeviation"],filter:["class","color-interpolation-filters","filterRes","filterUnits","height","id","primitiveUnits","requiredFeatures","width","x","xlink:href","y"],foreignObject:["class","font-size","height","id","opacity","requiredFeatures","style","transform","width","x","y"],g:["class","clip-path","clip-rule","id","display","fill","fill-opacity","fill-rule","filter","mask","opacity","requiredFeatures","stroke","stroke-dasharray","stroke-dashoffset","stroke-linecap","stroke-linejoin","stroke-miterlimit","stroke-opacity","stroke-width","style","systemLanguage","transform","font-family","font-size","font-style","font-weight","text-anchor"],image:["class","clip-path","clip-rule","filter","height","id","mask","opacity","requiredFeatures","style","systemLanguage","transform","width","x","xlink:href","xlink:title","y"],line:["class","clip-path","clip-rule","fill","fill-opacity","fill-rule","filter","id","marker-end","marker-mid","marker-start","mask","opacity","requiredFeatures","stroke","stroke-dasharray","stroke-dashoffset","stroke-linecap","stroke-linejoin","stroke-miterlimit","stroke-opacity","stroke-width","style","systemLanguage","transform","x1","x2","y1","y2"],linearGradient:["class","id","gradientTransform","gradientUnits","requiredFeatures","spreadMethod","systemLanguage","x1","x2","xlink:href","y1","y2"],marker:["id","class","markerHeight","markerUnits","markerWidth","orient","preserveAspectRatio","refX","refY","systemLanguage","viewBox"],mask:["class","height","id","maskContentUnits","maskUnits","width","x","y"],metadata:["class","id"],path:["class","clip-path","clip-rule","d","fill","fill-opacity","fill-rule","filter","id","marker-end","marker-mid","marker-start","mask","opacity","requiredFeatures","stroke","stroke-dasharray","stroke-dashoffset","stroke-linecap","stroke-linejoin","stroke-miterlimit","stroke-opacity","stroke-width","style","systemLanguage","transform"],pattern:["class","height","id","patternContentUnits","patternTransform","patternUnits","requiredFeatures","style","systemLanguage","viewBox","width","x","xlink:href","y"],polygon:["class","clip-path","clip-rule","id","fill","fill-opacity","fill-rule","filter","id","class","marker-end","marker-mid","marker-start","mask","opacity","points","requiredFeatures","stroke","stroke-dasharray","stroke-dashoffset","stroke-linecap","stroke-linejoin","stroke-miterlimit","stroke-opacity","stroke-width","style","systemLanguage","transform"],polyline:["class","clip-path","clip-rule","id","fill","fill-opacity","fill-rule","filter","marker-end","marker-mid","marker-start","mask","opacity","points","requiredFeatures","stroke","stroke-dasharray","stroke-dashoffset","stroke-linecap","stroke-linejoin","stroke-miterlimit","stroke-opacity","stroke-width","style","systemLanguage","transform"],radialGradient:["class","cx","cy","fx","fy","gradientTransform","gradientUnits","id","r","requiredFeatures","spreadMethod","systemLanguage","xlink:href"],rect:["class","clip-path","clip-rule","fill","fill-opacity","fill-rule","filter","height","id","mask","opacity","requiredFeatures","rx","ry","stroke","stroke-dasharray","stroke-dashoffset","stroke-linecap","stroke-linejoin","stroke-miterlimit","stroke-opacity","stroke-width","style","systemLanguage","transform","width","x","y"],stop:["class","id","offset","requiredFeatures","stop-color","stop-opacity","style","systemLanguage"],svg:["class","clip-path","clip-rule","filter","id","height","mask","preserveAspectRatio","requiredFeatures","style","systemLanguage","viewBox","width","x","xmlns","xmlns:se","xmlns:xlink","y"],"switch":["class","id","requiredFeatures","systemLanguage"],symbol:["class","fill","fill-opacity","fill-rule","filter","font-family","font-size","font-style","font-weight","id","opacity","preserveAspectRatio","requiredFeatures","stroke","stroke-dasharray","stroke-dashoffset","stroke-linecap","stroke-linejoin","stroke-miterlimit","stroke-opacity","stroke-width","style","systemLanguage","transform","viewBox"],text:["class","clip-path","clip-rule","fill","fill-opacity","fill-rule","filter","font-family","font-size","font-style","font-weight","id","mask","opacity","requiredFeatures","stroke","stroke-dasharray","stroke-dashoffset","stroke-linecap","stroke-linejoin","stroke-miterlimit","stroke-opacity","stroke-width","style","systemLanguage","text-anchor","transform","x","xml:space","y"],textPath:["class","id","method","requiredFeatures","spacing","startOffset","style","systemLanguage","transform","xlink:href"],title:[],tspan:["class","clip-path","clip-rule","dx","dy","fill","fill-opacity","fill-rule","filter","font-family","font-size","font-style","font-weight","id","mask","opacity","requiredFeatures","rotate","stroke","stroke-dasharray","stroke-dashoffset","stroke-linecap","stroke-linejoin","stroke-miterlimit","stroke-opacity","stroke-width","style","systemLanguage","text-anchor","textLength","transform","x","xml:space","y"],use:["class","clip-path","clip-rule","fill","fill-opacity","fill-rule","filter","height","id","mask","stroke","stroke-dasharray","stroke-dashoffset","stroke-linecap","stroke-linejoin","stroke-miterlimit","stroke-opacity","stroke-width","style","transform","width","x","xlink:href","y"],annotation:["encoding"],"annotation-xml":["encoding"],maction:["actiontype","other","selection"],math:["class","id","display","xmlns"],menclose:["notation"],merror:[],mfrac:["linethickness"],mi:["mathvariant"],mmultiscripts:[],mn:[],mo:["fence","lspace","maxsize","minsize","rspace","stretchy"],mover:[],mpadded:["lspace","width","height","depth","voffset"],mphantom:[],mprescripts:[],mroot:[],mrow:["xlink:href","xlink:type","xmlns:xlink"],mspace:["depth","height","width"],msqrt:[],mstyle:["displaystyle","mathbackground","mathcolor","mathvariant","scriptlevel"],msub:[],msubsup:[],msup:[],mtable:["align","columnalign","columnlines","columnspacing","displaystyle","equalcolumns","equalrows","frame","rowalign","rowlines","rowspacing","width"],mtd:["columnalign","columnspan","rowalign","rowspan"],mtext:[],mtr:["columnalign","rowalign"],munder:[],munderover:[],none:[],semantics:[]},svgWhiteListNS_={};
$.each(svgWhiteList_,function(elt,atts){var attNS={};$.each(atts,function(i,att){if(att.indexOf(":")>=0){var v=att.split(":");attNS[v[1]]=NS[v[0].toUpperCase()]}else attNS[att]="xmlns"==att?NS.XMLNS:null}),svgWhiteListNS_[elt]=attNS}),svgedit.sanitize.sanitizeSvg=function(node){if(3==node.nodeType&&(node.nodeValue=node.nodeValue.replace(/^\s+|\s+$/g,""),0===node.nodeValue.length&&node.parentNode.removeChild(node)),1==node.nodeType){var doc=node.ownerDocument,parent=node.parentNode;if(doc&&parent){var i,allowedAttrs=svgWhiteList_[node.nodeName],allowedAttrsNS=svgWhiteListNS_[node.nodeName];if("undefined"!=typeof allowedAttrs){var seAttrs=[];for(i=node.attributes.length;i--;){var attr=node.attributes.item(i),attrName=attr.nodeName,attrLocalName=attr.localName,attrNsURI=attr.namespaceURI;if(allowedAttrsNS.hasOwnProperty(attrLocalName)&&attrNsURI==allowedAttrsNS[attrLocalName]&&attrNsURI!=NS.XMLNS||attrNsURI==NS.XMLNS&&REVERSE_NS[attr.value]||(0===attrName.indexOf("se:")&&seAttrs.push([attrName,attr.value]),node.removeAttributeNS(attrNsURI,attrLocalName)),svgedit.browser.isGecko())switch(attrName){case"transform":case"gradientTransform":case"patternTransform":var val=attr.value.replace(/(\d)-/g,"$1 -");node.setAttribute(attrName,val)}if("style"==attrName){for(var props=attr.value.split(";"),p=props.length;p--;){var nv=props[p].split(":"),styleAttrName=$.trim(nv[0]),styleAttrVal=$.trim(nv[1]);allowedAttrs.indexOf(styleAttrName)>=0&&node.setAttribute(styleAttrName,styleAttrVal)}node.removeAttribute("style")}}$.each(seAttrs,function(i,attr){node.setAttributeNS(NS.SE,attr[0],attr[1])});var href=svgedit.utilities.getHref(node);if(href&&["filter","linearGradient","pattern","radialGradient","textPath","use"].indexOf(node.nodeName)>=0&&"#"!=href[0]&&(svgedit.utilities.setHref(node,""),node.removeAttributeNS(NS.XLINK,"href")),"use"==node.nodeName&&!svgedit.utilities.getHref(node))return void parent.removeChild(node);for($.each(["clip-path","fill","filter","marker-end","marker-mid","marker-start","mask","stroke"],function(i,attr){var val=node.getAttribute(attr);val&&(val=svgedit.utilities.getUrlFromAttr(val),val&&"#"!==val[0]&&(node.setAttribute(attr,""),node.removeAttribute(attr)))}),i=node.childNodes.length;i--;)svgedit.sanitize.sanitizeSvg(node.childNodes.item(i))}else{for(var children=[];node.hasChildNodes();)children.push(parent.insertBefore(node.firstChild,node));for(parent.removeChild(node),i=children.length;i--;)svgedit.sanitize.sanitizeSvg(children[i])}}}}}(),function(){"use strict";svgedit.history||(svgedit.history={}),svgedit.history.HistoryEventTypes={BEFORE_APPLY:"before_apply",AFTER_APPLY:"after_apply",BEFORE_UNAPPLY:"before_unapply",AFTER_UNAPPLY:"after_unapply"};svgedit.history.MoveElementCommand=function(elem,oldNextSibling,oldParent,text){this.elem=elem,this.text=text?"Move "+elem.tagName+" to "+text:"Move "+elem.tagName,this.oldNextSibling=oldNextSibling,this.oldParent=oldParent,this.newNextSibling=elem.nextSibling,this.newParent=elem.parentNode},svgedit.history.MoveElementCommand.type=function(){return"svgedit.history.MoveElementCommand"},svgedit.history.MoveElementCommand.prototype.type=svgedit.history.MoveElementCommand.type,svgedit.history.MoveElementCommand.prototype.getText=function(){return this.text},svgedit.history.MoveElementCommand.prototype.apply=function(handler){handler&&handler.handleHistoryEvent(svgedit.history.HistoryEventTypes.BEFORE_APPLY,this),this.elem=this.newParent.insertBefore(this.elem,this.newNextSibling),handler&&handler.handleHistoryEvent(svgedit.history.HistoryEventTypes.AFTER_APPLY,this)},svgedit.history.MoveElementCommand.prototype.unapply=function(handler){handler&&handler.handleHistoryEvent(svgedit.history.HistoryEventTypes.BEFORE_UNAPPLY,this),this.elem=this.oldParent.insertBefore(this.elem,this.oldNextSibling),handler&&handler.handleHistoryEvent(svgedit.history.HistoryEventTypes.AFTER_UNAPPLY,this)},svgedit.history.MoveElementCommand.prototype.elements=function(){return[this.elem]},svgedit.history.InsertElementCommand=function(elem,text){this.elem=elem,this.text=text||"Create "+elem.tagName,this.parent=elem.parentNode,this.nextSibling=this.elem.nextSibling},svgedit.history.InsertElementCommand.type=function(){return"svgedit.history.InsertElementCommand"},svgedit.history.InsertElementCommand.prototype.type=svgedit.history.InsertElementCommand.type,svgedit.history.InsertElementCommand.prototype.getText=function(){return this.text},svgedit.history.InsertElementCommand.prototype.apply=function(handler){handler&&handler.handleHistoryEvent(svgedit.history.HistoryEventTypes.BEFORE_APPLY,this),this.elem=this.parent.insertBefore(this.elem,this.nextSibling),handler&&handler.handleHistoryEvent(svgedit.history.HistoryEventTypes.AFTER_APPLY,this)},svgedit.history.InsertElementCommand.prototype.unapply=function(handler){handler&&handler.handleHistoryEvent(svgedit.history.HistoryEventTypes.BEFORE_UNAPPLY,this),this.parent=this.elem.parentNode,this.elem=this.elem.parentNode.removeChild(this.elem),handler&&handler.handleHistoryEvent(svgedit.history.HistoryEventTypes.AFTER_UNAPPLY,this)},svgedit.history.InsertElementCommand.prototype.elements=function(){return[this.elem]},svgedit.history.RemoveElementCommand=function(elem,oldNextSibling,oldParent,text){this.elem=elem,this.text=text||"Delete "+elem.tagName,this.nextSibling=oldNextSibling,this.parent=oldParent,svgedit.transformlist.removeElementFromListMap(elem)},svgedit.history.RemoveElementCommand.type=function(){return"svgedit.history.RemoveElementCommand"},svgedit.history.RemoveElementCommand.prototype.type=svgedit.history.RemoveElementCommand.type,svgedit.history.RemoveElementCommand.prototype.getText=function(){return this.text},svgedit.history.RemoveElementCommand.prototype.apply=function(handler){handler&&handler.handleHistoryEvent(svgedit.history.HistoryEventTypes.BEFORE_APPLY,this),svgedit.transformlist.removeElementFromListMap(this.elem),this.parent=this.elem.parentNode,this.elem=this.parent.removeChild(this.elem),handler&&handler.handleHistoryEvent(svgedit.history.HistoryEventTypes.AFTER_APPLY,this)},svgedit.history.RemoveElementCommand.prototype.unapply=function(handler){handler&&handler.handleHistoryEvent(svgedit.history.HistoryEventTypes.BEFORE_UNAPPLY,this),svgedit.transformlist.removeElementFromListMap(this.elem),null==this.nextSibling&&window.console&&console.log("Error: reference element was lost"),this.parent.insertBefore(this.elem,this.nextSibling),handler&&handler.handleHistoryEvent(svgedit.history.HistoryEventTypes.AFTER_UNAPPLY,this)},svgedit.history.RemoveElementCommand.prototype.elements=function(){return[this.elem]},svgedit.history.ChangeElementCommand=function(elem,attrs,text){this.elem=elem,this.text=text?"Change "+elem.tagName+" "+text:"Change "+elem.tagName,this.newValues={},this.oldValues=attrs;var attr;for(attr in attrs)this.newValues[attr]="#text"==attr?elem.textContent:"#href"==attr?svgedit.utilities.getHref(elem):elem.getAttribute(attr)},svgedit.history.ChangeElementCommand.type=function(){return"svgedit.history.ChangeElementCommand"},svgedit.history.ChangeElementCommand.prototype.type=svgedit.history.ChangeElementCommand.type,svgedit.history.ChangeElementCommand.prototype.getText=function(){return this.text},svgedit.history.ChangeElementCommand.prototype.apply=function(handler){handler&&handler.handleHistoryEvent(svgedit.history.HistoryEventTypes.BEFORE_APPLY,this);var attr,bChangedTransform=!1;for(attr in this.newValues)this.newValues[attr]?"#text"==attr?this.elem.textContent=this.newValues[attr]:"#href"==attr?svgedit.utilities.setHref(this.elem,this.newValues[attr]):this.elem.setAttribute(attr,this.newValues[attr]):"#text"==attr?this.elem.textContent="":(this.elem.setAttribute(attr,""),this.elem.removeAttribute(attr)),"transform"==attr&&(bChangedTransform=!0);if(!bChangedTransform){var angle=svgedit.utilities.getRotationAngle(this.elem);if(angle){var bbox=elem.getBBox(),cx=bbox.x+bbox.width/2,cy=bbox.y+bbox.height/2,rotate=["rotate(",angle," ",cx,",",cy,")"].join("");rotate!=elem.getAttribute("transform")&&elem.setAttribute("transform",rotate)}}return handler&&handler.handleHistoryEvent(svgedit.history.HistoryEventTypes.AFTER_APPLY,this),!0},svgedit.history.ChangeElementCommand.prototype.unapply=function(handler){handler&&handler.handleHistoryEvent(svgedit.history.HistoryEventTypes.BEFORE_UNAPPLY,this);var attr,bChangedTransform=!1;for(attr in this.oldValues)this.oldValues[attr]?"#text"==attr?this.elem.textContent=this.oldValues[attr]:"#href"==attr?svgedit.utilities.setHref(this.elem,this.oldValues[attr]):this.elem.setAttribute(attr,this.oldValues[attr]):"#text"==attr?this.elem.textContent="":this.elem.removeAttribute(attr),"transform"==attr&&(bChangedTransform=!0);if(!bChangedTransform){var angle=svgedit.utilities.getRotationAngle(this.elem);if(angle){var bbox=elem.getBBox(),cx=bbox.x+bbox.width/2,cy=bbox.y+bbox.height/2,rotate=["rotate(",angle," ",cx,",",cy,")"].join("");rotate!=elem.getAttribute("transform")&&elem.setAttribute("transform",rotate)}}return svgedit.transformlist.removeElementFromListMap(this.elem),handler&&handler.handleHistoryEvent(svgedit.history.HistoryEventTypes.AFTER_UNAPPLY,this),!0},svgedit.history.ChangeElementCommand.prototype.elements=function(){return[this.elem]},svgedit.history.BatchCommand=function(text){this.text=text||"Batch Command",this.stack=[]},svgedit.history.BatchCommand.type=function(){return"svgedit.history.BatchCommand"},svgedit.history.BatchCommand.prototype.type=svgedit.history.BatchCommand.type,svgedit.history.BatchCommand.prototype.getText=function(){return this.text},svgedit.history.BatchCommand.prototype.apply=function(handler){handler&&handler.handleHistoryEvent(svgedit.history.HistoryEventTypes.BEFORE_APPLY,this);var i,len=this.stack.length;for(i=0;len>i;++i)this.stack[i].apply(handler);handler&&handler.handleHistoryEvent(svgedit.history.HistoryEventTypes.AFTER_APPLY,this)},svgedit.history.BatchCommand.prototype.unapply=function(handler){handler&&handler.handleHistoryEvent(svgedit.history.HistoryEventTypes.BEFORE_UNAPPLY,this);var i;for(i=this.stack.length-1;i>=0;i--)this.stack[i].unapply(handler);handler&&handler.handleHistoryEvent(svgedit.history.HistoryEventTypes.AFTER_UNAPPLY,this)},svgedit.history.BatchCommand.prototype.elements=function(){for(var elems=[],cmd=this.stack.length;cmd--;)for(var thisElems=this.stack[cmd].elements(),elem=thisElems.length;elem--;)-1==elems.indexOf(thisElems[elem])&&elems.push(thisElems[elem]);return elems},svgedit.history.BatchCommand.prototype.addSubCommand=function(cmd){this.stack.push(cmd)},svgedit.history.BatchCommand.prototype.isEmpty=function(){return 0===this.stack.length},svgedit.history.UndoManager=function(historyEventHandler){this.handler_=historyEventHandler||null,this.undoStackPointer=0,this.undoStack=[],this.undoChangeStackPointer=-1,this.undoableChangeStack=[]},svgedit.history.UndoManager.prototype.resetUndoStack=function(){this.undoStack=[],this.undoStackPointer=0},svgedit.history.UndoManager.prototype.getUndoStackSize=function(){return this.undoStackPointer},svgedit.history.UndoManager.prototype.getRedoStackSize=function(){return this.undoStack.length-this.undoStackPointer},svgedit.history.UndoManager.prototype.getNextUndoCommandText=function(){return this.undoStackPointer>0?this.undoStack[this.undoStackPointer-1].getText():""},svgedit.history.UndoManager.prototype.getNextRedoCommandText=function(){return this.undoStackPointer<this.undoStack.length?this.undoStack[this.undoStackPointer].getText():""},svgedit.history.UndoManager.prototype.undo=function(){if(this.undoStackPointer>0){var cmd=this.undoStack[--this.undoStackPointer];cmd.unapply(this.handler_)}},svgedit.history.UndoManager.prototype.redo=function(){if(this.undoStackPointer<this.undoStack.length&&this.undoStack.length>0){var cmd=this.undoStack[this.undoStackPointer++];cmd.apply(this.handler_)}},svgedit.history.UndoManager.prototype.addCommandToHistory=function(cmd){this.undoStackPointer<this.undoStack.length&&this.undoStack.length>0&&(this.undoStack=this.undoStack.splice(0,this.undoStackPointer)),this.undoStack.push(cmd),this.undoStackPointer=this.undoStack.length},svgedit.history.UndoManager.prototype.beginUndoableChange=function(attrName,elems){for(var p=++this.undoChangeStackPointer,i=elems.length,oldValues=new Array(i),elements=new Array(i);i--;){var elem=elems[i];null!=elem&&(elements[i]=elem,oldValues[i]=elem.getAttribute(attrName))}this.undoableChangeStack[p]={attrName:attrName,oldValues:oldValues,elements:elements}},svgedit.history.UndoManager.prototype.finishUndoableChange=function(){for(var p=this.undoChangeStackPointer--,changeset=this.undoableChangeStack[p],i=changeset.elements.length,attrName=changeset.attrName,batchCmd=new svgedit.history.BatchCommand("Change "+attrName);i--;){var elem=changeset.elements[i];if(null!=elem){var changes={};changes[attrName]=changeset.oldValues[i],changes[attrName]!=elem.getAttribute(attrName)&&batchCmd.addSubCommand(new svgedit.history.ChangeElementCommand(elem,changes,attrName))}}return this.undoableChangeStack[p]=null,batchCmd}}();var svgedit=svgedit||{};!function(){"use strict";svgedit.coords||(svgedit.coords={});var pathMap=[0,"z","M","m","L","l","C","c","Q","q","A","a","H","h","V","v","S","s","T","t"],editorContext_=null;svgedit.coords.init=function(editorContext){editorContext_=editorContext},svgedit.coords.remapElement=function(selected,changes,m){var i,type,remap=function(x,y){return svgedit.math.transformPoint(x,y,m)},scalew=function(w){return m.a*w},scaleh=function(h){return m.d*h},doSnapping=editorContext_.getGridSnapping()&&"svg"===selected.parentNode.parentNode.localName,finishUp=function(){var o;if(doSnapping)for(o in changes)changes[o]=svgedit.utilities.snapToGrid(changes[o]);svgedit.utilities.assignAttributes(selected,changes,1e3,!0)},box=svgedit.utilities.getBBox(selected);for(i=0;2>i;i++){type=0===i?"fill":"stroke";var attrVal=selected.getAttribute(type);if(attrVal&&0===attrVal.indexOf("url(")&&(m.a<0||m.d<0)){var grad=svgedit.utilities.getRefElem(attrVal),newgrad=grad.cloneNode(!0);if(m.a<0){var x1=newgrad.getAttribute("x1"),x2=newgrad.getAttribute("x2");newgrad.setAttribute("x1",-(x1-1)),newgrad.setAttribute("x2",-(x2-1))}if(m.d<0){var y1=newgrad.getAttribute("y1"),y2=newgrad.getAttribute("y2");newgrad.setAttribute("y1",-(y1-1)),newgrad.setAttribute("y2",-(y2-1))}newgrad.id=editorContext_.getDrawing().getNextId(),svgedit.utilities.findDefs().appendChild(newgrad),selected.setAttribute(type,"url(#"+newgrad.id+")")}}var chlist,mt,elName=selected.tagName;if("g"===elName||"text"===elName||"tspan"==elName||"use"===elName)if(1!=m.a||0!=m.b||0!=m.c||1!=m.d||0==m.e&&0==m.f)chlist=svgedit.transformlist.getTransformList(selected),mt=svgroot.createSVGTransform(),mt.setMatrix(svgedit.math.matrixMultiply(svgedit.math.transformListToTransform(chlist).matrix,m)),chlist.clear(),chlist.appendItem(mt);else{var existing=svgedit.math.transformListToTransform(selected).matrix,t_new=svgedit.math.matrixMultiply(existing.inverse(),m,existing);changes.x=parseFloat(changes.x)+t_new.e,changes.y=parseFloat(changes.y)+t_new.f}var c,pt,pt1,pt2,len;switch(elName){case"foreignObject":case"rect":case"image":"image"===elName&&(m.a<0||m.d<0)?(chlist=svgedit.transformlist.getTransformList(selected),mt=svgroot.createSVGTransform(),mt.setMatrix(svgedit.math.matrixMultiply(svgedit.math.transformListToTransform(chlist).matrix,m)),chlist.clear(),chlist.appendItem(mt)):(pt1=remap(changes.x,changes.y),changes.width=scalew(changes.width),changes.height=scaleh(changes.height),changes.x=pt1.x+Math.min(0,changes.width),changes.y=pt1.y+Math.min(0,changes.height),changes.width=Math.abs(changes.width),changes.height=Math.abs(changes.height)),finishUp();break;case"ellipse":c=remap(changes.cx,changes.cy),changes.cx=c.x,changes.cy=c.y,changes.rx=scalew(changes.rx),changes.ry=scaleh(changes.ry),changes.rx=Math.abs(changes.rx),changes.ry=Math.abs(changes.ry),finishUp();break;case"circle":c=remap(changes.cx,changes.cy),changes.cx=c.x,changes.cy=c.y;var tbox=svgedit.math.transformBox(box.x,box.y,box.width,box.height,m),w=tbox.tr.x-tbox.tl.x,h=tbox.bl.y-tbox.tl.y;changes.r=Math.min(w/2,h/2),changes.r&&(changes.r=Math.abs(changes.r)),finishUp();break;case"line":pt1=remap(changes.x1,changes.y1),pt2=remap(changes.x2,changes.y2),changes.x1=pt1.x,changes.y1=pt1.y,changes.x2=pt2.x,changes.y2=pt2.y;case"text":case"tspan":case"use":finishUp();break;case"g":var gsvg=$(selected).data("gsvg");gsvg&&svgedit.utilities.assignAttributes(gsvg,changes,1e3,!0);break;case"polyline":case"polygon":for(len=changes.points.length,i=0;len>i;++i)pt=changes.points[i],pt=remap(pt.x,pt.y),changes.points[i].x=pt.x,changes.points[i].y=pt.y;len=changes.points.length;var pstr="";for(i=0;len>i;++i)pt=changes.points[i],pstr+=pt.x+","+pt.y+" ";selected.setAttribute("points",pstr);break;case"path":var seg,segList=selected.pathSegList;for(len=segList.numberOfItems,changes.d=[],i=0;len>i;++i)seg=segList.getItem(i),changes.d[i]={type:seg.pathSegType,x:seg.x,y:seg.y,x1:seg.x1,y1:seg.y1,x2:seg.x2,y2:seg.y2,r1:seg.r1,r2:seg.r2,angle:seg.angle,largeArcFlag:seg.largeArcFlag,sweepFlag:seg.sweepFlag};len=changes.d.length;var firstseg=changes.d[0],currentpt=remap(firstseg.x,firstseg.y);for(changes.d[0].x=currentpt.x,changes.d[0].y=currentpt.y,i=1;len>i;++i)if(seg=changes.d[i],type=seg.type,type%2==0){var thisx=void 0!=seg.x?seg.x:currentpt.x,thisy=void 0!=seg.y?seg.y:currentpt.y;pt=remap(thisx,thisy),pt1=remap(seg.x1,seg.y1),pt2=remap(seg.x2,seg.y2),seg.x=pt.x,seg.y=pt.y,seg.x1=pt1.x,seg.y1=pt1.y,seg.x2=pt2.x,seg.y2=pt2.y,seg.r1=scalew(seg.r1),seg.r2=scaleh(seg.r2)}else seg.x=scalew(seg.x),seg.y=scaleh(seg.y),seg.x1=scalew(seg.x1),seg.y1=scaleh(seg.y1),seg.x2=scalew(seg.x2),seg.y2=scaleh(seg.y2),seg.r1=scalew(seg.r1),seg.r2=scaleh(seg.r2);var dstr="";for(len=changes.d.length,i=0;len>i;++i)switch(seg=changes.d[i],type=seg.type,dstr+=pathMap[type],type){case 13:case 12:dstr+=seg.x+" ";break;case 15:case 14:dstr+=seg.y+" ";break;case 3:case 5:case 19:case 2:case 4:case 18:dstr+=seg.x+","+seg.y+" ";break;case 7:case 6:dstr+=seg.x1+","+seg.y1+" "+seg.x2+","+seg.y2+" "+seg.x+","+seg.y+" ";break;case 9:case 8:dstr+=seg.x1+","+seg.y1+" "+seg.x+","+seg.y+" ";break;case 11:case 10:dstr+=seg.r1+","+seg.r2+" "+seg.angle+" "+ +seg.largeArcFlag+" "+ +seg.sweepFlag+" "+seg.x+","+seg.y+" ";break;case 17:case 16:dstr+=seg.x2+","+seg.y2+" "+seg.x+","+seg.y+" "}selected.setAttribute("d",dstr)}}}();var svgedit=svgedit||{};!function(){svgedit.recalculate||(svgedit.recalculate={});var context_,NS=svgedit.NS;svgedit.recalculate.init=function(editorContext){context_=editorContext},svgedit.recalculate.updateClipPath=function(attr,tx,ty){var path=getRefElem(attr).firstChild,cp_xform=svgedit.transformlist.getTransformList(path),newxlate=context_.getSVGRoot().createSVGTransform();newxlate.setTranslate(tx,ty),cp_xform.appendItem(newxlate),svgedit.recalculate.recalculateDimensions(path)},svgedit.recalculate.recalculateDimensions=function(selected){if(null==selected)return null;if("svg"==selected.nodeName&&navigator.userAgent.indexOf("Firefox/20")>=0)return null;var k,svgroot=context_.getSVGRoot(),tlist=svgedit.transformlist.getTransformList(selected);if(tlist&&tlist.numberOfItems>0){for(k=tlist.numberOfItems;k--;){var xform=tlist.getItem(k);0===xform.type?tlist.removeItem(k):1===xform.type?svgedit.math.isIdentity(xform.matrix)&&tlist.removeItem(k):4===xform.type&&0===xform.angle&&tlist.removeItem(k)}if(1===tlist.numberOfItems&&svgedit.utilities.getRotationAngle(selected))return null}if(!tlist||0==tlist.numberOfItems)return selected.setAttribute("transform",""),selected.removeAttribute("transform"),null;if(tlist){k=tlist.numberOfItems;for(var mxs=[];k--;){var xform=tlist.getItem(k);1===xform.type?mxs.push([xform.matrix,k]):mxs.length&&(mxs=[])}if(2===mxs.length){var m_new=svgroot.createSVGTransformFromMatrix(svgedit.math.matrixMultiply(mxs[1][0],mxs[0][0]));tlist.removeItem(mxs[0][1]),tlist.removeItem(mxs[1][1]),tlist.insertItemBefore(m_new,mxs[1][1])}if(k=tlist.numberOfItems,k>=2&&1===tlist.getItem(k-2).type&&2===tlist.getItem(k-1).type){var mt=svgroot.createSVGTransform(),m=svgedit.math.matrixMultiply(tlist.getItem(k-2).matrix,tlist.getItem(k-1).matrix);mt.setMatrix(m),tlist.removeItem(k-2),tlist.removeItem(k-2),tlist.appendItem(mt)}}switch(selected.tagName){case"line":case"polyline":case"polygon":case"path":break;default:if(1===tlist.numberOfItems&&1===tlist.getItem(0).type||2===tlist.numberOfItems&&1===tlist.getItem(0).type&&4===tlist.getItem(0).type)return null}var gsvg=$(selected).data("gsvg"),batchCmd=new svgedit.history.BatchCommand("Transform"),changes={},initial=null,attrs=[];switch(selected.tagName){case"line":attrs=["x1","y1","x2","y2"];break;case"circle":attrs=["cx","cy","r"];break;case"ellipse":attrs=["cx","cy","rx","ry"];break;case"foreignObject":case"rect":case"image":attrs=["width","height","x","y"];break;case"use":case"text":case"tspan":attrs=["x","y"];break;case"polygon":case"polyline":initial={},initial.points=selected.getAttribute("points");var list=selected.points,len=list.numberOfItems;changes.points=new Array(len);var i;for(i=0;len>i;++i){var pt=list.getItem(i);changes.points[i]={x:pt.x,y:pt.y}}break;case"path":initial={},initial.d=selected.getAttribute("d"),changes.d=selected.getAttribute("d")}if(attrs.length?(changes=$(selected).attr(attrs),$.each(changes,function(attr,val){changes[attr]=svgedit.units.convertToNum(attr,val)})):gsvg&&(changes={x:$(gsvg).attr("x")||0,y:$(gsvg).attr("y")||0}),null==initial&&(initial=$.extend(!0,{},changes),$.each(initial,function(attr,val){initial[attr]=svgedit.units.convertToNum(attr,val)})),initial.transform=context_.getStartTransform()||"","g"==selected.tagName&&!gsvg||"a"==selected.tagName){var box=svgedit.utilities.getBBox(selected),oldcenter={x:box.x+box.width/2,y:box.y+box.height/2},newcenter=svgedit.math.transformPoint(box.x+box.width/2,box.y+box.height/2,svgedit.math.transformListToTransform(tlist).matrix),m=svgroot.createSVGMatrix(),gangle=svgedit.utilities.getRotationAngle(selected);if(gangle){var a=gangle*Math.PI/180;if(Math.abs(a)>1e-10)var s=Math.sin(a)/(1-Math.cos(a));else var s=2/a;var i;for(i=0;i<tlist.numberOfItems;++i){var xform=tlist.getItem(i);if(4==xform.type){var rm=xform.matrix;oldcenter.y=(s*rm.e+rm.f)/2,oldcenter.x=(rm.e-s*rm.f)/2,tlist.removeItem(i);break}}}var tx=0,ty=0,operation=0,N=tlist.numberOfItems;if(N)var first_m=tlist.getItem(0).matrix;if(N>=3&&3==tlist.getItem(N-2).type&&2==tlist.getItem(N-3).type&&2==tlist.getItem(N-1).type){operation=3;for(var tm=tlist.getItem(N-3).matrix,sm=tlist.getItem(N-2).matrix,tmn=tlist.getItem(N-1).matrix,children=selected.childNodes,c=children.length;c--;){var child=children.item(c);if(tx=0,ty=0,1==child.nodeType){var childTlist=svgedit.transformlist.getTransformList(child);if(!childTlist)continue;var m=svgedit.math.transformListToTransform(childTlist).matrix,angle=svgedit.utilities.getRotationAngle(child),oldStartTransform=context_.getStartTransform(),childxforms=[];if(context_.setStartTransform(child.getAttribute("transform")),angle||svgedit.math.hasMatrixTransform(childTlist)){var e2t=svgroot.createSVGTransform();e2t.setMatrix(svgedit.math.matrixMultiply(tm,sm,tmn,m)),childTlist.clear(),childTlist.appendItem(e2t),childxforms.push(e2t)}else{var t2n=svgedit.math.matrixMultiply(m.inverse(),tmn,m),t2=svgroot.createSVGMatrix();t2.e=-t2n.e,t2.f=-t2n.f;var s2=svgedit.math.matrixMultiply(t2.inverse(),m.inverse(),tm,sm,tmn,m,t2n.inverse()),translateOrigin=svgroot.createSVGTransform(),scale=svgroot.createSVGTransform(),translateBack=svgroot.createSVGTransform();translateOrigin.setTranslate(t2n.e,t2n.f),scale.setScale(s2.a,s2.d),translateBack.setTranslate(t2.e,t2.f),childTlist.appendItem(translateBack),childTlist.appendItem(scale),childTlist.appendItem(translateOrigin),childxforms.push(translateBack),childxforms.push(scale),childxforms.push(translateOrigin)}batchCmd.addSubCommand(svgedit.recalculate.recalculateDimensions(child)),context_.setStartTransform(oldStartTransform)}}tlist.removeItem(N-1),tlist.removeItem(N-2),tlist.removeItem(N-3)}else if(N>=3&&1==tlist.getItem(N-1).type){operation=3,m=svgedit.math.transformListToTransform(tlist).matrix;var e2t=svgroot.createSVGTransform();e2t.setMatrix(m),tlist.clear(),tlist.appendItem(e2t)}else if((1==N||N>1&&3!=tlist.getItem(1).type)&&2==tlist.getItem(0).type){operation=2;var T_M=svgedit.math.transformListToTransform(tlist).matrix;tlist.removeItem(0);var M_inv=svgedit.math.transformListToTransform(tlist).matrix.inverse(),M2=svgedit.math.matrixMultiply(M_inv,T_M);if(tx=M2.e,ty=M2.f,0!=tx||0!=ty){for(var children=selected.childNodes,c=children.length,clipPaths_done=[];c--;){var child=children.item(c);if(1==child.nodeType){if(child.getAttribute("clip-path")){var attr=child.getAttribute("clip-path");-1===clipPaths_done.indexOf(attr)&&(svgedit.recalculate.updateClipPath(attr,tx,ty),clipPaths_done.push(attr))}var oldStartTransform=context_.getStartTransform();context_.setStartTransform(child.getAttribute("transform"));var childTlist=svgedit.transformlist.getTransformList(child);if(childTlist){var newxlate=svgroot.createSVGTransform();newxlate.setTranslate(tx,ty),childTlist.numberOfItems?childTlist.insertItemBefore(newxlate,0):childTlist.appendItem(newxlate),batchCmd.addSubCommand(svgedit.recalculate.recalculateDimensions(child));for(var uses=selected.getElementsByTagNameNS(NS.SVG,"use"),href="#"+child.id,u=uses.length;u--;){var useElem=uses.item(u);if(href==svgedit.utilities.getHref(useElem)){var usexlate=svgroot.createSVGTransform();usexlate.setTranslate(-tx,-ty),svgedit.transformlist.getTransformList(useElem).insertItemBefore(usexlate,0),batchCmd.addSubCommand(svgedit.recalculate.recalculateDimensions(useElem))}}context_.setStartTransform(oldStartTransform)}}}clipPaths_done=[],context_.setStartTransform(oldStartTransform)}}else{if(1!=N||1!=tlist.getItem(0).type||gangle){if(gangle){var newRot=svgroot.createSVGTransform();newRot.setRotate(gangle,newcenter.x,newcenter.y),tlist.numberOfItems?tlist.insertItemBefore(newRot,0):tlist.appendItem(newRot)}return 0==tlist.numberOfItems&&selected.removeAttribute("transform"),null}operation=1;for(var m=tlist.getItem(0).matrix,children=selected.childNodes,c=children.length;c--;){var child=children.item(c);if(1==child.nodeType){var oldStartTransform=context_.getStartTransform();context_.setStartTransform(child.getAttribute("transform"));var childTlist=svgedit.transformlist.getTransformList(child);if(!childTlist)continue;var em=svgedit.math.matrixMultiply(m,svgedit.math.transformListToTransform(childTlist).matrix),e2m=svgroot.createSVGTransform();e2m.setMatrix(em),childTlist.clear(),childTlist.appendItem(e2m,0),batchCmd.addSubCommand(svgedit.recalculate.recalculateDimensions(child)),context_.setStartTransform(oldStartTransform);var sw=child.getAttribute("stroke-width");if("none"!==child.getAttribute("stroke")&&!isNaN(sw)){var avg=(Math.abs(em.a)+Math.abs(em.d))/2;child.setAttribute("stroke-width",sw*avg)}}}tlist.clear()}if(2==operation){if(gangle){newcenter={x:oldcenter.x+first_m.e,y:oldcenter.y+first_m.f};var newRot=svgroot.createSVGTransform();newRot.setRotate(gangle,newcenter.x,newcenter.y),tlist.numberOfItems?tlist.insertItemBefore(newRot,0):tlist.appendItem(newRot)}}else if(3==operation){var m=svgedit.math.transformListToTransform(tlist).matrix,roldt=svgroot.createSVGTransform();roldt.setRotate(gangle,oldcenter.x,oldcenter.y);var rold=roldt.matrix,rnew=svgroot.createSVGTransform();rnew.setRotate(gangle,newcenter.x,newcenter.y);var rnew_inv=rnew.matrix.inverse(),m_inv=m.inverse(),extrat=svgedit.math.matrixMultiply(m_inv,rnew_inv,rold,m);if(tx=extrat.e,ty=extrat.f,0!=tx||0!=ty)for(var children=selected.childNodes,c=children.length;c--;){var child=children.item(c);if(1==child.nodeType){var oldStartTransform=context_.getStartTransform();context_.setStartTransform(child.getAttribute("transform"));var childTlist=svgedit.transformlist.getTransformList(child),newxlate=svgroot.createSVGTransform();newxlate.setTranslate(tx,ty),childTlist.numberOfItems?childTlist.insertItemBefore(newxlate,0):childTlist.appendItem(newxlate),batchCmd.addSubCommand(svgedit.recalculate.recalculateDimensions(child)),context_.setStartTransform(oldStartTransform)}}gangle&&(tlist.numberOfItems?tlist.insertItemBefore(rnew,0):tlist.appendItem(rnew))}}else{var box=svgedit.utilities.getBBox(selected);if(!box&&"path"!=selected.tagName)return null;var m=svgroot.createSVGMatrix(),angle=svgedit.utilities.getRotationAngle(selected);if(angle){var oldcenter={x:box.x+box.width/2,y:box.y+box.height/2},newcenter=svgedit.math.transformPoint(box.x+box.width/2,box.y+box.height/2,svgedit.math.transformListToTransform(tlist).matrix),a=angle*Math.PI/180;if(Math.abs(a)>1e-10)var s=Math.sin(a)/(1-Math.cos(a));else var s=2/a;for(var i=0;i<tlist.numberOfItems;++i){var xform=tlist.getItem(i);if(4==xform.type){var rm=xform.matrix;oldcenter.y=(s*rm.e+rm.f)/2,oldcenter.x=(rm.e-s*rm.f)/2,tlist.removeItem(i);break}}}var operation=0,N=tlist.numberOfItems;if(!svgedit.browser.isWebkit()){var fill=selected.getAttribute("fill");if(fill&&0===fill.indexOf("url(")){var paint=getRefElem(fill),type="pattern";paint.tagName!==type&&(type="gradient");var attrVal=paint.getAttribute(type+"Units");if("userSpaceOnUse"===attrVal){m=svgedit.math.transformListToTransform(tlist).matrix;var gtlist=svgedit.transformlist.getTransformList(paint),gmatrix=svgedit.math.transformListToTransform(gtlist).matrix;m=svgedit.math.matrixMultiply(m,gmatrix);var m_str="matrix("+[m.a,m.b,m.c,m.d,m.e,m.f].join(",")+")";paint.setAttribute(type+"Transform",m_str)}}}if(N>=3&&3==tlist.getItem(N-2).type&&2==tlist.getItem(N-3).type&&2==tlist.getItem(N-1).type)operation=3,m=svgedit.math.transformListToTransform(tlist,N-3,N-1).matrix,tlist.removeItem(N-1),tlist.removeItem(N-2),tlist.removeItem(N-3);else if(4==N&&1==tlist.getItem(N-1).type){operation=3,m=svgedit.math.transformListToTransform(tlist).matrix;var e2t=svgroot.createSVGTransform();e2t.setMatrix(m),tlist.clear(),tlist.appendItem(e2t),m=svgroot.createSVGMatrix()}else if((1==N||N>1&&3!=tlist.getItem(1).type)&&2==tlist.getItem(0).type){operation=2;var oldxlate=tlist.getItem(0).matrix,meq=svgedit.math.transformListToTransform(tlist,1).matrix,meq_inv=meq.inverse();m=svgedit.math.matrixMultiply(meq_inv,oldxlate,meq),tlist.removeItem(0)}else{if(1!=N||1!=tlist.getItem(0).type||angle){if(operation=4,angle){var newRot=svgroot.createSVGTransform();newRot.setRotate(angle,newcenter.x,newcenter.y),tlist.numberOfItems?tlist.insertItemBefore(newRot,0):tlist.appendItem(newRot)}return 0==tlist.numberOfItems&&selected.removeAttribute("transform"),null}switch(m=svgedit.math.transformListToTransform(tlist).matrix,selected.tagName){case"line":changes=$(selected).attr(["x1","y1","x2","y2"]);case"polyline":case"polygon":if(changes.points=selected.getAttribute("points"),changes.points){var list=selected.points,len=list.numberOfItems;changes.points=new Array(len);for(var i=0;len>i;++i){var pt=list.getItem(i);changes.points[i]={x:pt.x,y:pt.y}}}case"path":changes.d=selected.getAttribute("d"),operation=1,tlist.clear()}}if((1==operation||2==operation||3==operation)&&svgedit.coords.remapElement(selected,changes,m),2==operation){if(angle){svgedit.math.hasMatrixTransform(tlist)||(newcenter={x:oldcenter.x+m.e,y:oldcenter.y+m.f});var newRot=svgroot.createSVGTransform();newRot.setRotate(angle,newcenter.x,newcenter.y),tlist.numberOfItems?tlist.insertItemBefore(newRot,0):tlist.appendItem(newRot)}if("text"==selected.tagName)for(var children=selected.childNodes,c=children.length;c--;){var child=children.item(c);if("tspan"==child.tagName){var tspanChanges={x:$(child).attr("x")||0,y:$(child).attr("y")||0};svgedit.coords.remapElement(child,tspanChanges,m)}}}else if(3==operation&&angle){var m=svgedit.math.transformListToTransform(tlist).matrix,roldt=svgroot.createSVGTransform();roldt.setRotate(angle,oldcenter.x,oldcenter.y);var rold=roldt.matrix,rnew=svgroot.createSVGTransform();rnew.setRotate(angle,newcenter.x,newcenter.y);
var rnew_inv=rnew.matrix.inverse(),m_inv=m.inverse(),extrat=svgedit.math.matrixMultiply(m_inv,rnew_inv,rold,m);svgedit.coords.remapElement(selected,changes,extrat),angle&&(tlist.numberOfItems?tlist.insertItemBefore(rnew,0):tlist.appendItem(rnew))}}return 0==tlist.numberOfItems&&selected.removeAttribute("transform"),batchCmd.addSubCommand(new svgedit.history.ChangeElementCommand(selected,initial)),batchCmd}}(),function(){"use strict";svgedit.select||(svgedit.select={});var svgFactory_,config_,selectorManager_,gripRadius=svgedit.browser.isTouch()?10:4;svgedit.select.Selector=function(id,elem){this.id=id,this.selectedElement=elem,this.locked=!0,this.selectorGroup=svgFactory_.createSVGElement({element:"g",attr:{id:"selectorGroup"+this.id}}),this.selectorRect=this.selectorGroup.appendChild(svgFactory_.createSVGElement({element:"path",attr:{id:"selectedBox"+this.id,fill:"none",stroke:"#22C","stroke-width":"1","stroke-dasharray":"5,5",style:"pointer-events:none"}})),this.gripCoords={nw:null,n:null,ne:null,e:null,se:null,s:null,sw:null,w:null},this.reset(this.selectedElement)},svgedit.select.Selector.prototype.reset=function(e){this.locked=!0,this.selectedElement=e,this.resize(),this.selectorGroup.setAttribute("display","inline")},svgedit.select.Selector.prototype.updateGripCursors=function(angle){var dir,dir_arr=[],steps=Math.round(angle/45);0>steps&&(steps+=8);for(dir in selectorManager_.selectorGrips)dir_arr.push(dir);for(;steps>0;)dir_arr.push(dir_arr.shift()),steps--;var i=0;for(dir in selectorManager_.selectorGrips)selectorManager_.selectorGrips[dir].setAttribute("style","cursor:"+dir_arr[i]+"-resize"),i++},svgedit.select.Selector.prototype.showGrips=function(show){var bShow=show?"inline":"none";selectorManager_.selectorGripsGroup.setAttribute("display",bShow);var elem=this.selectedElement;this.hasGrips=show,elem&&show&&(this.selectorGroup.appendChild(selectorManager_.selectorGripsGroup),this.updateGripCursors(svgedit.utilities.getRotationAngle(elem)))},svgedit.select.Selector.prototype.resize=function(){var selectedBox=this.selectorRect,mgr=selectorManager_,selectedGrips=mgr.selectorGrips,selected=this.selectedElement,sw=selected.getAttribute("stroke-width"),current_zoom=svgFactory_.currentZoom(),offset=1/current_zoom;"none"===selected.getAttribute("stroke")||isNaN(sw)||(offset+=sw/2);var tagName=selected.tagName;"text"===tagName&&(offset+=2/current_zoom);var tlist=svgedit.transformlist.getTransformList(selected),m=svgedit.math.transformListToTransform(tlist).matrix;m.e*=current_zoom,m.f*=current_zoom;var bbox=svgedit.utilities.getBBox(selected);if("g"===tagName&&!$.data(selected,"gsvg")){var stroked_bbox=svgFactory_.getStrokedBBox(selected.childNodes);stroked_bbox&&(bbox=stroked_bbox)}var l=bbox.x,t=bbox.y,w=bbox.width,h=bbox.height;bbox={x:l,y:t,width:w,height:h},offset*=current_zoom;var nbox=svgedit.math.transformBox(l*current_zoom,t*current_zoom,w*current_zoom,h*current_zoom,m),aabox=nbox.aabox,nbax=aabox.x-offset,nbay=aabox.y-offset,nbaw=aabox.width+2*offset,nbah=aabox.height+2*offset,cx=nbax+nbaw/2,cy=nbay+nbah/2,angle=svgedit.utilities.getRotationAngle(selected);if(angle){var rot=svgFactory_.svgRoot().createSVGTransform();rot.setRotate(-angle,cx,cy);var rotm=rot.matrix;nbox.tl=svgedit.math.transformPoint(nbox.tl.x,nbox.tl.y,rotm),nbox.tr=svgedit.math.transformPoint(nbox.tr.x,nbox.tr.y,rotm),nbox.bl=svgedit.math.transformPoint(nbox.bl.x,nbox.bl.y,rotm),nbox.br=svgedit.math.transformPoint(nbox.br.x,nbox.br.y,rotm);var tl=nbox.tl,minx=tl.x,miny=tl.y,maxx=tl.x,maxy=tl.y,min=Math.min,max=Math.max;minx=min(minx,min(nbox.tr.x,min(nbox.bl.x,nbox.br.x)))-offset,miny=min(miny,min(nbox.tr.y,min(nbox.bl.y,nbox.br.y)))-offset,maxx=max(maxx,max(nbox.tr.x,max(nbox.bl.x,nbox.br.x)))+offset,maxy=max(maxy,max(nbox.tr.y,max(nbox.bl.y,nbox.br.y)))+offset,nbax=minx,nbay=miny,nbaw=maxx-minx,nbah=maxy-miny}var sr_handle=svgFactory_.svgRoot().suspendRedraw(100),dstr="M"+nbax+","+nbay+" L"+(nbax+nbaw)+","+nbay+" "+(nbax+nbaw)+","+(nbay+nbah)+" "+nbax+","+(nbay+nbah)+"z";selectedBox.setAttribute("d",dstr);var xform=angle?"rotate("+[angle,cx,cy].join(",")+")":"";this.selectorGroup.setAttribute("transform",xform),this.gripCoords={nw:[nbax,nbay],ne:[nbax+nbaw,nbay],sw:[nbax,nbay+nbah],se:[nbax+nbaw,nbay+nbah],n:[nbax+nbaw/2,nbay],w:[nbax,nbay+nbah/2],e:[nbax+nbaw,nbay+nbah/2],s:[nbax+nbaw/2,nbay+nbah]};var dir;for(dir in this.gripCoords){var coords=this.gripCoords[dir];selectedGrips[dir].setAttribute("cx",coords[0]),selectedGrips[dir].setAttribute("cy",coords[1])}mgr.rotateGripConnector.setAttribute("x1",nbax+nbaw/2),mgr.rotateGripConnector.setAttribute("y1",nbay),mgr.rotateGripConnector.setAttribute("x2",nbax+nbaw/2),mgr.rotateGripConnector.setAttribute("y2",nbay-5*gripRadius),mgr.rotateGrip.setAttribute("cx",nbax+nbaw/2),mgr.rotateGrip.setAttribute("cy",nbay-5*gripRadius),svgFactory_.svgRoot().unsuspendRedraw(sr_handle)},svgedit.select.SelectorManager=function(){this.selectorParentGroup=null,this.rubberBandBox=null,this.selectors=[],this.selectorMap={},this.selectorGrips={nw:null,n:null,ne:null,e:null,se:null,s:null,sw:null,w:null},this.selectorGripsGroup=null,this.rotateGripConnector=null,this.rotateGrip=null,this.initGroup()},svgedit.select.SelectorManager.prototype.initGroup=function(){this.selectorParentGroup&&this.selectorParentGroup.parentNode&&this.selectorParentGroup.parentNode.removeChild(this.selectorParentGroup),this.selectorParentGroup=svgFactory_.createSVGElement({element:"g",attr:{id:"selectorParentGroup"}}),this.selectorGripsGroup=svgFactory_.createSVGElement({element:"g",attr:{display:"none"}}),this.selectorParentGroup.appendChild(this.selectorGripsGroup),svgFactory_.svgRoot().appendChild(this.selectorParentGroup),this.selectorMap={},this.selectors=[],this.rubberBandBox=null;var dir;for(dir in this.selectorGrips){var grip=svgFactory_.createSVGElement({element:"circle",attr:{id:"selectorGrip_resize_"+dir,fill:"#22C",r:gripRadius,style:"cursor:"+dir+"-resize","stroke-width":2,"pointer-events":"all"}});$.data(grip,"dir",dir),$.data(grip,"type","resize"),this.selectorGrips[dir]=this.selectorGripsGroup.appendChild(grip)}if(this.rotateGripConnector=this.selectorGripsGroup.appendChild(svgFactory_.createSVGElement({element:"line",attr:{id:"selectorGrip_rotateconnector",stroke:"#22C","stroke-width":"1"}})),this.rotateGrip=this.selectorGripsGroup.appendChild(svgFactory_.createSVGElement({element:"circle",attr:{id:"selectorGrip_rotate",fill:"lime",r:gripRadius,stroke:"#22C","stroke-width":2,style:"cursor:url("+config_.imgPath+"rotate.png) 12 12, auto;"}})),$.data(this.rotateGrip,"type","rotate"),!$("#canvasBackground").length){var dims=config_.dimensions,canvasbg=svgFactory_.createSVGElement({element:"svg",attr:{id:"canvasBackground",width:dims[0],height:dims[1],x:0,y:0,overflow:svgedit.browser.isWebkit()?"none":"visible",style:"pointer-events:none"}}),rect=svgFactory_.createSVGElement({element:"rect",attr:{width:"100%",height:"100%",x:0,y:0,"stroke-width":1,stroke:"#000",fill:"#FFF",style:"pointer-events:none"}});canvasbg.appendChild(rect),svgFactory_.svgRoot().insertBefore(canvasbg,svgFactory_.svgContent())}},svgedit.select.SelectorManager.prototype.requestSelector=function(elem){if(null==elem)return null;var i,N=this.selectors.length;if("object"==typeof this.selectorMap[elem.id])return this.selectorMap[elem.id].locked=!0,this.selectorMap[elem.id];for(i=0;N>i;++i)if(this.selectors[i]&&!this.selectors[i].locked)return this.selectors[i].locked=!0,this.selectors[i].reset(elem),this.selectorMap[elem.id]=this.selectors[i],this.selectors[i];return this.selectors[N]=new svgedit.select.Selector(N,elem),this.selectorParentGroup.appendChild(this.selectors[N].selectorGroup),this.selectorMap[elem.id]=this.selectors[N],this.selectors[N]},svgedit.select.SelectorManager.prototype.releaseSelector=function(elem){if(null!=elem){var i,N=this.selectors.length,sel=this.selectorMap[elem.id];for(i=0;N>i;++i)if(this.selectors[i]&&this.selectors[i]==sel){0==sel.locked&&console.log("WARNING! selector was released but was already unlocked"),delete this.selectorMap[elem.id],sel.locked=!1,sel.selectedElement=null,sel.showGrips(!1);try{sel.selectorGroup.setAttribute("display","none")}catch(e){}break}}},svgedit.select.SelectorManager.prototype.getRubberBandBox=function(){return this.rubberBandBox||(this.rubberBandBox=this.selectorParentGroup.appendChild(svgFactory_.createSVGElement({element:"rect",attr:{id:"selectorRubberBand",fill:"#22C","fill-opacity":.15,stroke:"#22C","stroke-width":.5,display:"none",style:"pointer-events:none"}}))),this.rubberBandBox},svgedit.select.init=function(config,svgFactory){config_=config,svgFactory_=svgFactory,selectorManager_=new svgedit.select.SelectorManager},svgedit.select.getSelectorManager=function(){return selectorManager_}}(),function(){"use strict";svgedit.draw||(svgedit.draw={});var NS=svgedit.NS,visElems="a,circle,ellipse,foreignObject,g,image,line,path,polygon,polyline,rect,svg,text,tspan,use".split(","),RandomizeModes={LET_DOCUMENT_DECIDE:0,ALWAYS_RANDOMIZE:1,NEVER_RANDOMIZE:2},randomize_ids=RandomizeModes.LET_DOCUMENT_DECIDE;svgedit.draw.Layer=function(name,group){this.name_=name,this.group_=group},svgedit.draw.Layer.prototype.getName=function(){return this.name_},svgedit.draw.Layer.prototype.getGroup=function(){return this.group_},svgedit.draw.randomizeIds=function(enableRandomization,currentDrawing){randomize_ids=enableRandomization===!1?RandomizeModes.NEVER_RANDOMIZE:RandomizeModes.ALWAYS_RANDOMIZE,randomize_ids!=RandomizeModes.ALWAYS_RANDOMIZE||currentDrawing.getNonce()?randomize_ids==RandomizeModes.NEVER_RANDOMIZE&&currentDrawing.getNonce()&&currentDrawing.clearNonce():currentDrawing.setNonce(Math.floor(100001*Math.random()))},svgedit.draw.Drawing=function(svgElem,opt_idPrefix){if(!svgElem||!svgElem.tagName||!svgElem.namespaceURI||"svg"!=svgElem.tagName||svgElem.namespaceURI!=NS.SVG)throw"Error: svgedit.draw.Drawing instance initialized without a <svg> element";this.svgElem_=svgElem,this.obj_num=0,this.idPrefix=opt_idPrefix||"svg_",this.releasedNums=[],this.all_layers=[],this.current_layer=null,this.nonce_="";var n=this.svgElem_.getAttributeNS(NS.SE,"nonce");n&&randomize_ids!=RandomizeModes.NEVER_RANDOMIZE?this.nonce_=n:randomize_ids==RandomizeModes.ALWAYS_RANDOMIZE&&this.setNonce(Math.floor(100001*Math.random()))},svgedit.draw.Drawing.prototype.getElem_=function(id){return this.svgElem_.querySelector?this.svgElem_.querySelector("#"+id):$(this.svgElem_).find("[id="+id+"]")[0]},svgedit.draw.Drawing.prototype.getSvgElem=function(){return this.svgElem_},svgedit.draw.Drawing.prototype.getNonce=function(){return this.nonce_},svgedit.draw.Drawing.prototype.setNonce=function(n){this.svgElem_.setAttributeNS(NS.XMLNS,"xmlns:se",NS.SE),this.svgElem_.setAttributeNS(NS.SE,"se:nonce",n),this.nonce_=n},svgedit.draw.Drawing.prototype.clearNonce=function(){this.nonce_=""},svgedit.draw.Drawing.prototype.getId=function(){return this.nonce_?this.idPrefix+this.nonce_+"_"+this.obj_num:this.idPrefix+this.obj_num},svgedit.draw.Drawing.prototype.getNextId=function(){var oldObjNum=this.obj_num,restoreOldObjNum=!1;this.releasedNums.length>0?(this.obj_num=this.releasedNums.pop(),restoreOldObjNum=!0):this.obj_num++;for(var id=this.getId();this.getElem_(id);)restoreOldObjNum&&(this.obj_num=oldObjNum,restoreOldObjNum=!1),this.obj_num++,id=this.getId();return restoreOldObjNum&&(this.obj_num=oldObjNum),id},svgedit.draw.Drawing.prototype.releaseId=function(id){var front=this.idPrefix+(this.nonce_?this.nonce_+"_":"");if("string"!=typeof id||0!==id.indexOf(front))return!1;var num=parseInt(id.substr(front.length),10);return"number"!=typeof num||0>=num||-1!=this.releasedNums.indexOf(num)?!1:(this.releasedNums.push(num),!0)},svgedit.draw.Drawing.prototype.getNumLayers=function(){return this.all_layers.length},svgedit.draw.Drawing.prototype.hasLayer=function(name){var i;for(i=0;i<this.getNumLayers();i++)if(this.all_layers[i][0]==name)return!0;return!1},svgedit.draw.Drawing.prototype.getLayerName=function(i){return i>=0&&i<this.getNumLayers()?this.all_layers[i][0]:""},svgedit.draw.Drawing.prototype.getCurrentLayer=function(){return this.current_layer},svgedit.draw.Drawing.prototype.getCurrentLayerName=function(){var i;for(i=0;i<this.getNumLayers();++i)if(this.all_layers[i][1]==this.current_layer)return this.getLayerName(i);return""},svgedit.draw.Drawing.prototype.setCurrentLayer=function(name){var i;for(i=0;i<this.getNumLayers();++i)if(name==this.getLayerName(i))return this.current_layer!=this.all_layers[i][1]&&(this.current_layer.setAttribute("style","pointer-events:none"),this.current_layer=this.all_layers[i][1],this.current_layer.setAttribute("style","pointer-events:all")),!0;return!1},svgedit.draw.Drawing.prototype.deleteCurrentLayer=function(){if(this.current_layer&&this.getNumLayers()>1){var parent=this.current_layer.parentNode,oldLayerGroup=(this.current_layer.nextSibling,parent.removeChild(this.current_layer));return this.identifyLayers(),oldLayerGroup}return null},svgedit.draw.Drawing.prototype.identifyLayers=function(){this.all_layers=[];var i,numchildren=this.svgElem_.childNodes.length,orphans=[],layernames=[],a_layer=null,childgroups=!1;for(i=0;numchildren>i;++i){var child=this.svgElem_.childNodes.item(i);if(child&&1==child.nodeType)if("g"==child.tagName){childgroups=!0;var name=$("title",child).text();!name&&svgedit.browser.isOpera()&&child.querySelectorAll&&(name=$(child.querySelectorAll("title")).text()),name?(layernames.push(name),this.all_layers.push([name,child]),a_layer=child,svgedit.utilities.walkTree(child,function(e){e.setAttribute("style","pointer-events:inherit")}),a_layer.setAttribute("style","pointer-events:none")):orphans.push(child)}else if(~visElems.indexOf(child.nodeName)){{svgedit.utilities.getBBox(child)}orphans.push(child)}}var svgdoc=this.svgElem_.ownerDocument;if(orphans.length>0||!childgroups){for(i=1;layernames.indexOf("Layer "+i)>=0;)i++;var newname="Layer "+i;a_layer=svgdoc.createElementNS(NS.SVG,"g");var layer_title=svgdoc.createElementNS(NS.SVG,"title");layer_title.textContent=newname,a_layer.appendChild(layer_title);var j;for(j=0;j<orphans.length;++j)a_layer.appendChild(orphans[j]);this.svgElem_.appendChild(a_layer),this.all_layers.push([newname,a_layer])}svgedit.utilities.walkTree(a_layer,function(e){e.setAttribute("style","pointer-events:inherit")}),this.current_layer=a_layer,this.current_layer.setAttribute("style","pointer-events:all")},svgedit.draw.Drawing.prototype.createLayer=function(name){var svgdoc=this.svgElem_.ownerDocument,new_layer=svgdoc.createElementNS(NS.SVG,"g"),layer_title=svgdoc.createElementNS(NS.SVG,"title");return layer_title.textContent=name,new_layer.appendChild(layer_title),this.svgElem_.appendChild(new_layer),this.identifyLayers(),new_layer},svgedit.draw.Drawing.prototype.getLayerVisibility=function(layername){var i,layer=null;for(i=0;i<this.getNumLayers();++i)if(this.getLayerName(i)==layername){layer=this.all_layers[i][1];break}return layer?"none"!==layer.getAttribute("display"):!1},svgedit.draw.Drawing.prototype.setLayerVisibility=function(layername,bVisible){if("boolean"!=typeof bVisible)return null;var i,layer=null;for(i=0;i<this.getNumLayers();++i)if(this.getLayerName(i)==layername){layer=this.all_layers[i][1];break}if(!layer)return null;var oldDisplay=layer.getAttribute("display");return oldDisplay||(oldDisplay="inline"),layer.setAttribute("display",bVisible?"inline":"none"),layer},svgedit.draw.Drawing.prototype.getLayerOpacity=function(layername){var i;for(i=0;i<this.getNumLayers();++i)if(this.getLayerName(i)==layername){var g=this.all_layers[i][1],opacity=g.getAttribute("opacity");return opacity||(opacity="1.0"),parseFloat(opacity)}return null},svgedit.draw.Drawing.prototype.setLayerOpacity=function(layername,opacity){if(!("number"!=typeof opacity||0>opacity||opacity>1)){var i;for(i=0;i<this.getNumLayers();++i)if(this.getLayerName(i)==layername){var g=this.all_layers[i][1];g.setAttribute("opacity",opacity);break}}}}(),function(){"use strict";svgedit.path||(svgedit.path={});var NS=svgedit.NS,uiStrings={pathNodeTooltip:"Drag node to move it. Double-click node to change segment type",pathCtrlPtTooltip:"Drag control point to adjust curve properties"},segData={2:["x","y"],4:["x","y"],6:["x","y","x1","y1","x2","y2"],8:["x","y","x1","y1"],10:["x","y","r1","r2","angle","largeArcFlag","sweepFlag"],12:["x"],14:["y"],16:["x","y","x2","y2"],18:["x","y"]},pathFuncs=[],link_control_pts=!0,pathData={};svgedit.path.setLinkControlPoints=function(lcp){link_control_pts=lcp},svgedit.path.path=null;var editorContext_=null;svgedit.path.init=function(editorContext){editorContext_=editorContext,pathFuncs=[0,"ClosePath"];var pathFuncsStrs=["Moveto","Lineto","CurvetoCubic","CurvetoQuadratic","Arc","LinetoHorizontal","LinetoVertical","CurvetoCubicSmooth","CurvetoQuadraticSmooth"];$.each(pathFuncsStrs,function(i,s){pathFuncs.push(s+"Abs"),pathFuncs.push(s+"Rel")})},svgedit.path.insertItemBefore=function(elem,newseg,index){var list=elem.pathSegList;if(svgedit.browser.supportsPathInsertItemBefore())return void list.insertItemBefore(newseg,index);var i,len=list.numberOfItems,arr=[];for(i=0;len>i;i++){var cur_seg=list.getItem(i);arr.push(cur_seg)}for(list.clear(),i=0;len>i;i++)i==index&&list.appendItem(newseg),list.appendItem(arr[i])},svgedit.path.ptObjToArr=function(type,seg_item){var i,arr=segData[type],len=arr.length,out=[];for(i=0;len>i;i++)out[i]=seg_item[arr[i]];return out},svgedit.path.getGripPt=function(seg,alt_pt){var out={x:alt_pt?alt_pt.x:seg.item.x,y:alt_pt?alt_pt.y:seg.item.y},path=seg.path;if(path.matrix){var pt=svgedit.math.transformPoint(out.x,out.y,path.matrix);out=pt}return out.x*=editorContext_.getCurrentZoom(),out.y*=editorContext_.getCurrentZoom(),out},svgedit.path.getPointFromGrip=function(pt,path){var out={x:pt.x,y:pt.y};return path.matrix&&(pt=svgedit.math.transformPoint(out.x,out.y,path.imatrix),out.x=pt.x,out.y=pt.y),out.x/=editorContext_.getCurrentZoom(),out.y/=editorContext_.getCurrentZoom(),out},svgedit.path.addPointGrip=function(index,x,y){var pointGripContainer=svgedit.path.getGripContainer(),pointGrip=svgedit.utilities.getElem("pathpointgrip_"+index);if(!pointGrip){pointGrip=document.createElementNS(NS.SVG,"circle"),svgedit.utilities.assignAttributes(pointGrip,{id:"pathpointgrip_"+index,display:"none",r:4,fill:"#0FF",stroke:"#00F","stroke-width":2,cursor:"move",style:"pointer-events:all","xlink:title":uiStrings.pathNodeTooltip}),pointGrip=pointGripContainer.appendChild(pointGrip);var grip=$("#pathpointgrip_"+index);grip.dblclick(function(){svgedit.path.path&&svgedit.path.path.setSegType()})}return x&&y&&svgedit.utilities.assignAttributes(pointGrip,{cx:x,cy:y,display:"inline"}),pointGrip},svgedit.path.getGripContainer=function(){var c=svgedit.utilities.getElem("pathpointgrip_container");if(!c){var parent=svgedit.utilities.getElem("selectorParentGroup");c=parent.appendChild(document.createElementNS(NS.SVG,"g")),c.id="pathpointgrip_container"}return c},svgedit.path.addCtrlGrip=function(id){var pointGrip=svgedit.utilities.getElem("ctrlpointgrip_"+id);return pointGrip?pointGrip:(pointGrip=document.createElementNS(NS.SVG,"circle"),svgedit.utilities.assignAttributes(pointGrip,{id:"ctrlpointgrip_"+id,display:"none",r:4,fill:"#0FF",stroke:"#55F","stroke-width":1,cursor:"move",style:"pointer-events:all","xlink:title":uiStrings.pathCtrlPtTooltip}),svgedit.path.getGripContainer().appendChild(pointGrip),pointGrip)},svgedit.path.getCtrlLine=function(id){var ctrlLine=svgedit.utilities.getElem("ctrlLine_"+id);return ctrlLine?ctrlLine:(ctrlLine=document.createElementNS(NS.SVG,"line"),svgedit.utilities.assignAttributes(ctrlLine,{id:"ctrlLine_"+id,stroke:"#555","stroke-width":1,style:"pointer-events:none"}),svgedit.path.getGripContainer().appendChild(ctrlLine),ctrlLine)},svgedit.path.getPointGrip=function(seg,update){var index=seg.index,pointGrip=svgedit.path.addPointGrip(index);if(update){var pt=svgedit.path.getGripPt(seg);svgedit.utilities.assignAttributes(pointGrip,{cx:pt.x,cy:pt.y,display:"inline"})}return pointGrip},svgedit.path.getControlPoints=function(seg){var item=seg.item,index=seg.index;if(!("x1"in item&&"x2"in item))return null;var i,cpt={},prev=(svgedit.path.getGripContainer(),svgedit.path.path.segs[index-1].item),seg_items=[prev,item];for(i=1;3>i;i++){var id=index+"c"+i,ctrlLine=cpt["c"+i+"_line"]=svgedit.path.getCtrlLine(id),pt=svgedit.path.getGripPt(seg,{x:item["x"+i],y:item["y"+i]}),gpt=svgedit.path.getGripPt(seg,{x:seg_items[i-1].x,y:seg_items[i-1].y});svgedit.utilities.assignAttributes(ctrlLine,{x1:pt.x,y1:pt.y,x2:gpt.x,y2:gpt.y,display:"inline"}),cpt["c"+i+"_line"]=ctrlLine;var pointGrip=cpt["c"+i]=svgedit.path.addCtrlGrip(id);svgedit.utilities.assignAttributes(pointGrip,{cx:pt.x,cy:pt.y,display:"inline"}),cpt["c"+i]=pointGrip}return cpt},svgedit.path.replacePathSeg=function(type,index,pts,elem){var path=elem||svgedit.path.path.elem,func="createSVGPathSeg"+pathFuncs[type],seg=path[func].apply(path,pts);if(svgedit.browser.supportsPathReplaceItem())path.pathSegList.replaceItem(seg,index);else{var i,segList=path.pathSegList,len=segList.numberOfItems,arr=[];for(i=0;len>i;i++){var cur_seg=segList.getItem(i);arr.push(cur_seg)}for(segList.clear(),i=0;len>i;i++)segList.appendItem(i==index?seg:arr[i])}},svgedit.path.getSegSelector=function(seg,update){var index=seg.index,segLine=svgedit.utilities.getElem("segline_"+index);if(!segLine){var pointGripContainer=svgedit.path.getGripContainer();segLine=document.createElementNS(NS.SVG,"path"),svgedit.utilities.assignAttributes(segLine,{id:"segline_"+index,display:"none",fill:"none",stroke:"#0FF","stroke-width":2,style:"pointer-events:none",d:"M0,0 0,0"}),pointGripContainer.appendChild(segLine)}if(update){var prev=seg.prev;if(!prev)return segLine.setAttribute("display","none"),segLine;var pt=svgedit.path.getGripPt(prev);svgedit.path.replacePathSeg(2,0,[pt.x,pt.y],segLine);var i,pts=svgedit.path.ptObjToArr(seg.type,seg.item,!0);for(i=0;i<pts.length;i+=2)pt=svgedit.path.getGripPt(seg,{x:pts[i],y:pts[i+1]}),pts[i]=pt.x,pts[i+1]=pt.y;svgedit.path.replacePathSeg(seg.type,1,pts,segLine)}return segLine},svgedit.path.smoothControlPoints=function(ct1,ct2,pt){var x1=ct1.x-pt.x,y1=ct1.y-pt.y,x2=ct2.x-pt.x,y2=ct2.y-pt.y;if(!(0==x1&&0==y1||0==x2&&0==y2)){var anglea=Math.atan2(y1,x1),angleb=Math.atan2(y2,x2),r1=Math.sqrt(x1*x1+y1*y1),r2=Math.sqrt(x2*x2+y2*y2),nct1=editorContext_.getSVGRoot().createSVGPoint(),nct2=editorContext_.getSVGRoot().createSVGPoint();0>anglea&&(anglea+=2*Math.PI),0>angleb&&(angleb+=2*Math.PI);var new_anglea,new_angleb,angleBetween=Math.abs(anglea-angleb),angleDiff=Math.abs(Math.PI-angleBetween)/2;return anglea-angleb>0?(new_anglea=angleBetween<Math.PI?anglea+angleDiff:anglea-angleDiff,new_angleb=angleBetween<Math.PI?angleb-angleDiff:angleb+angleDiff):(new_anglea=angleBetween<Math.PI?anglea-angleDiff:anglea+angleDiff,new_angleb=angleBetween<Math.PI?angleb+angleDiff:angleb-angleDiff),nct1.x=r1*Math.cos(new_anglea)+pt.x,nct1.y=r1*Math.sin(new_anglea)+pt.y,nct2.x=r2*Math.cos(new_angleb)+pt.x,nct2.y=r2*Math.sin(new_angleb)+pt.y,[nct1,nct2]}return void 0},svgedit.path.Segment=function(index,item){this.selected=!1,this.index=index,this.item=item,this.type=item.pathSegType,this.ctrlpts=[],this.ptgrip=null,this.segsel=null},svgedit.path.Segment.prototype.showCtrlPts=function(y){var i;for(i in this.ctrlpts)this.ctrlpts.hasOwnProperty(i)&&this.ctrlpts[i].setAttribute("display",y?"inline":"none")},svgedit.path.Segment.prototype.selectCtrls=function(y){$("#ctrlpointgrip_"+this.index+"c1, #ctrlpointgrip_"+this.index+"c2").attr("fill",y?"#0FF":"#EEE")},svgedit.path.Segment.prototype.show=function(y){this.ptgrip&&(this.ptgrip.setAttribute("display",y?"inline":"none"),this.segsel.setAttribute("display",y?"inline":"none"),this.showCtrlPts(y))},svgedit.path.Segment.prototype.select=function(y){this.ptgrip&&(this.ptgrip.setAttribute("stroke",y?"#0FF":"#00F"),this.segsel.setAttribute("display",y?"inline":"none"),this.ctrlpts&&this.selectCtrls(y),this.selected=y)},svgedit.path.Segment.prototype.addGrip=function(){this.ptgrip=svgedit.path.getPointGrip(this,!0),this.ctrlpts=svgedit.path.getControlPoints(this,!0),this.segsel=svgedit.path.getSegSelector(this,!0)},svgedit.path.Segment.prototype.update=function(full){if(this.ptgrip){var pt=svgedit.path.getGripPt(this);svgedit.utilities.assignAttributes(this.ptgrip,{cx:pt.x,cy:pt.y}),svgedit.path.getSegSelector(this,!0),this.ctrlpts&&(full&&(this.item=svgedit.path.path.elem.pathSegList.getItem(this.index),this.type=this.item.pathSegType),svgedit.path.getControlPoints(this))}},svgedit.path.Segment.prototype.move=function(dx,dy){var cur_pts,item=this.item;if(cur_pts=this.ctrlpts?[item.x+=dx,item.y+=dy,item.x1,item.y1,item.x2+=dx,item.y2+=dy]:[item.x+=dx,item.y+=dy],svgedit.path.replacePathSeg(this.type,this.index,cur_pts),this.next&&this.next.ctrlpts){var next=this.next.item,next_pts=[next.x,next.y,next.x1+=dx,next.y1+=dy,next.x2,next.y2];svgedit.path.replacePathSeg(this.next.type,this.next.index,next_pts)}if(this.mate){item=this.mate.item;var pts=[item.x+=dx,item.y+=dy];svgedit.path.replacePathSeg(this.mate.type,this.mate.index,pts)}this.update(!0),this.next&&this.next.update(!0)},svgedit.path.Segment.prototype.setLinked=function(num){var seg,anum,pt;if(2==num){if(anum=1,seg=this.next,!seg)return;pt=this.item}else{if(anum=2,seg=this.prev,!seg)return;pt=seg.item}var item=seg.item;item["x"+anum]=pt.x+(pt.x-this.item["x"+num]),item["y"+anum]=pt.y+(pt.y-this.item["y"+num]);var pts=[item.x,item.y,item.x1,item.y1,item.x2,item.y2];svgedit.path.replacePathSeg(seg.type,seg.index,pts),seg.update(!0)},svgedit.path.Segment.prototype.moveCtrl=function(num,dx,dy){var item=this.item;item["x"+num]+=dx,item["y"+num]+=dy;var pts=[item.x,item.y,item.x1,item.y1,item.x2,item.y2];svgedit.path.replacePathSeg(this.type,this.index,pts),this.update(!0)},svgedit.path.Segment.prototype.setType=function(new_type,pts){svgedit.path.replacePathSeg(new_type,this.index,pts),this.type=new_type,this.item=svgedit.path.path.elem.pathSegList.getItem(this.index),this.showCtrlPts(6===new_type),this.ctrlpts=svgedit.path.getControlPoints(this),this.update(!0)},svgedit.path.Path=function(elem){if(!elem||"path"!==elem.tagName)throw"svgedit.path.Path constructed without a <path> element";this.elem=elem,this.segs=[],this.selected_pts=[],svgedit.path.path=this,this.init()},svgedit.path.Path.prototype.init=function(){$(svgedit.path.getGripContainer()).find("*").attr("display","none");var segList=this.elem.pathSegList,len=segList.numberOfItems;this.segs=[],this.selected_pts=[],this.first_seg=null;var i;for(i=0;len>i;i++){var item=segList.getItem(i),segment=new svgedit.path.Segment(i,item);segment.path=this,this.segs.push(segment)}var segs=this.segs,start_i=null;for(i=0;len>i;i++){var start_seg,seg=segs[i],next_seg=i+1>=len?null:segs[i+1],prev_seg=0>i-1?null:segs[i-1];2===seg.type?(prev_seg&&1!==prev_seg.type&&(start_seg=segs[start_i],start_seg.next=segs[start_i+1],start_seg.next.prev=start_seg,start_seg.addGrip()),start_i=i):next_seg&&1===next_seg.type?(seg.next=segs[start_i+1],seg.next.prev=seg,seg.mate=segs[start_i],seg.addGrip(),null==this.first_seg&&(this.first_seg=seg)):next_seg?1!==seg.type&&(seg.addGrip(),next_seg&&2!==next_seg.type&&(seg.next=next_seg,seg.next.prev=seg)):1!==seg.type&&(start_seg=segs[start_i],start_seg.next=segs[start_i+1],start_seg.next.prev=start_seg,start_seg.addGrip(),seg.addGrip(),this.first_seg||(this.first_seg=segs[start_i]))}return this},svgedit.path.Path.prototype.eachSeg=function(fn){var i,len=this.segs.length;for(i=0;len>i;i++){var ret=fn.call(this.segs[i],i);if(ret===!1)break}},svgedit.path.Path.prototype.addSeg=function(index){var seg=this.segs[index];if(seg.prev){var newseg,new_x,new_y,prev=seg.prev;switch(seg.item.pathSegType){case 4:new_x=(seg.item.x+prev.item.x)/2,new_y=(seg.item.y+prev.item.y)/2,newseg=this.elem.createSVGPathSegLinetoAbs(new_x,new_y);break;case 6:var p0_x=(prev.item.x+seg.item.x1)/2,p1_x=(seg.item.x1+seg.item.x2)/2,p2_x=(seg.item.x2+seg.item.x)/2,p01_x=(p0_x+p1_x)/2,p12_x=(p1_x+p2_x)/2;new_x=(p01_x+p12_x)/2;var p0_y=(prev.item.y+seg.item.y1)/2,p1_y=(seg.item.y1+seg.item.y2)/2,p2_y=(seg.item.y2+seg.item.y)/2,p01_y=(p0_y+p1_y)/2,p12_y=(p1_y+p2_y)/2;new_y=(p01_y+p12_y)/2,newseg=this.elem.createSVGPathSegCurvetoCubicAbs(new_x,new_y,p0_x,p0_y,p01_x,p01_y);var pts=[seg.item.x,seg.item.y,p12_x,p12_y,p2_x,p2_y];svgedit.path.replacePathSeg(seg.type,index,pts)}svgedit.path.insertItemBefore(this.elem,newseg,index)}},svgedit.path.Path.prototype.deleteSeg=function(index){var seg=this.segs[index],list=this.elem.pathSegList;seg.show(!1);var pt,next=seg.next;if(seg.mate)pt=[next.item.x,next.item.y],svgedit.path.replacePathSeg(2,next.index,pt),svgedit.path.replacePathSeg(4,seg.index,pt),list.removeItem(seg.mate.index);else if(seg.prev)list.removeItem(index);else{{seg.item}pt=[next.item.x,next.item.y],svgedit.path.replacePathSeg(2,seg.next.index,pt),list.removeItem(index)}},svgedit.path.Path.prototype.subpathIsClosed=function(index){var closed=!1;return svgedit.path.path.eachSeg(function(i){return index>=i?!0:2===this.type?!1:1===this.type?(closed=!0,!1):void 0}),closed},svgedit.path.Path.prototype.removePtFromSelection=function(index){var pos=this.selected_pts.indexOf(index);-1!=pos&&(this.segs[index].select(!1),this.selected_pts.splice(pos,1))},svgedit.path.Path.prototype.clearSelection=function(){this.eachSeg(function(){this.select(!1)}),this.selected_pts=[]},svgedit.path.Path.prototype.storeD=function(){this.last_d=this.elem.getAttribute("d")},svgedit.path.Path.prototype.show=function(y){return this.eachSeg(function(){this.show(y)}),y&&this.selectPt(this.first_seg.index),this},svgedit.path.Path.prototype.movePts=function(d_x,d_y){for(var i=this.selected_pts.length;i--;){var seg=this.segs[this.selected_pts[i]];seg.move(d_x,d_y)}},svgedit.path.Path.prototype.moveCtrl=function(d_x,d_y){var seg=this.segs[this.selected_pts[0]];seg.moveCtrl(this.dragctrl,d_x,d_y),link_control_pts&&seg.setLinked(this.dragctrl)},svgedit.path.Path.prototype.setSegType=function(new_type){this.storeD();for(var text,i=this.selected_pts.length;i--;){var sel_pt=this.selected_pts[i],cur=this.segs[sel_pt],prev=cur.prev;if(prev){if(!new_type){text="Toggle Path Segment Type";var old_type=cur.type;new_type=6==old_type?4:6}new_type=Number(new_type);var points,cur_x=cur.item.x,cur_y=cur.item.y,prev_x=prev.item.x,prev_y=prev.item.y;switch(new_type){case 6:if(cur.olditem){var old=cur.olditem;points=[cur_x,cur_y,old.x1,old.y1,old.x2,old.y2]}else{var diff_x=cur_x-prev_x,diff_y=cur_y-prev_y,ct1_x=prev_x+diff_x/3,ct1_y=prev_y+diff_y/3,ct2_x=cur_x-diff_x/3,ct2_y=cur_y-diff_y/3;points=[cur_x,cur_y,ct1_x,ct1_y,ct2_x,ct2_y]}break;case 4:points=[cur_x,cur_y],cur.olditem=cur.item}cur.setType(new_type,points)}}svgedit.path.path.endChanges(text)},svgedit.path.Path.prototype.selectPt=function(pt,ctrl_num){this.clearSelection(),null==pt&&this.eachSeg(function(i){this.prev&&(pt=i)}),this.addPtsToSelection(pt),ctrl_num&&(this.dragctrl=ctrl_num,link_control_pts&&this.segs[pt].setLinked(ctrl_num))},svgedit.path.Path.prototype.update=function(){var elem=this.elem;return svgedit.utilities.getRotationAngle(elem)?(this.matrix=svgedit.math.getMatrix(elem),this.imatrix=this.matrix.inverse()):(this.matrix=null,this.imatrix=null),this.eachSeg(function(i){this.item=elem.pathSegList.getItem(i),this.update()}),this},svgedit.path.getPath_=function(elem){var p=pathData[elem.id];return p||(p=pathData[elem.id]=new svgedit.path.Path(elem)),p},svgedit.path.removePath_=function(id){id in pathData&&delete pathData[id]};var newcx,newcy,oldcx,oldcy,angle,getRotVals=function(x,y){var dx=x-oldcx,dy=y-oldcy,r=Math.sqrt(dx*dx+dy*dy),theta=Math.atan2(dy,dx)+angle;return dx=r*Math.cos(theta)+oldcx,dy=r*Math.sin(theta)+oldcy,dx-=newcx,dy-=newcy,r=Math.sqrt(dx*dx+dy*dy),theta=Math.atan2(dy,dx)-angle,{x:r*Math.cos(theta)+newcx,y:r*Math.sin(theta)+newcy}};svgedit.path.recalcRotatedPath=function(){var current_path=svgedit.path.path.elem;if(angle=svgedit.utilities.getRotationAngle(current_path,!0)){var box=svgedit.utilities.getBBox(current_path),oldbox=svgedit.path.path.oldbbox;
oldcx=oldbox.x+oldbox.width/2,oldcy=oldbox.y+oldbox.height/2,newcx=box.x+box.width/2,newcy=box.y+box.height/2;var dx=newcx-oldcx,dy=newcy-oldcy,r=Math.sqrt(dx*dx+dy*dy),theta=Math.atan2(dy,dx)+angle;newcx=r*Math.cos(theta)+oldcx,newcy=r*Math.sin(theta)+oldcy;for(var list=current_path.pathSegList,i=list.numberOfItems;i;){i-=1;var seg=list.getItem(i),type=seg.pathSegType;if(1!=type){var rvals=getRotVals(seg.x,seg.y),points=[rvals.x,rvals.y];if(null!=seg.x1&&null!=seg.x2){var c_vals1=getRotVals(seg.x1,seg.y1),c_vals2=getRotVals(seg.x2,seg.y2);points.splice(points.length,0,c_vals1.x,c_vals1.y,c_vals2.x,c_vals2.y)}svgedit.path.replacePathSeg(type,i,points)}}box=svgedit.utilities.getBBox(current_path);var R_nc=svgroot.createSVGTransform(),tlist=svgedit.transformlist.getTransformList(current_path);R_nc.setRotate(180*angle/Math.PI,newcx,newcy),tlist.replaceItem(R_nc,0)}},svgedit.path.clearData=function(){pathData={}}}(),function(){window.console||(window.console={},window.console.log=function(){},window.console.dir=function(){}),window.opera&&(window.console.log=function(str){opera.postError(str)},window.console.dir=function(){})}(),$.SvgCanvas=function(container,config){function reorientGrads(elem,m){var i,bb=svgedit.utilities.getBBox(elem);for(i=0;2>i;i++){var type=0===i?"fill":"stroke",attrVal=elem.getAttribute(type);if(attrVal&&0===attrVal.indexOf("url(")){var grad=svgedit.utilities.getRefElem(attrVal);if("linearGradient"===grad.tagName){var x1=grad.getAttribute("x1")||0,y1=grad.getAttribute("y1")||0,x2=grad.getAttribute("x2")||1,y2=grad.getAttribute("y2")||0;x1=bb.width*x1+bb.x,y1=bb.height*y1+bb.y,x2=bb.width*x2+bb.x,y2=bb.height*y2+bb.y;var pt1=svgedit.math.transformPoint(x1,y1,m),pt2=svgedit.math.transformPoint(x2,y2,m),g_coords={};g_coords.x1=(pt1.x-bb.x)/bb.width,g_coords.y1=(pt1.y-bb.y)/bb.height,g_coords.x2=(pt2.x-bb.x)/bb.width,g_coords.y2=(pt2.y-bb.y)/bb.height;var newgrad=grad.cloneNode(!0);$(newgrad).attr(g_coords),newgrad.id=getNextId(),svgedit.utilities.findDefs().appendChild(newgrad),elem.setAttribute(type,"url(#"+newgrad.id+")")}}}}var NS=svgedit.NS,curConfig={show_outside_canvas:!0,selectNew:!0,dimensions:[640,480]};config&&$.extend(curConfig,config);var dimensions=curConfig.dimensions,canvas=this,svgdoc=container.ownerDocument,svgroot=svgdoc.importNode(svgedit.utilities.text2xml('<svg id="svgroot" xmlns="'+NS.SVG+'" xlinkns="'+NS.XLINK+'" width="'+dimensions[0]+'" height="'+dimensions[1]+'" x="'+dimensions[0]+'" y="'+dimensions[1]+'" overflow="visible"><defs><filter id="canvashadow" filterUnits="objectBoundingBox"><feGaussianBlur in="SourceAlpha" stdDeviation="4" result="blur"/><feOffset in="blur" dx="5" dy="5" result="offsetBlur"/><feMerge><feMergeNode in="offsetBlur"/><feMergeNode in="SourceGraphic"/></feMerge></filter></defs></svg>').documentElement,!0);container.appendChild(svgroot);var svgcontent=svgdoc.createElementNS(NS.SVG,"svg"),clearSvgContentElement=canvas.clearSvgContentElement=function(){for(;svgcontent.firstChild;)svgcontent.removeChild(svgcontent.firstChild);$(svgcontent).attr({id:"svgcontent",width:dimensions[0],height:dimensions[1],x:dimensions[0],y:dimensions[1],overflow:curConfig.show_outside_canvas?"visible":"hidden",xmlns:NS.SVG,"xmlns:se":NS.SE,"xmlns:xlink":NS.XLINK}).appendTo(svgroot);var comment=svgdoc.createComment(" Created with SVG-edit - http://svg-edit.googlecode.com/ ");svgcontent.appendChild(comment)};clearSvgContentElement();var idprefix="svg_";canvas.setIdPrefix=function(p){idprefix=p},canvas.current_drawing_=new svgedit.draw.Drawing(svgcontent,idprefix);var getCurrentDrawing=canvas.getCurrentDrawing=function(){return canvas.current_drawing_},current_zoom=1,current_group=null,all_properties={shape:{fill:("none"==curConfig.initFill.color?"":"#")+curConfig.initFill.color,fill_paint:null,fill_opacity:curConfig.initFill.opacity,stroke:"#"+curConfig.initStroke.color,stroke_paint:null,stroke_opacity:curConfig.initStroke.opacity,stroke_width:curConfig.initStroke.width,stroke_dasharray:"none",stroke_linejoin:"miter",stroke_linecap:"butt",opacity:curConfig.initOpacity}};all_properties.text=$.extend(!0,{},all_properties.shape),$.extend(all_properties.text,{fill:"#000000",stroke_width:0,font_size:24,font_family:"serif"});{var cur_shape=all_properties.shape,selectedElements=new Array(1),addSvgElementFromJson=this.addSvgElementFromJson=function(data){var shape=svgedit.utilities.getElem(data.attr.id),current_layer=getCurrentDrawing().getCurrentLayer();return shape&&data.element!=shape.tagName&&(current_layer.removeChild(shape),shape=null),shape||(shape=svgdoc.createElementNS(NS.SVG,data.element),current_layer&&(current_group||current_layer).appendChild(shape)),data.curStyles&&svgedit.utilities.assignAttributes(shape,{fill:cur_shape.fill,stroke:cur_shape.stroke,"stroke-width":cur_shape.stroke_width,"stroke-dasharray":cur_shape.stroke_dasharray,"stroke-linejoin":cur_shape.stroke_linejoin,"stroke-linecap":cur_shape.stroke_linecap,"stroke-opacity":cur_shape.stroke_opacity,"fill-opacity":cur_shape.fill_opacity,opacity:cur_shape.opacity/2,style:"pointer-events:inherit"},100),svgedit.utilities.assignAttributes(shape,data.attr,100),svgedit.utilities.cleanupElement(shape),shape},transformPoint=(canvas.getTransformList=svgedit.transformlist.getTransformList,svgedit.math.transformPoint),matrixMultiply=canvas.matrixMultiply=svgedit.math.matrixMultiply,hasMatrixTransform=canvas.hasMatrixTransform=svgedit.math.hasMatrixTransform,transformListToTransform=canvas.transformListToTransform=svgedit.math.transformListToTransform;svgedit.math.snapToAngle,svgedit.math.getMatrix}svgedit.units.init({getBaseUnit:function(){return curConfig.baseUnit},getElement:svgedit.utilities.getElem,getHeight:function(){return svgcontent.getAttribute("height")/current_zoom},getWidth:function(){return svgcontent.getAttribute("width")/current_zoom},getRoundDigits:function(){return save_options.round_digits}});canvas.convertToNum=svgedit.units.convertToNum;svgedit.utilities.init({getDOMDocument:function(){return svgdoc},getDOMContainer:function(){return container},getSVGRoot:function(){return svgroot},getSelectedElements:function(){return selectedElements},getSVGContent:function(){return svgcontent},getBaseUnit:function(){return curConfig.baseUnit},getSnappingStep:function(){return curConfig.snappingStep}});var findDefs=canvas.findDefs=svgedit.utilities.findDefs,getUrlFromAttr=canvas.getUrlFromAttr=svgedit.utilities.getUrlFromAttr,getHref=canvas.getHref=svgedit.utilities.getHref,setHref=canvas.setHref=svgedit.utilities.setHref,getPathBBox=svgedit.utilities.getPathBBox,getElem=(canvas.getBBox=svgedit.utilities.getBBox,canvas.getRotationAngle=svgedit.utilities.getRotationAngle,canvas.getElem=svgedit.utilities.getElem),assignAttributes=(canvas.getRefElem=svgedit.utilities.getRefElem,canvas.assignAttributes=svgedit.utilities.assignAttributes),cleanupElement=this.cleanupElement=svgedit.utilities.cleanupElement;svgedit.coords.init({getDrawing:function(){return getCurrentDrawing()},getGridSnapping:function(){return curConfig.gridSnapping}});var remapElement=this.remapElement=svgedit.coords.remapElement;svgedit.recalculate.init({getSVGRoot:function(){return svgroot},getStartTransform:function(){return startTransform},setStartTransform:function(transform){startTransform=transform}});var recalculateDimensions=this.recalculateDimensions=svgedit.recalculate.recalculateDimensions,nsMap=svgedit.getReverseNS(),sanitizeSvg=canvas.sanitizeSvg=svgedit.sanitize.sanitizeSvg,MoveElementCommand=svgedit.history.MoveElementCommand,InsertElementCommand=svgedit.history.InsertElementCommand,RemoveElementCommand=svgedit.history.RemoveElementCommand,ChangeElementCommand=svgedit.history.ChangeElementCommand,BatchCommand=svgedit.history.BatchCommand;canvas.undoMgr=new svgedit.history.UndoManager({handleHistoryEvent:function(eventType,cmd){var EventTypes=svgedit.history.HistoryEventTypes;if(eventType==EventTypes.BEFORE_UNAPPLY||eventType==EventTypes.BEFORE_APPLY)canvas.clearSelection();else if(eventType==EventTypes.AFTER_APPLY||eventType==EventTypes.AFTER_UNAPPLY){var elems=cmd.elements();canvas.pathActions.clear(),call("changed",elems);var cmdType=cmd.type(),isApply=eventType==EventTypes.AFTER_APPLY;if(cmdType==MoveElementCommand.type()){var parent=isApply?cmd.newParent:cmd.oldParent;parent==svgcontent&&canvas.identifyLayers()}else if(cmdType==InsertElementCommand.type()||cmdType==RemoveElementCommand.type())cmd.parent==svgcontent&&canvas.identifyLayers(),cmdType==InsertElementCommand.type()?isApply&&restoreRefElems(cmd.elem):isApply||restoreRefElems(cmd.elem),"use"===cmd.elem.tagName&&setUseData(cmd.elem);else if(cmdType==ChangeElementCommand.type()){"title"==cmd.elem.tagName&&cmd.elem.parentNode.parentNode==svgcontent&&canvas.identifyLayers();var values=isApply?cmd.newValues:cmd.oldValues;values.stdDeviation&&canvas.setBlurOffsets(cmd.elem.parentNode,values.stdDeviation)}}}});var addCommandToHistory=function(cmd){canvas.undoMgr.addCommandToHistory(cmd)};svgedit.select.init(curConfig,{createSVGElement:function(jsonMap){return canvas.addSvgElementFromJson(jsonMap)},svgRoot:function(){return svgroot},svgContent:function(){return svgcontent},currentZoom:function(){return current_zoom},getStrokedBBox:function(elems){return canvas.getStrokedBBox([elems])}});var selectorManager=this.selectorManager=svgedit.select.getSelectorManager();svgedit.path.init({getCurrentZoom:function(){return current_zoom},getSVGRoot:function(){return svgroot}});var uiStrings={exportNoBlur:"Blurred elements will appear as un-blurred",exportNoforeignObject:"foreignObject elements will not appear",exportNoDashArray:"Strokes will appear filled",exportNoText:"Text may not appear as expected"},visElems="a,circle,ellipse,foreignObject,g,image,line,path,polygon,polyline,rect,svg,text,tspan,use",ref_attrs=["clip-path","fill","filter","marker-end","marker-mid","marker-start","mask","stroke"],elData=$.data,opac_ani=document.createElementNS(NS.SVG,"animate");$(opac_ani).attr({attributeName:"opacity",begin:"indefinite",dur:1,fill:"freeze"}).appendTo(svgroot);var restoreRefElems=function(elem){var o,i,attrs=$(elem).attr(ref_attrs);for(o in attrs){var val=attrs[o];if(val&&0===val.indexOf("url(")){var id=svgedit.utilities.getUrlFromAttr(val).substr(1),ref=getElem(id);ref||(svgedit.utilities.findDefs().appendChild(removedElements[id]),delete removedElements[id])}}var childs=elem.getElementsByTagName("*");if(childs.length)for(i=0,l=childs.length;l>i;i++)restoreRefElems(childs[i])},encodableImages={},last_good_img_url=curConfig.imgPath+"logo.png",disabled_elems=[],save_options={round_digits:5},started=!1,startTransform=null,current_mode="select",current_resize_mode="none",import_ids={},cur_text=all_properties.text,cur_properties=cur_shape,justSelected=null,rubberBox=null,curBBoxes=[],extensions={},lastClickPoint=null,removedElements={};canvas.clipBoard=[];var runExtensions=this.runExtensions=function(action,vars,returnArray){var result=returnArray?[]:!1;return $.each(extensions,function(name,opts){opts&&action in opts&&(returnArray?result.push(opts[action](vars)):result=opts[action](vars))}),result};this.addExtension=function(name,ext_func){var ext;name in extensions?console.log('Cannot add extension "'+name+'", an extension by that name already exists.'):(ext=$.isFunction(ext_func)?ext_func($.extend(canvas.getPrivateMethods(),{svgroot:svgroot,svgcontent:svgcontent,nonce:getCurrentDrawing().getNonce(),selectorManager:selectorManager})):ext_func,extensions[name]=ext,call("extension_added",ext))};var round=this.round=function(val){return parseInt(val*current_zoom,10)/current_zoom},getIntersectionList=this.getIntersectionList=function(rect){if(null==rubberBox)return null;var parent=current_group||getCurrentDrawing().getCurrentLayer();curBBoxes.length||(curBBoxes=getVisibleElementsAndBBoxes(parent));var resultList=null;try{resultList=parent.getIntersectionList(rect,null)}catch(e){}if(null==resultList||"function"!=typeof resultList.item){resultList=[];var rubberBBox;if(rect)rubberBBox=rect;else{rubberBBox=rubberBox.getBBox();var o,bb={};for(o in rubberBBox)bb[o]=rubberBBox[o]/current_zoom;rubberBBox=bb}for(var i=curBBoxes.length;i--;)rubberBBox.width&&svgedit.math.rectsIntersect(rubberBBox,curBBoxes[i].bbox)&&resultList.push(curBBoxes[i].elem)}return resultList};getStrokedBBox=this.getStrokedBBox=function(elems){if(elems||(elems=getVisibleElements()),!elems.length)return!1;var full_bb,getCheckedBBox=function(elem){try{var bb=svgedit.utilities.getBBox(elem),angle=svgedit.utilities.getRotationAngle(elem);if(angle&&angle%90||svgedit.math.hasMatrixTransform(svgedit.transformlist.getTransformList(elem))){var good_bb=!1,elemNames=["ellipse","path","line","polyline","polygon"];if(elemNames.indexOf(elem.tagName)>=0)bb=good_bb=canvas.convertToPath(elem,!0);else if("rect"==elem.tagName){var rx=elem.getAttribute("rx"),ry=elem.getAttribute("ry");(rx||ry)&&(bb=good_bb=canvas.convertToPath(elem,!0))}if(!good_bb){var clone=elem.cloneNode(!0),g=document.createElementNS(NS.SVG,"g"),parent=elem.parentNode;parent.appendChild(g),g.appendChild(clone),bb=svgedit.utilities.bboxToObj(g.getBBox()),parent.removeChild(g)}}return bb}catch(e){return console.log(elem,e),null}};if($.each(elems,function(){full_bb||this.parentNode&&(full_bb=getCheckedBBox(this))}),null==full_bb)return null;var max_x=full_bb.x+full_bb.width,max_y=full_bb.y+full_bb.height,min_x=full_bb.x,min_y=full_bb.y,getOffset=function(elem){var sw=elem.getAttribute("stroke-width"),offset=0;return"none"==elem.getAttribute("stroke")||isNaN(sw)||(offset+=sw/2),offset},bboxes=[];return $.each(elems,function(i,elem){var cur_bb=getCheckedBBox(elem);if(cur_bb){var offset=getOffset(elem);min_x=Math.min(min_x,cur_bb.x-offset),min_y=Math.min(min_y,cur_bb.y-offset),bboxes.push(cur_bb)}}),full_bb.x=min_x,full_bb.y=min_y,$.each(elems,function(i,elem){var cur_bb=bboxes[i];if(cur_bb&&1==elem.nodeType){var offset=getOffset(elem);max_x=Math.max(max_x,cur_bb.x+cur_bb.width+offset),max_y=Math.max(max_y,cur_bb.y+cur_bb.height+offset)}}),full_bb.width=max_x-min_x,full_bb.height=max_y-min_y,full_bb};var getId,getNextId,call,textActions,pathActions,getVisibleElements=this.getVisibleElements=function(parent){parent||(parent=$(svgcontent).children());var contentElems=[];return $(parent).children().each(function(i,elem){try{elem.getBBox()&&contentElems.push(elem)}catch(e){}}),contentElems.reverse()},getVisibleElementsAndBBoxes=this.getVisibleElementsAndBBoxes=function(parent){parent||(parent=$(svgcontent).children());var contentElems=[];return $(parent).children().each(function(i,elem){try{elem.getBBox()&&contentElems.push({elem:elem,bbox:getStrokedBBox([elem])})}catch(e){}}),contentElems.reverse()},groupSvgElem=this.groupSvgElem=function(elem){var g=document.createElementNS(NS.SVG,"g");elem.parentNode.replaceChild(g,elem),$(g).append(elem).data("gsvg",elem)[0].id=getNextId()},copyElem=function(el){var new_el=document.createElementNS(el.namespaceURI,el.nodeName);if($.each(el.attributes,function(i,attr){"-moz-math-font-style"!=attr.localName&&new_el.setAttributeNS(attr.namespaceURI,attr.nodeName,attr.value)}),new_el.removeAttribute("id"),new_el.id=getNextId(),svgedit.browser.isWebkit()&&"path"==el.nodeName){var fixed_d=pathActions.convertPath(el);new_el.setAttribute("d",fixed_d)}if($.each(el.childNodes,function(i,child){switch(child.nodeType){case 1:new_el.appendChild(copyElem(child));break;case 3:new_el.textContent=child.nodeValue}}),$(el).data("gsvg"))$(new_el).data("gsvg",new_el.firstChild);else if($(el).data("symbol")){var ref=$(el).data("symbol");$(new_el).data("ref",ref).data("symbol",ref)}else"image"==new_el.tagName&&preventClickDefault(new_el);return new_el};!function(c){var events={};getId=c.getId=function(){return getCurrentDrawing().getId()},getNextId=c.getNextId=function(){return getCurrentDrawing().getNextId()},call=c.call=function(event,arg){return events[event]?events[event](this,arg):void 0},c.bind=function(event,f){var old=events[event];return events[event]=f,old}}(canvas),this.prepareSvg=function(newDoc){this.sanitizeSvg(newDoc.documentElement);var i,path,len,paths=newDoc.getElementsByTagNameNS(NS.SVG,"path");for(i=0,len=paths.length;len>i;++i)path=paths[i],path.setAttribute("d",pathActions.convertPath(path)),pathActions.fixEnd(path)};var ffClone=function(elem){if(!svgedit.browser.isGecko())return elem;var clone=elem.cloneNode(!0);return elem.parentNode.insertBefore(clone,elem),elem.parentNode.removeChild(elem),selectorManager.releaseSelector(elem),selectedElements[0]=clone,selectorManager.requestSelector(clone).showGrips(!0),clone};this.setRotationAngle=function(val,preventUndo){val=parseFloat(val);var elem=selectedElements[0],oldTransform=elem.getAttribute("transform"),bbox=svgedit.utilities.getBBox(elem),cx=bbox.x+bbox.width/2,cy=bbox.y+bbox.height/2,tlist=svgedit.transformlist.getTransformList(elem);if(tlist.numberOfItems>0){var xform=tlist.getItem(0);4==xform.type&&tlist.removeItem(0)}if(0!=val){var center=svgedit.math.transformPoint(cx,cy,svgedit.math.transformListToTransform(tlist).matrix),R_nc=svgroot.createSVGTransform();R_nc.setRotate(val,center.x,center.y),tlist.numberOfItems?tlist.insertItemBefore(R_nc,0):tlist.appendItem(R_nc)}else 0==tlist.numberOfItems&&elem.removeAttribute("transform");if(!preventUndo){var newTransform=elem.getAttribute("transform");elem.setAttribute("transform",oldTransform),changeSelectedAttribute("transform",newTransform,selectedElements),call("changed",selectedElements)}var selector=(svgedit.utilities.getElem("pathpointgrip_container"),selectorManager.requestSelector(selectedElements[0]));selector.resize(),selector.updateGripCursors(val)};{var recalculateAllSelectedDimensions=this.recalculateAllSelectedDimensions=function(){for(var text="none"==current_resize_mode?"position":"size",batchCmd=new svgedit.history.BatchCommand(text),i=selectedElements.length;i--;){var elem=selectedElements[i],cmd=svgedit.recalculate.recalculateDimensions(elem);cmd&&batchCmd.addSubCommand(cmd)}batchCmd.isEmpty()||(addCommandToHistory(batchCmd),call("changed",selectedElements))},pathMap=[0,"z","M","m","L","l","C","c","Q","q","A","a","H","h","V","v","S","s","T","t"],logMatrix=function(m){console.log([m.a,m.b,m.c,m.d,m.e,m.f])},root_sctm=null,clearSelection=this.clearSelection=function(noCall){if(null!=selectedElements[0]){var i,elem,len=selectedElements.length;for(i=0;len>i&&(elem=selectedElements[i],null!=elem);++i)selectorManager.releaseSelector(elem),selectedElements[i]=null}noCall||call("selected",selectedElements)},addToSelection=this.addToSelection=function(elemsToAdd,showGrips){if(0!=elemsToAdd.length){for(var j=0;j<selectedElements.length&&null!=selectedElements[j];)++j;for(var i=elemsToAdd.length;i--;){var elem=elemsToAdd[i];if(elem&&svgedit.utilities.getBBox(elem)&&("a"===elem.tagName&&1===elem.childNodes.length&&(elem=elem.firstChild),-1==selectedElements.indexOf(elem))){selectedElements[j]=elem,j++;var sel=selectorManager.requestSelector(elem);selectedElements.length>1&&sel.showGrips(!1)}}for(call("selected",selectedElements),selectorManager.requestSelector(selectedElements[0]).showGrips(showGrips||1==selectedElements.length?!0:!1),selectedElements.sort(function(a,b){return a&&b&&a.compareDocumentPosition?3-(6&b.compareDocumentPosition(a)):null==a?1:void 0});null==selectedElements[0];)selectedElements.shift(0)}},selectOnly=this.selectOnly=function(elems,showGrips){clearSelection(!0),addToSelection(elems,showGrips)};this.removeFromSelection=function(elemsToRemove){if(null!=selectedElements[0]&&0!=elemsToRemove.length){var i,j=0,newSelectedItems=new Array(selectedElements.length),len=selectedElements.length;for(i=0;len>i;++i){var elem=selectedElements[i];elem&&(-1==elemsToRemove.indexOf(elem)?(newSelectedItems[j]=elem,j++):selectorManager.releaseSelector(elem))}selectedElements=newSelectedItems}}}this.selectAllInCurrentLayer=function(){var current_layer=getCurrentDrawing().getCurrentLayer();current_layer&&(current_mode="select",selectOnly($(current_group||current_layer).children()))};var getMouseTarget=this.getMouseTarget=function(evt){if(null==evt)return null;var mouse_target=evt.target;if(mouse_target.correspondingUseElement&&(mouse_target=mouse_target.correspondingUseElement),[NS.MATH,NS.HTML].indexOf(mouse_target.namespaceURI)>=0&&"svgcanvas"!=mouse_target.id)for(;"foreignObject"!=mouse_target.nodeName;)if(mouse_target=mouse_target.parentNode,!mouse_target)return svgroot;var current_layer=getCurrentDrawing().getCurrentLayer();if([svgroot,container,svgcontent,current_layer].indexOf(mouse_target)>=0)return svgroot;var $target=$(mouse_target);if($target.closest("#selectorParentGroup").length)return selectorManager.selectorParentGroup;for(;mouse_target.parentNode!==(current_group||current_layer);)mouse_target=mouse_target.parentNode;return mouse_target};!function(){var parameter,nextParameter,d_attr=null,start_x=null,start_y=null,r_start_x=null,r_start_y=null,init_bbox={},freehand={minx:null,miny:null,maxx:null,maxy:null},sumDistance=0,controllPoint2={x:0,y:0},controllPoint1={x:0,y:0},start={x:0,y:0},end={x:0,y:0},bSpline={x:0,y:0},nextPos={x:0,y:0},THRESHOLD_DIST=.8,STEP_COUNT=10,getBsplinePoint=function(t){var spline={x:0,y:0},p0=controllPoint2,p1=controllPoint1,p2=start,p3=end,S=1/6,t2=t*t,t3=t2*t,m=[[-1,3,-3,1],[3,-6,3,0],[-3,0,3,0],[1,4,1,0]];return spline.x=S*((p0.x*m[0][0]+p1.x*m[0][1]+p2.x*m[0][2]+p3.x*m[0][3])*t3+(p0.x*m[1][0]+p1.x*m[1][1]+p2.x*m[1][2]+p3.x*m[1][3])*t2+(p0.x*m[2][0]+p1.x*m[2][1]+p2.x*m[2][2]+p3.x*m[2][3])*t+(p0.x*m[3][0]+p1.x*m[3][1]+p2.x*m[3][2]+p3.x*m[3][3])),spline.y=S*((p0.y*m[0][0]+p1.y*m[0][1]+p2.y*m[0][2]+p3.y*m[0][3])*t3+(p0.y*m[1][0]+p1.y*m[1][1]+p2.y*m[1][2]+p3.y*m[1][3])*t2+(p0.y*m[2][0]+p1.y*m[2][1]+p2.y*m[2][2]+p3.y*m[2][3])*t+(p0.y*m[3][0]+p1.y*m[3][1]+p2.y*m[3][2]+p3.y*m[3][3])),{x:spline.x,y:spline.y}},mouseDown=function(evt){if(!canvas.spaceKey&&1!==evt.button){var right_click=2===evt.button;evt.altKey&&svgCanvas.cloneSelectedElements(0,0),root_sctm=$("#svgcontent g")[0].getScreenCTM().inverse();var pt=svgedit.math.transformPoint(evt.pageX,evt.pageY,root_sctm),mouse_x=pt.x*current_zoom,mouse_y=pt.y*current_zoom;evt.preventDefault(),right_click&&(current_mode="select",lastClickPoint=pt);var x=mouse_x/current_zoom,y=mouse_y/current_zoom,mouse_target=getMouseTarget(evt);"a"===mouse_target.tagName&&1===mouse_target.childNodes.length&&(mouse_target=mouse_target.firstChild);var real_x=x;r_start_x=start_x=x;var real_y=y;if(r_start_y=start_y=y,curConfig.gridSnapping&&(x=svgedit.utilities.snapToGrid(x),y=svgedit.utilities.snapToGrid(y),start_x=svgedit.utilities.snapToGrid(start_x),start_y=svgedit.utilities.snapToGrid(start_y)),mouse_target==selectorManager.selectorParentGroup&&null!=selectedElements[0]){var grip=evt.target,griptype=elData(grip,"type");"rotate"==griptype?current_mode="rotate":"resize"==griptype&&(current_mode="resize",current_resize_mode=elData(grip,"dir")),mouse_target=selectedElements[0]}startTransform=mouse_target.getAttribute("transform");var i,stroke_w,tlist=svgedit.transformlist.getTransformList(mouse_target);switch(current_mode){case"select":if(started=!0,current_resize_mode="none",right_click&&(started=!1),mouse_target!=svgroot){if(-1==selectedElements.indexOf(mouse_target)&&(evt.shiftKey||clearSelection(!0),addToSelection([mouse_target]),justSelected=mouse_target,pathActions.clear()),!right_click)for(i=0;i<selectedElements.length;++i)if(null!=selectedElements[i]){var slist=svgedit.transformlist.getTransformList(selectedElements[i]);slist.numberOfItems?slist.insertItemBefore(svgroot.createSVGTransform(),0):slist.appendItem(svgroot.createSVGTransform())}}else right_click||(clearSelection(),current_mode="multiselect",null==rubberBox&&(rubberBox=selectorManager.getRubberBandBox()),r_start_x*=current_zoom,r_start_y*=current_zoom,svgedit.utilities.assignAttributes(rubberBox,{x:r_start_x,y:r_start_y,width:0,height:0,display:"inline"},100));break;case"zoom":started=!0,null==rubberBox&&(rubberBox=selectorManager.getRubberBandBox()),svgedit.utilities.assignAttributes(rubberBox,{x:real_x*current_zoom,y:real_x*current_zoom,width:0,height:0,display:"inline"},100);break;case"resize":started=!0,start_x=x,start_y=y,init_bbox=svgedit.utilities.getBBox($("#selectedBox0")[0]);var bb={};$.each(init_bbox,function(key,val){bb[key]=val/current_zoom}),init_bbox=bb;var pos=svgedit.utilities.getRotationAngle(mouse_target)?1:0;if(svgedit.math.hasMatrixTransform(tlist))tlist.insertItemBefore(svgroot.createSVGTransform(),pos),tlist.insertItemBefore(svgroot.createSVGTransform(),pos),tlist.insertItemBefore(svgroot.createSVGTransform(),pos);else if(tlist.appendItem(svgroot.createSVGTransform()),tlist.appendItem(svgroot.createSVGTransform()),tlist.appendItem(svgroot.createSVGTransform()),svgedit.browser.supportsNonScalingStroke()){var isWebkit=svgedit.browser.isWebkit();if(isWebkit)var delayedStroke=function(ele){var _stroke=ele.getAttributeNS(null,"stroke");ele.removeAttributeNS(null,"stroke"),setTimeout(function(){ele.setAttributeNS(null,"stroke",_stroke)},0)};mouse_target.style.vectorEffect="non-scaling-stroke",isWebkit&&delayedStroke(mouse_target);var all=mouse_target.getElementsByTagName("*"),len=all.length;for(i=0;len>i;i++)all[i].style.vectorEffect="non-scaling-stroke",isWebkit&&delayedStroke(all[i])}break;case"fhellipse":case"fhrect":case"fhpath":start.x=real_x,start.y=real_y,started=!0,d_attr=real_x+","+real_y+" ",stroke_w=0==cur_shape.stroke_width?1:cur_shape.stroke_width,addSvgElementFromJson({element:"polyline",curStyles:!0,attr:{points:d_attr,id:getNextId(),fill:"none",opacity:cur_shape.opacity/2,"stroke-linecap":"round",style:"pointer-events:none"}}),freehand.minx=real_x,freehand.maxx=real_x,freehand.miny=real_y,freehand.maxy=real_y;break;case"image":started=!0;var newImage=addSvgElementFromJson({element:"image",attr:{x:x,y:y,width:0,height:0,id:getNextId(),opacity:cur_shape.opacity/2,style:"pointer-events:inherit"}});setHref(newImage,last_good_img_url),preventClickDefault(newImage);break;case"square":case"rect":started=!0,start_x=x,start_y=y,addSvgElementFromJson({element:"rect",curStyles:!0,attr:{x:x,y:y,width:0,height:0,id:getNextId(),opacity:cur_shape.opacity/2}});break;case"line":started=!0,stroke_w=0==cur_shape.stroke_width?1:cur_shape.stroke_width,addSvgElementFromJson({element:"line",curStyles:!0,attr:{x1:x,y1:y,x2:x,y2:y,id:getNextId(),stroke:cur_shape.stroke,"stroke-width":stroke_w,"stroke-dasharray":cur_shape.stroke_dasharray,"stroke-linejoin":cur_shape.stroke_linejoin,"stroke-linecap":cur_shape.stroke_linecap,"stroke-opacity":cur_shape.stroke_opacity,fill:"none",opacity:cur_shape.opacity/2,style:"pointer-events:none"}});break;case"circle":started=!0,addSvgElementFromJson({element:"circle",curStyles:!0,attr:{cx:x,cy:y,r:0,id:getNextId(),opacity:cur_shape.opacity/2}});break;case"ellipse":started=!0,addSvgElementFromJson({element:"ellipse",curStyles:!0,attr:{cx:x,cy:y,rx:0,ry:0,id:getNextId(),opacity:cur_shape.opacity/2}});break;case"text":started=!0;{addSvgElementFromJson({element:"text",curStyles:!0,attr:{x:x,y:y,id:getNextId(),fill:cur_text.fill,"stroke-width":cur_text.stroke_width,"font-size":cur_text.font_size,"font-family":cur_text.font_family,"text-anchor":"middle","xml:space":"preserve",opacity:cur_shape.opacity}})}break;case"path":case"pathedit":start_x*=current_zoom,start_y*=current_zoom,pathActions.mouseDown(evt,mouse_target,start_x,start_y),started=!0;break;case"textedit":start_x*=current_zoom,start_y*=current_zoom,textActions.mouseDown(evt,mouse_target,start_x,start_y),started=!0;break;case"rotate":started=!0,canvas.undoMgr.beginUndoableChange("transform",selectedElements)}var ext_result=runExtensions("mouseDown",{event:evt,start_x:start_x,start_y:start_y,selectedElements:selectedElements},!0);$.each(ext_result,function(i,r){r&&r.started&&(started=!0)})}},mouseMove=function(evt){if(started&&1!==evt.button&&!canvas.spaceKey){var i,xya,c,cx,cy,dx,dy,len,angle,box,selected=selectedElements[0],pt=svgedit.math.transformPoint(evt.pageX,evt.pageY,root_sctm),mouse_x=pt.x*current_zoom,mouse_y=pt.y*current_zoom,shape=svgedit.utilities.getElem(getId()),real_x=mouse_x/current_zoom;x=real_x;var real_y=mouse_y/current_zoom;y=real_y,curConfig.gridSnapping&&(x=svgedit.utilities.snapToGrid(x),y=svgedit.utilities.snapToGrid(y)),evt.preventDefault();var tlist;switch(current_mode){case"select":if(null!==selectedElements[0]&&(dx=x-start_x,dy=y-start_y,curConfig.gridSnapping&&(dx=svgedit.utilities.snapToGrid(dx),dy=svgedit.utilities.snapToGrid(dy)),evt.shiftKey&&(xya=svgedit.math.snapToAngle(start_x,start_y,x,y),x=xya.x,y=xya.y),0!=dx||0!=dy)){for(len=selectedElements.length,i=0;len>i&&(selected=selectedElements[i],null!=selected);++i){var xform=svgroot.createSVGTransform();tlist=svgedit.transformlist.getTransformList(selected),xform.setTranslate(dx,dy),tlist.numberOfItems?tlist.replaceItem(xform,0):tlist.appendItem(xform),selectorManager.requestSelector(selected).resize()}call("transition",selectedElements)}break;case"multiselect":real_x*=current_zoom,real_y*=current_zoom,svgedit.utilities.assignAttributes(rubberBox,{x:Math.min(r_start_x,real_x),y:Math.min(r_start_y,real_y),width:Math.abs(real_x-r_start_x),height:Math.abs(real_y-r_start_y)},100);var elemsToRemove=[],elemsToAdd=[],newList=getIntersectionList();for(len=selectedElements.length,i=0;len>i;++i){var ind=newList.indexOf(selectedElements[i]);-1==ind?elemsToRemove.push(selectedElements[i]):newList[ind]=null}for(len=newList.length,i=0;len>i;++i)newList[i]&&elemsToAdd.push(newList[i]);elemsToRemove.length>0&&canvas.removeFromSelection(elemsToRemove),elemsToAdd.length>0&&addToSelection(elemsToAdd);break;case"resize":tlist=svgedit.transformlist.getTransformList(selected);var hasMatrix=svgedit.math.hasMatrixTransform(tlist);box=hasMatrix?init_bbox:svgedit.utilities.getBBox(selected);var left=box.x,top=box.y,width=box.width,height=box.height;if(dx=x-start_x,dy=y-start_y,curConfig.gridSnapping&&(dx=svgedit.utilities.snapToGrid(dx),dy=svgedit.utilities.snapToGrid(dy),height=svgedit.utilities.snapToGrid(height),width=svgedit.utilities.snapToGrid(width)),angle=svgedit.utilities.getRotationAngle(selected)){var r=Math.sqrt(dx*dx+dy*dy),theta=Math.atan2(dy,dx)-angle*Math.PI/180;dx=r*Math.cos(theta),dy=r*Math.sin(theta)}-1==current_resize_mode.indexOf("n")&&-1==current_resize_mode.indexOf("s")&&(dy=0),-1==current_resize_mode.indexOf("e")&&-1==current_resize_mode.indexOf("w")&&(dx=0);var tx=0,ty=0,sy=height?(height+dy)/height:1,sx=width?(width+dx)/width:1;current_resize_mode.indexOf("n")>=0&&(sy=height?(height-dy)/height:1,ty=height),current_resize_mode.indexOf("w")>=0&&(sx=width?(width-dx)/width:1,tx=width);var translateOrigin=svgroot.createSVGTransform(),scale=svgroot.createSVGTransform(),translateBack=svgroot.createSVGTransform();if(curConfig.gridSnapping&&(left=svgedit.utilities.snapToGrid(left),tx=svgedit.utilities.snapToGrid(tx),top=svgedit.utilities.snapToGrid(top),ty=svgedit.utilities.snapToGrid(ty)),translateOrigin.setTranslate(-(left+tx),-(top+ty)),evt.shiftKey&&(1==sx?sx=sy:sy=sx),scale.setScale(sx,sy),translateBack.setTranslate(left+tx,top+ty),hasMatrix){var diff=angle?1:0;tlist.replaceItem(translateOrigin,2+diff),tlist.replaceItem(scale,1+diff),tlist.replaceItem(translateBack,Number(diff))}else{var N=tlist.numberOfItems;tlist.replaceItem(translateBack,N-3),tlist.replaceItem(scale,N-2),tlist.replaceItem(translateOrigin,N-1)}selectorManager.requestSelector(selected).resize(),call("transition",selectedElements);break;case"zoom":real_x*=current_zoom,real_y*=current_zoom,svgedit.utilities.assignAttributes(rubberBox,{x:Math.min(r_start_x*current_zoom,real_x),y:Math.min(r_start_y*current_zoom,real_y),width:Math.abs(real_x-r_start_x*current_zoom),height:Math.abs(real_y-r_start_y*current_zoom)},100);break;case"text":svgedit.utilities.assignAttributes(shape,{x:x,y:y},1e3);break;case"line":var handle=null;window.opera||svgroot.suspendRedraw(1e3),curConfig.gridSnapping&&(x=svgedit.utilities.snapToGrid(x),y=svgedit.utilities.snapToGrid(y));
var x2=x,y2=y;evt.shiftKey&&(xya=svgedit.math.snapToAngle(start_x,start_y,x2,y2),x2=xya.x,y2=xya.y),shape.setAttributeNS(null,"x2",x2),shape.setAttributeNS(null,"y2",y2),window.opera||svgroot.unsuspendRedraw(handle);break;case"foreignObject":case"square":case"rect":case"image":var new_x,new_y,square="square"==current_mode||evt.shiftKey,w=Math.abs(x-start_x),h=Math.abs(y-start_y);square?(w=h=Math.max(w,h),new_x=x>start_x?start_x:start_x-w,new_y=y>start_y?start_y:start_y-h):(new_x=Math.min(start_x,x),new_y=Math.min(start_y,y)),curConfig.gridSnapping&&(w=svgedit.utilities.snapToGrid(w),h=svgedit.utilities.snapToGrid(h),new_x=svgedit.utilities.snapToGrid(new_x),new_y=svgedit.utilities.snapToGrid(new_y)),svgedit.utilities.assignAttributes(shape,{width:w,height:h,x:new_x,y:new_y},1e3);break;case"circle":c=$(shape).attr(["cx","cy"]),cx=c.cx,cy=c.cy;var rad=Math.sqrt((x-cx)*(x-cx)+(y-cy)*(y-cy));curConfig.gridSnapping&&(rad=svgedit.utilities.snapToGrid(rad)),shape.setAttributeNS(null,"r",rad);break;case"ellipse":c=$(shape).attr(["cx","cy"]),cx=c.cx,cy=c.cy,handle=null,window.opera||svgroot.suspendRedraw(1e3),curConfig.gridSnapping&&(x=svgedit.utilities.snapToGrid(x),cx=svgedit.utilities.snapToGrid(cx),y=svgedit.utilities.snapToGrid(y),cy=svgedit.utilities.snapToGrid(cy)),shape.setAttributeNS(null,"rx",Math.abs(x-cx));var ry=Math.abs(evt.shiftKey?x-cx:y-cy);shape.setAttributeNS(null,"ry",ry),window.opera||svgroot.unsuspendRedraw(handle);break;case"fhellipse":case"fhrect":freehand.minx=Math.min(real_x,freehand.minx),freehand.maxx=Math.max(real_x,freehand.maxx),freehand.miny=Math.min(real_y,freehand.miny),freehand.maxy=Math.max(real_y,freehand.maxy);case"fhpath":if(end.x=real_x,end.y=real_y,controllPoint2.x&&controllPoint2.y)for(i=0;STEP_COUNT-1>i;i++)parameter=i/STEP_COUNT,nextParameter=(i+1)/STEP_COUNT,bSpline=getBsplinePoint(nextParameter),nextPos=bSpline,bSpline=getBsplinePoint(parameter),sumDistance+=Math.sqrt((nextPos.x-bSpline.x)*(nextPos.x-bSpline.x)+(nextPos.y-bSpline.y)*(nextPos.y-bSpline.y)),sumDistance>THRESHOLD_DIST&&(d_attr+=+bSpline.x+","+bSpline.y+" ",shape.setAttributeNS(null,"points",d_attr),sumDistance-=THRESHOLD_DIST);controllPoint2={x:controllPoint1.x,y:controllPoint1.y},controllPoint1={x:start.x,y:start.y},start={x:end.x,y:end.y};break;case"path":case"pathedit":if(x*=current_zoom,y*=current_zoom,curConfig.gridSnapping&&(x=svgedit.utilities.snapToGrid(x),y=svgedit.utilities.snapToGrid(y),start_x=svgedit.utilities.snapToGrid(start_x),start_y=svgedit.utilities.snapToGrid(start_y)),evt.shiftKey){var x1,y1,path=svgedit.path.path;path?(x1=path.dragging?path.dragging[0]:start_x,y1=path.dragging?path.dragging[1]:start_y):(x1=start_x,y1=start_y),xya=svgedit.math.snapToAngle(x1,y1,x,y),x=xya.x,y=xya.y}rubberBox&&"none"!==rubberBox.getAttribute("display")&&(real_x*=current_zoom,real_y*=current_zoom,svgedit.utilities.assignAttributes(rubberBox,{x:Math.min(r_start_x*current_zoom,real_x),y:Math.min(r_start_y*current_zoom,real_y),width:Math.abs(real_x-r_start_x*current_zoom),height:Math.abs(real_y-r_start_y*current_zoom)},100)),pathActions.mouseMove(x,y);break;case"textedit":x*=current_zoom,y*=current_zoom,textActions.mouseMove(mouse_x,mouse_y);break;case"rotate":box=svgedit.utilities.getBBox(selected),cx=box.x+box.width/2,cy=box.y+box.height/2;var m=svgedit.math.getMatrix(selected),center=svgedit.math.transformPoint(cx,cy,m);if(cx=center.x,cy=center.y,angle=(Math.atan2(cy-y,cx-x)*(180/Math.PI)-90)%360,curConfig.gridSnapping&&(angle=svgedit.utilities.snapToGrid(angle)),evt.shiftKey){var snap=45;angle=Math.round(angle/snap)*snap}canvas.setRotationAngle(-180>angle?360+angle:angle,!0),call("transition",selectedElements)}runExtensions("mouseMove",{event:evt,mouse_x:mouse_x,mouse_y:mouse_y,selected:selected})}},mouseUp=function(evt){if(2!==evt.button){var tempJustSelected=justSelected;if(justSelected=null,started){var pt=svgedit.math.transformPoint(evt.pageX,evt.pageY,root_sctm),mouse_x=pt.x*current_zoom,mouse_y=pt.y*current_zoom,x=mouse_x/current_zoom,y=mouse_y/current_zoom,element=svgedit.utilities.getElem(getId()),keep=!1,real_x=x,real_y=y,useUnit=!1;started=!1;var attrs,t;switch(current_mode){case"resize":case"multiselect":null!=rubberBox&&(rubberBox.setAttribute("display","none"),curBBoxes=[]),current_mode="select";case"select":if(null!=selectedElements[0]){if(null==selectedElements[1]){var selected=selectedElements[0];switch(selected.tagName){case"g":case"use":case"image":case"foreignObject":break;default:cur_properties.fill=selected.getAttribute("fill"),cur_properties.fill_opacity=selected.getAttribute("fill-opacity"),cur_properties.stroke=selected.getAttribute("stroke"),cur_properties.stroke_opacity=selected.getAttribute("stroke-opacity"),cur_properties.stroke_width=selected.getAttribute("stroke-width"),cur_properties.stroke_dasharray=selected.getAttribute("stroke-dasharray"),cur_properties.stroke_linejoin=selected.getAttribute("stroke-linejoin"),cur_properties.stroke_linecap=selected.getAttribute("stroke-linecap")}"text"==selected.tagName&&(cur_text.font_size=selected.getAttribute("font-size"),cur_text.font_family=selected.getAttribute("font-family")),selectorManager.requestSelector(selected).showGrips(!0)}if(recalculateAllSelectedDimensions(),real_x!=r_start_x||real_y!=r_start_y){var i,len=selectedElements.length;for(i=0;len>i&&null!=selectedElements[i];++i)selectedElements[i].firstChild||selectorManager.requestSelector(selectedElements[i]).resize()}else t=evt.target,"path"===selectedElements[0].nodeName&&null==selectedElements[1]?pathActions.select(selectedElements[0]):evt.shiftKey&&tempJustSelected!=t&&canvas.removeFromSelection([t]);if(svgedit.browser.supportsNonScalingStroke()){var elem=selectedElements[0];elem&&(elem.removeAttribute("style"),svgedit.utilities.walkTree(elem,function(elem){elem.removeAttribute("style")}))}}return;case"zoom":null!=rubberBox&&rubberBox.setAttribute("display","none");var factor=evt.shiftKey?.5:2;return void call("zoomed",{x:Math.min(r_start_x,real_x),y:Math.min(r_start_y,real_y),width:Math.abs(real_x-r_start_x),height:Math.abs(real_y-r_start_y),factor:factor});case"fhpath":sumDistance=0,controllPoint2={x:0,y:0},controllPoint1={x:0,y:0},start={x:0,y:0},end={x:0,y:0};var coords=element.getAttribute("points"),commaIndex=coords.indexOf(",");keep=commaIndex>=0?coords.indexOf(",",commaIndex+1)>=0:coords.indexOf(" ",coords.indexOf(" ")+1)>=0,keep&&(element=pathActions.smoothPolylineIntoPath(element));break;case"line":attrs=$(element).attr(["x1","x2","y1","y2"]),keep=attrs.x1!=attrs.x2||attrs.y1!=attrs.y2;break;case"foreignObject":case"square":case"rect":case"image":attrs=$(element).attr(["width","height"]),keep=0!=attrs.width||0!=attrs.height||"image"===current_mode;break;case"circle":keep=0!=element.getAttribute("r");break;case"ellipse":attrs=$(element).attr(["rx","ry"]),keep=null!=attrs.rx||null!=attrs.ry;break;case"fhellipse":freehand.maxx-freehand.minx>0&&freehand.maxy-freehand.miny>0&&(element=addSvgElementFromJson({element:"ellipse",curStyles:!0,attr:{cx:(freehand.minx+freehand.maxx)/2,cy:(freehand.miny+freehand.maxy)/2,rx:(freehand.maxx-freehand.minx)/2,ry:(freehand.maxy-freehand.miny)/2,id:getId()}}),call("changed",[element]),keep=!0);break;case"fhrect":freehand.maxx-freehand.minx>0&&freehand.maxy-freehand.miny>0&&(element=addSvgElementFromJson({element:"rect",curStyles:!0,attr:{x:freehand.minx,y:freehand.miny,width:freehand.maxx-freehand.minx,height:freehand.maxy-freehand.miny,id:getId()}}),call("changed",[element]),keep=!0);break;case"text":keep=!0,selectOnly([element]),textActions.start(element);break;case"path":element=null,started=!0;var res=pathActions.mouseUp(evt,element,mouse_x,mouse_y);element=res.element,keep=res.keep;break;case"pathedit":keep=!0,element=null,pathActions.mouseUp(evt);break;case"textedit":keep=!1,element=null,textActions.mouseUp(evt,mouse_x,mouse_y);break;case"rotate":keep=!0,element=null,current_mode="select";var batchCmd=canvas.undoMgr.finishUndoableChange();batchCmd.isEmpty()||addCommandToHistory(batchCmd),recalculateAllSelectedDimensions(),call("changed",selectedElements)}var ext_result=runExtensions("mouseUp",{event:evt,mouse_x:mouse_x,mouse_y:mouse_y},!0);if($.each(ext_result,function(i,r){r&&(keep=r.keep||keep,element=r.element,started=r.started||started)}),keep||null==element){if(null!=element){canvas.addedNew=!0,useUnit&&svgedit.units.convertAttrs(element);var c_ani,ani_dur=.2;if(opac_ani.beginElement&&element.getAttribute("opacity")!=cur_shape.opacity){c_ani=$(opac_ani).clone().attr({to:cur_shape.opacity,dur:ani_dur}).appendTo(element);try{c_ani[0].beginElement()}catch(e){}}else ani_dur=0;setTimeout(function(){c_ani&&c_ani.remove(),element.setAttribute("opacity",cur_shape.opacity),element.setAttribute("style","pointer-events:inherit"),cleanupElement(element),"path"===current_mode?pathActions.toEditMode(element):curConfig.selectNew&&selectOnly([element],!0),addCommandToHistory(new svgedit.history.InsertElementCommand(element)),call("changed",[element])},1e3*ani_dur)}}else{for(getCurrentDrawing().releaseId(getId()),element.parentNode.removeChild(element),element=null,t=evt.target;"g"==t.parentNode.parentNode.tagName;)t=t.parentNode;"path"==current_mode&&drawn_path||"selectorParentGroup"==t.parentNode.id||"svgcanvas"==t.id||"svgroot"==t.id||(canvas.setMode("select"),selectOnly([t],!0))}startTransform=null}}},dblClick=function(evt){var evt_target=evt.target,parent=evt_target.parentNode;if(parent!==current_group){var mouse_target=getMouseTarget(evt),tagName=mouse_target.tagName;if("text"===tagName&&"textedit"!==current_mode){var pt=svgedit.math.transformPoint(evt.pageX,evt.pageY,root_sctm);textActions.select(mouse_target,pt.x,pt.y)}"g"!==tagName&&"a"!==tagName||!svgedit.utilities.getRotationAngle(mouse_target)||(pushGroupProperties(mouse_target),mouse_target=selectedElements[0],clearSelection(!0)),current_group&&leaveContext(),"g"!==parent.tagName&&"a"!==parent.tagName||parent===getCurrentDrawing().getCurrentLayer()||mouse_target===selectorManager.selectorParentGroup||setContext(mouse_target)}},handleLinkInCanvas=function(e){return e.preventDefault(),!1};$(container).mousedown(mouseDown).mousemove(mouseMove).click(handleLinkInCanvas).dblclick(dblClick).mouseup(mouseUp),$(container).bind("mousewheel DOMMouseScroll",function(e){e.preventDefault();var evt=e.originalEvent;root_sctm=$("#svgcontent g")[0].getScreenCTM().inverse();var pt=svgedit.math.transformPoint(evt.pageX,evt.pageY,root_sctm),bbox={x:pt.x,y:pt.y,width:0,height:0},delta=evt.wheelDelta?evt.wheelDelta:evt.detail?-evt.detail:0;delta&&(bbox.factor=Math.max(.75,Math.min(4/3,delta)),call("zoomed",bbox))})}();var preventClickDefault=function(img){$(img).click(function(e){e.preventDefault()})};textActions=canvas.textActions=function(){function setCursor(index){var empty=""===textinput.value;if($(textinput).focus(),!arguments.length)if(empty)index=0;else{if(textinput.selectionEnd!==textinput.selectionStart)return;index=textinput.selectionEnd}var charbb;charbb=chardata[index],empty||textinput.setSelectionRange(index,index),cursor=svgedit.utilities.getElem("text_cursor"),cursor||(cursor=document.createElementNS(NS.SVG,"line"),svgedit.utilities.assignAttributes(cursor,{id:"text_cursor",stroke:"#333","stroke-width":1}),cursor=svgedit.utilities.getElem("selectorParentGroup").appendChild(cursor)),blinker||(blinker=setInterval(function(){var show="none"===cursor.getAttribute("display");cursor.setAttribute("display",show?"inline":"none")},600));var start_pt=ptToScreen(charbb.x,textbb.y),end_pt=ptToScreen(charbb.x,textbb.y+textbb.height);svgedit.utilities.assignAttributes(cursor,{x1:start_pt.x,y1:start_pt.y,x2:end_pt.x,y2:end_pt.y,visibility:"visible",display:"inline"}),selblock&&selblock.setAttribute("d","")}function setSelection(start,end,skipInput){if(start===end)return void setCursor(end);skipInput||textinput.setSelectionRange(start,end),selblock=svgedit.utilities.getElem("text_selectblock"),selblock||(selblock=document.createElementNS(NS.SVG,"path"),svgedit.utilities.assignAttributes(selblock,{id:"text_selectblock",fill:"green",opacity:.5,style:"pointer-events:none"}),svgedit.utilities.getElem("selectorParentGroup").appendChild(selblock));var startbb=chardata[start],endbb=chardata[end];cursor.setAttribute("visibility","hidden");var tl=ptToScreen(startbb.x,textbb.y),tr=ptToScreen(startbb.x+(endbb.x-startbb.x),textbb.y),bl=ptToScreen(startbb.x,textbb.y+textbb.height),br=ptToScreen(startbb.x+(endbb.x-startbb.x),textbb.y+textbb.height),dstr="M"+tl.x+","+tl.y+" L"+tr.x+","+tr.y+" "+br.x+","+br.y+" "+bl.x+","+bl.y+"z";svgedit.utilities.assignAttributes(selblock,{d:dstr,display:"inline"})}function getIndexFromPoint(mouse_x,mouse_y){var pt=svgroot.createSVGPoint();if(pt.x=mouse_x,pt.y=mouse_y,1==chardata.length)return 0;var charpos=curtext.getCharNumAtPosition(pt);0>charpos?(charpos=chardata.length-2,mouse_x<=chardata[0].x&&(charpos=0)):charpos>=chardata.length-2&&(charpos=chardata.length-2);var charbb=chardata[charpos],mid=charbb.x+charbb.width/2;return mouse_x>mid&&charpos++,charpos}function setCursorFromPoint(mouse_x,mouse_y){setCursor(getIndexFromPoint(mouse_x,mouse_y))}function setEndSelectionFromPoint(x,y,apply){var i1=textinput.selectionStart,i2=getIndexFromPoint(x,y),start=Math.min(i1,i2),end=Math.max(i1,i2);setSelection(start,end,!apply)}function screenToPt(x_in,y_in){var out={x:x_in,y:y_in};if(out.x/=current_zoom,out.y/=current_zoom,matrix){var pt=svgedit.math.transformPoint(out.x,out.y,matrix.inverse());out.x=pt.x,out.y=pt.y}return out}function ptToScreen(x_in,y_in){var out={x:x_in,y:y_in};if(matrix){var pt=svgedit.math.transformPoint(out.x,out.y,matrix);out.x=pt.x,out.y=pt.y}return out.x*=current_zoom,out.y*=current_zoom,out}function selectAll(evt){setSelection(0,curtext.textContent.length),$(this).unbind(evt)}function selectWord(evt){if(allow_dbl&&curtext){var ept=svgedit.math.transformPoint(evt.pageX,evt.pageY,root_sctm),mouse_x=ept.x*current_zoom,mouse_y=ept.y*current_zoom,pt=screenToPt(mouse_x,mouse_y),index=getIndexFromPoint(pt.x,pt.y),str=curtext.textContent,first=str.substr(0,index).replace(/[a-z0-9]+$/i,"").length,m=str.substr(index).match(/^[a-z0-9]+/i),last=(m?m[0].length:0)+index;setSelection(first,last),$(evt.target).click(selectAll),setTimeout(function(){$(evt.target).unbind("click",selectAll)},300)}}var curtext,textinput,cursor,selblock,blinker,textbb,matrix,last_x,last_y,allow_dbl,chardata=[];return{select:function(target,x,y){curtext=target,textActions.toEditMode(x,y)},start:function(elem){curtext=elem,textActions.toEditMode()},mouseDown:function(evt,mouse_target,start_x,start_y){var pt=screenToPt(start_x,start_y);textinput.focus(),setCursorFromPoint(pt.x,pt.y),last_x=start_x,last_y=start_y},mouseMove:function(mouse_x,mouse_y){var pt=screenToPt(mouse_x,mouse_y);setEndSelectionFromPoint(pt.x,pt.y)},mouseUp:function(evt,mouse_x,mouse_y){var pt=screenToPt(mouse_x,mouse_y);setEndSelectionFromPoint(pt.x,pt.y,!0),evt.target!==curtext&&last_x+2>mouse_x&&mouse_x>last_x-2&&last_y+2>mouse_y&&mouse_y>last_y-2&&textActions.toSelectMode(!0)},setCursor:setCursor,toEditMode:function(x,y){allow_dbl=!1,current_mode="textedit",selectorManager.requestSelector(curtext).showGrips(!1);selectorManager.requestSelector(curtext).selectorRect;if(textActions.init(),$(curtext).css("cursor","text"),arguments.length){var pt=screenToPt(x,y);setCursorFromPoint(pt.x,pt.y)}else setCursor();setTimeout(function(){allow_dbl=!0},300)},toSelectMode:function(selectElem){current_mode="select",clearInterval(blinker),blinker=null,selblock&&$(selblock).attr("display","none"),cursor&&$(cursor).attr("visibility","hidden"),$(curtext).css("cursor","move"),selectElem&&(clearSelection(),$(curtext).css("cursor","move"),call("selected",[curtext]),addToSelection([curtext],!0)),curtext&&!curtext.textContent.length&&canvas.deleteSelectedElements(),$(textinput).blur(),curtext=!1},setInputElem:function(elem){textinput=elem},clear:function(){"textedit"==current_mode&&textActions.toSelectMode()},init:function(){if(curtext){var i,end;curtext.parentNode||(curtext=selectedElements[0],selectorManager.requestSelector(curtext).showGrips(!1));var str=curtext.textContent,len=str.length,xform=curtext.getAttribute("transform");for(textbb=svgedit.utilities.getBBox(curtext),matrix=xform?svgedit.math.getMatrix(curtext):null,chardata=new Array(len),textinput.focus(),$(curtext).unbind("dblclick",selectWord).dblclick(selectWord),len||(end={x:textbb.x+textbb.width/2,width:0}),i=0;len>i;i++){var start=curtext.getStartPositionOfChar(i);if(end=curtext.getEndPositionOfChar(i),!svgedit.browser.supportsGoodTextCharPos()){var offset=canvas.contentW*current_zoom;start.x-=offset,end.x-=offset,start.x/=current_zoom,end.x/=current_zoom}chardata[i]={x:start.x,y:textbb.y,width:end.x-start.x,height:textbb.height}}chardata.push({x:end.x,width:0}),setSelection(textinput.selectionStart,textinput.selectionEnd,!0)}}}}(),pathActions=canvas.pathActions=function(){function resetD(p){p.setAttribute("d",pathActions.convertPath(p))}var current_path,newPoint,firstCtrl,subpath=!1;svgedit.path.Path.prototype.endChanges=function(text){svgedit.browser.isWebkit()&&resetD(this.elem);var cmd=new svgedit.history.ChangeElementCommand(this.elem,{d:this.last_d},text);addCommandToHistory(cmd),call("changed",[this.elem])},svgedit.path.Path.prototype.addPtsToSelection=function(indexes){var i,seg;for($.isArray(indexes)||(indexes=[indexes]),i=0;i<indexes.length;i++){var index=indexes[i];seg=this.segs[index],seg.ptgrip&&-1==this.selected_pts.indexOf(index)&&index>=0&&this.selected_pts.push(index)}this.selected_pts.sort(),i=this.selected_pts.length;for(var grips=new Array(i);i--;){var pt=this.selected_pts[i];seg=this.segs[pt],seg.select(!0),grips[i]=seg.ptgrip}pathActions.canDeleteNodes=!0,pathActions.closed_subpath=this.subpathIsClosed(this.selected_pts[0]),call("selected",grips)},current_path=null;var drawn_path=null,hasMoved=!1,smoothPolylineIntoPath=function(element){var i,points=element.points,N=points.numberOfItems;if(N>=4){var curpos=points.getItem(0),prevCtlPt=null,d=[];for(d.push(["M",curpos.x,",",curpos.y," C"].join("")),i=1;N-4>=i;i+=3){var ct1=points.getItem(i),ct2=points.getItem(i+1),end=points.getItem(i+2);if(prevCtlPt){var newpts=svgedit.path.smoothControlPoints(prevCtlPt,ct1,curpos);if(newpts&&2==newpts.length){var prevArr=d[d.length-1].split(",");prevArr[2]=newpts[0].x,prevArr[3]=newpts[0].y,d[d.length-1]=prevArr.join(","),ct1=newpts[1]}}d.push([ct1.x,ct1.y,ct2.x,ct2.y,end.x,end.y].join(",")),curpos=end,prevCtlPt=ct2}for(d.push("L");N>i;){var pt=points.getItem(i);d.push([pt.x,pt.y].join(",")),i++}d=d.join(" "),element=addSvgElementFromJson({element:"path",curStyles:!0,attr:{id:getId(),d:d,fill:"none"}})}return element};return{mouseDown:function(evt,mouse_target,start_x,start_y){var id;if("path"!==current_mode){if(svgedit.path.path){svgedit.path.path.storeD(),id=evt.target.id;var cur_pt;if("pathpointgrip_"==id.substr(0,14)){cur_pt=svgedit.path.path.cur_pt=parseInt(id.substr(14)),svgedit.path.path.dragging=[start_x,start_y];var seg=svgedit.path.path.segs[cur_pt];evt.shiftKey?seg.selected?svgedit.path.path.removePtFromSelection(cur_pt):svgedit.path.path.addPtsToSelection(cur_pt):((svgedit.path.path.selected_pts.length<=1||!seg.selected)&&svgedit.path.path.clearSelection(),svgedit.path.path.addPtsToSelection(cur_pt))}else if(0==id.indexOf("ctrlpointgrip_")){svgedit.path.path.dragging=[start_x,start_y];var parts=id.split("_")[1].split("c");cur_pt=Number(parts[0]);var ctrl_num=Number(parts[1]);svgedit.path.path.selectPt(cur_pt,ctrl_num)}svgedit.path.path.dragging||(null==rubberBox&&(rubberBox=selectorManager.getRubberBandBox()),svgedit.utilities.assignAttributes(rubberBox,{x:start_x*current_zoom,y:start_y*current_zoom,width:0,height:0,display:"inline"},100))}}else{mouse_x=start_x,mouse_y=start_y;var x=mouse_x/current_zoom,y=mouse_y/current_zoom,stretchy=svgedit.utilities.getElem("path_stretch_line");newPoint=[x,y],curConfig.gridSnapping&&(x=svgedit.utilities.snapToGrid(x),y=svgedit.utilities.snapToGrid(y),mouse_x=svgedit.utilities.snapToGrid(mouse_x),mouse_y=svgedit.utilities.snapToGrid(mouse_y)),stretchy||(stretchy=document.createElementNS(NS.SVG,"path"),svgedit.utilities.assignAttributes(stretchy,{id:"path_stretch_line",stroke:"#22C","stroke-width":"0.5",fill:"none"}),stretchy=svgedit.utilities.getElem("selectorParentGroup").appendChild(stretchy)),stretchy.setAttribute("display","inline");var index,keep=null;if(drawn_path){for(var seglist=drawn_path.pathSegList,i=seglist.numberOfItems,FUZZ=6/current_zoom,clickOnPoint=!1;i;){i--;var item=seglist.getItem(i),px=item.x,py=item.y;if(x>=px-FUZZ&&px+FUZZ>=x&&y>=py-FUZZ&&py+FUZZ>=y){clickOnPoint=!0;break}}id=getId(),svgedit.path.removePath_(id);var newseg,s_seg,newpath=svgedit.utilities.getElem(id),len=seglist.numberOfItems;if(clickOnPoint){if(1>=i&&len>=2){var abs_x=seglist.getItem(0).x,abs_y=seglist.getItem(0).y;s_seg=stretchy.pathSegList.getItem(1),newseg=4===s_seg.pathSegType?drawn_path.createSVGPathSegLinetoAbs(abs_x,abs_y):drawn_path.createSVGPathSegCurvetoCubicAbs(abs_x,abs_y,s_seg.x1/current_zoom,s_seg.y1/current_zoom,abs_x,abs_y);var endseg=drawn_path.createSVGPathSegClosePath();seglist.appendItem(newseg),seglist.appendItem(endseg)}else if(3>len)return keep=!1;if($(stretchy).remove(),element=newpath,drawn_path=null,started=!1,subpath){svgedit.path.path.matrix&&svgedit.coords.remapElement(newpath,{},svgedit.path.path.matrix.inverse());var new_d=newpath.getAttribute("d"),orig_d=$(svgedit.path.path.elem).attr("d");return $(svgedit.path.path.elem).attr("d",orig_d+new_d),$(newpath).remove(),svgedit.path.path.matrix&&svgedit.path.recalcRotatedPath(),svgedit.path.path.init(),pathActions.toEditMode(svgedit.path.path.elem),svgedit.path.path.selectPt(),!1}}else{if(!$.contains(container,getMouseTarget(evt)))return console.log("Clicked outside canvas"),!1;var num=drawn_path.pathSegList.numberOfItems,last=drawn_path.pathSegList.getItem(num-1),lastx=last.x,lasty=last.y;if(evt.shiftKey){var xya=svgedit.math.snapToAngle(lastx,lasty,x,y);x=xya.x,y=xya.y}s_seg=stretchy.pathSegList.getItem(1),newseg=4===s_seg.pathSegType?drawn_path.createSVGPathSegLinetoAbs(round(x),round(y)):drawn_path.createSVGPathSegCurvetoCubicAbs(round(x),round(y),s_seg.x1/current_zoom,s_seg.y1/current_zoom,s_seg.x2/current_zoom,s_seg.y2/current_zoom),drawn_path.pathSegList.appendItem(newseg),x*=current_zoom,y*=current_zoom,stretchy.setAttribute("d",["M",x,y,x,y].join(" ")),index=num,subpath&&(index+=svgedit.path.path.segs.length),svgedit.path.addPointGrip(index,x,y)}}else d_attr="M"+x+","+y+" ",drawn_path=addSvgElementFromJson({element:"path",curStyles:!0,attr:{d:d_attr,id:getNextId(),opacity:cur_shape.opacity/2}}),stretchy.setAttribute("d",["M",mouse_x,mouse_y,mouse_x,mouse_y].join(" ")),index=subpath?svgedit.path.path.segs.length:0,svgedit.path.addPointGrip(index,mouse_x,mouse_y)}},mouseMove:function(mouse_x,mouse_y){if(hasMoved=!0,"path"!==current_mode)if(svgedit.path.path.dragging){var pt=svgedit.path.getPointFromGrip({x:svgedit.path.path.dragging[0],y:svgedit.path.path.dragging[1]},svgedit.path.path),mpt=svgedit.path.getPointFromGrip({x:mouse_x,y:mouse_y},svgedit.path.path),diff_x=mpt.x-pt.x,diff_y=mpt.y-pt.y;svgedit.path.path.dragging=[mouse_x,mouse_y],svgedit.path.path.dragctrl?svgedit.path.path.moveCtrl(diff_x,diff_y):svgedit.path.path.movePts(diff_x,diff_y)}else svgedit.path.path.selected_pts=[],svgedit.path.path.eachSeg(function(){var seg=this;if(seg.next||seg.prev){var rbb=(seg.item,rubberBox.getBBox()),pt=svgedit.path.getGripPt(seg),pt_bb={x:pt.x,y:pt.y,width:0,height:0},sel=svgedit.math.rectsIntersect(rbb,pt_bb);this.select(sel),sel&&svgedit.path.path.selected_pts.push(seg.index)}});else{if(!drawn_path)return;var seglist=drawn_path.pathSegList,index=seglist.numberOfItems-1;if(newPoint){var pointGrip1=svgedit.path.addCtrlGrip("1c1"),pointGrip2=svgedit.path.addCtrlGrip("0c2");pointGrip1.setAttribute("cx",mouse_x),pointGrip1.setAttribute("cy",mouse_y),pointGrip1.setAttribute("display","inline");var pt_x=newPoint[0],pt_y=newPoint[1],cur_x=(seglist.getItem(index),mouse_x/current_zoom),cur_y=mouse_y/current_zoom,alt_x=pt_x+(pt_x-cur_x),alt_y=pt_y+(pt_y-cur_y);pointGrip2.setAttribute("cx",alt_x*current_zoom),pointGrip2.setAttribute("cy",alt_y*current_zoom),pointGrip2.setAttribute("display","inline");var ctrlLine=svgedit.path.getCtrlLine(1);if(svgedit.utilities.assignAttributes(ctrlLine,{x1:mouse_x,y1:mouse_y,x2:alt_x*current_zoom,y2:alt_y*current_zoom,display:"inline"}),0===index)firstCtrl=[mouse_x,mouse_y];else{var last=seglist.getItem(index-1),last_x=last.x,last_y=last.y;6===last.pathSegType?(last_x+=last_x-last.x2,last_y+=last_y-last.y2):firstCtrl&&(last_x=firstCtrl[0]/current_zoom,last_y=firstCtrl[1]/current_zoom),svgedit.path.replacePathSeg(6,index,[pt_x,pt_y,last_x,last_y,alt_x,alt_y],drawn_path)}}else{var stretchy=svgedit.utilities.getElem("path_stretch_line");if(stretchy){var prev=seglist.getItem(index);if(6===prev.pathSegType){var prev_x=prev.x+(prev.x-prev.x2),prev_y=prev.y+(prev.y-prev.y2);svgedit.path.replacePathSeg(6,1,[mouse_x,mouse_y,prev_x*current_zoom,prev_y*current_zoom,mouse_x,mouse_y],stretchy)}else firstCtrl?svgedit.path.replacePathSeg(6,1,[mouse_x,mouse_y,firstCtrl[0],firstCtrl[1],mouse_x,mouse_y],stretchy):svgedit.path.replacePathSeg(4,1,[mouse_x,mouse_y],stretchy)}}}},mouseUp:function(evt,element){if("path"===current_mode)return newPoint=null,drawn_path||(element=svgedit.utilities.getElem(getId()),started=!1,firstCtrl=null),{keep:!0,element:element};if(svgedit.path.path.dragging){var last_pt=svgedit.path.path.cur_pt;svgedit.path.path.dragging=!1,svgedit.path.path.dragctrl=!1,svgedit.path.path.update(),hasMoved&&svgedit.path.path.endChanges("Move path point(s)"),evt.shiftKey||hasMoved||svgedit.path.path.selectPt(last_pt)}else rubberBox&&"none"!=rubberBox.getAttribute("display")?(rubberBox.setAttribute("display","none"),rubberBox.getAttribute("width")<=2&&rubberBox.getAttribute("height")<=2&&pathActions.toSelectMode(evt.target)):pathActions.toSelectMode(evt.target);hasMoved=!1},toEditMode:function(element){svgedit.path.path=svgedit.path.getPath_(element),current_mode="pathedit",clearSelection(),svgedit.path.path.show(!0).update(),svgedit.path.path.oldbbox=svgedit.utilities.getBBox(svgedit.path.path.elem),subpath=!1},toSelectMode:function(elem){var selPath=elem==svgedit.path.path.elem;current_mode="select",svgedit.path.path.show(!1),current_path=!1,clearSelection(),svgedit.path.path.matrix&&svgedit.path.recalcRotatedPath(),selPath&&(call("selected",[elem]),addToSelection([elem],!0))},addSubPath:function(on){on?(current_mode="path",subpath=!0):(pathActions.clear(!0),pathActions.toEditMode(svgedit.path.path.elem))},select:function(target){current_path===target?(pathActions.toEditMode(target),current_mode="pathedit"):current_path=target},reorient:function(){var elem=selectedElements[0];if(elem){var angle=svgedit.utilities.getRotationAngle(elem);if(0!=angle){var batchCmd=new svgedit.history.BatchCommand("Reorient path"),changes={d:elem.getAttribute("d"),transform:elem.getAttribute("transform")};batchCmd.addSubCommand(new svgedit.history.ChangeElementCommand(elem,changes)),clearSelection(),this.resetOrientation(elem),addCommandToHistory(batchCmd),svgedit.path.getPath_(elem).show(!1).matrix=null,this.clear(),addToSelection([elem],!0),call("changed",selectedElements)}}},clear:function(){if(current_path=null,drawn_path){var elem=svgedit.utilities.getElem(getId());$(svgedit.utilities.getElem("path_stretch_line")).remove(),$(elem).remove(),$(svgedit.utilities.getElem("pathpointgrip_container")).find("*").attr("display","none"),drawn_path=firstCtrl=null,started=!1}else"pathedit"==current_mode&&this.toSelectMode();svgedit.path.path&&svgedit.path.path.init().show(!1)},resetOrientation:function(path){if(null==path||"path"!=path.nodeName)return!1;var tlist=svgedit.transformlist.getTransformList(path),m=svgedit.math.transformListToTransform(tlist).matrix;tlist.clear(),path.removeAttribute("transform");var i,segList=path.pathSegList,len=segList.numberOfItems;for(i=0;len>i;++i){var seg=segList.getItem(i),type=seg.pathSegType;if(1!=type){var pts=[];$.each(["",1,2],function(j,n){var x=seg["x"+n],y=seg["y"+n];if(void 0!==x&&void 0!==y){var pt=svgedit.math.transformPoint(x,y,m);pts.splice(pts.length,0,pt.x,pt.y)}}),svgedit.path.replacePathSeg(type,i,pts,path)}}reorientGrads(path,m)},zoomChange:function(){"pathedit"==current_mode&&svgedit.path.path.update()},getNodePoint:function(){var sel_pt=svgedit.path.path.selected_pts.length?svgedit.path.path.selected_pts[0]:1,seg=svgedit.path.path.segs[sel_pt];return{x:seg.item.x,y:seg.item.y,type:seg.type}},linkControlPoints:function(linkPoints){svgedit.path.setLinkControlPoints(linkPoints)},clonePathNode:function(){svgedit.path.path.storeD();for(var sel_pts=svgedit.path.path.selected_pts,i=(svgedit.path.path.segs,sel_pts.length),nums=[];i--;){var pt=sel_pts[i];svgedit.path.path.addSeg(pt),nums.push(pt+i),nums.push(pt+i+1)}svgedit.path.path.init().addPtsToSelection(nums),svgedit.path.path.endChanges("Clone path node(s)")},opencloseSubPath:function(){var sel_pts=svgedit.path.path.selected_pts;if(1===sel_pts.length){var elem=svgedit.path.path.elem,list=elem.pathSegList,index=(list.numberOfItems,sel_pts[0]),open_pt=null,start_item=null;if(svgedit.path.path.eachSeg(function(i){return 2===this.type&&index>=i&&(start_item=this.item),index>=i?!0:2===this.type?(open_pt=i,!1):1===this.type?(open_pt=!1,!1):void 0}),null==open_pt&&(open_pt=svgedit.path.path.segs.length-1),open_pt!==!1){var newseg=elem.createSVGPathSegLinetoAbs(start_item.x,start_item.y),closer=elem.createSVGPathSegClosePath();return open_pt==svgedit.path.path.segs.length-1?(list.appendItem(newseg),list.appendItem(closer)):(svgedit.path.insertItemBefore(elem,closer,open_pt),svgedit.path.insertItemBefore(elem,newseg,open_pt)),void svgedit.path.path.init().selectPt(open_pt+1)}var seg=svgedit.path.path.segs[index];if(seg.mate)return list.removeItem(index),list.removeItem(index),void svgedit.path.path.init().selectPt(index-1);var i,last_m,z_seg;for(i=0;i<list.numberOfItems;i++){var item=list.getItem(i);if(2===item.pathSegType)last_m=i;else if(i===index)list.removeItem(last_m);else if(1===item.pathSegType&&i>index){z_seg=i-1,list.removeItem(i);break}}for(var num=index-last_m-1;num--;)svgedit.path.insertItemBefore(elem,list.getItem(last_m),z_seg);var pt=list.getItem(last_m);svgedit.path.replacePathSeg(2,last_m,[pt.x,pt.y]),i=index,svgedit.path.path.init().selectPt(0)}},deletePathNode:function(){if(pathActions.canDeleteNodes){svgedit.path.path.storeD();for(var sel_pts=svgedit.path.path.selected_pts,i=sel_pts.length;i--;){var pt=sel_pts[i];svgedit.path.path.deleteSeg(pt)}var cleanup=function(){var segList=svgedit.path.path.elem.pathSegList,len=segList.numberOfItems,remItems=function(pos,count){for(;count--;)segList.removeItem(pos)};if(1>=len)return!0;for(;len--;){var item=segList.getItem(len);if(1===item.pathSegType){var prev=segList.getItem(len-1),nprev=segList.getItem(len-2);if(2===prev.pathSegType){remItems(len-1,2),cleanup();break}if(2===nprev.pathSegType){remItems(len-2,3),cleanup();break}}else if(2===item.pathSegType&&len>0){var prev_type=segList.getItem(len-1).pathSegType;if(2===prev_type){remItems(len-1,1),cleanup();break}if(1===prev_type&&segList.numberOfItems-1===len){remItems(len,1),cleanup();break}}}return!1};if(cleanup(),svgedit.path.path.elem.pathSegList.numberOfItems<=1)return pathActions.toSelectMode(svgedit.path.path.elem),void canvas.deleteSelectedElements();if(svgedit.path.path.init(),svgedit.path.path.clearSelection(),window.opera){var cp=$(svgedit.path.path.elem);cp.attr("d",cp.attr("d"))}svgedit.path.path.endChanges("Delete path node(s)")}},smoothPolylineIntoPath:smoothPolylineIntoPath,setSegType:function(v){svgedit.path.path.setSegType(v)},moveNode:function(attr,newValue){var sel_pts=svgedit.path.path.selected_pts;if(sel_pts.length){svgedit.path.path.storeD();var seg=svgedit.path.path.segs[sel_pts[0]],diff={x:0,y:0};diff[attr]=newValue-seg.item[attr],seg.move(diff.x,diff.y),svgedit.path.path.endChanges("Move path point")
}},fixEnd:function(elem){var i,last_m,segList=elem.pathSegList,len=segList.numberOfItems;for(i=0;len>i;++i){var item=segList.getItem(i);if(2===item.pathSegType&&(last_m=item),1===item.pathSegType){var prev=segList.getItem(i-1);if(prev.x!=last_m.x||prev.y!=last_m.y){var newseg=elem.createSVGPathSegLinetoAbs(last_m.x,last_m.y);svgedit.path.insertItemBefore(elem,newseg,i),pathActions.fixEnd(elem);break}}}svgedit.browser.isWebkit()&&resetD(elem)},convertPath:function(path,toRel){var i,segList=path.pathSegList,len=segList.numberOfItems,curx=0,cury=0,d="",last_m=null;for(i=0;len>i;++i){var seg=segList.getItem(i),x=seg.x||0,y=seg.y||0,x1=seg.x1||0,y1=seg.y1||0,x2=seg.x2||0,y2=seg.y2||0,type=seg.pathSegType,letter=pathMap[type]["to"+(toRel?"Lower":"Upper")+"Case"](),addToD=function(pnts,more,last){more=more?" "+more.join(" "):"",last=last?" "+svgedit.units.shortFloat(last):"",$.each(pnts,function(i,pnt){pnts[i]=svgedit.units.shortFloat(pnt)}),d+=letter+pnts.join(" ")+more+last};switch(type){case 1:d+="z";break;case 12:x-=curx;case 13:toRel?(curx+=x,letter="l"):(x+=curx,curx=x,letter="L"),addToD([[x,cury]]);break;case 14:y-=cury;case 15:toRel?(cury+=y,letter="l"):(y+=cury,cury=y,letter="L"),addToD([[curx,y]]);break;case 2:case 4:case 18:x-=curx,y-=cury;case 5:case 3:last_m&&1===segList.getItem(i-1).pathSegType&&!toRel&&(curx=last_m[0],cury=last_m[1]);case 19:toRel?(curx+=x,cury+=y):(x+=curx,y+=cury,curx=x,cury=y),3===type&&(last_m=[curx,cury]),addToD([[x,y]]);break;case 6:x-=curx,x1-=curx,x2-=curx,y-=cury,y1-=cury,y2-=cury;case 7:toRel?(curx+=x,cury+=y):(x+=curx,x1+=curx,x2+=curx,y+=cury,y1+=cury,y2+=cury,curx=x,cury=y),addToD([[x1,y1],[x2,y2],[x,y]]);break;case 8:x-=curx,x1-=curx,y-=cury,y1-=cury;case 9:toRel?(curx+=x,cury+=y):(x+=curx,x1+=curx,y+=cury,y1+=cury,curx=x,cury=y),addToD([[x1,y1],[x,y]]);break;case 10:x-=curx,y-=cury;case 11:toRel?(curx+=x,cury+=y):(x+=curx,y+=cury,curx=x,cury=y),addToD([[seg.r1,seg.r2]],[seg.angle,seg.largeArcFlag?1:0,seg.sweepFlag?1:0],[x,y]);break;case 16:x-=curx,x2-=curx,y-=cury,y2-=cury;case 17:toRel?(curx+=x,cury+=y):(x+=curx,x2+=curx,y+=cury,y2+=cury,curx=x,cury=y),addToD([[x2,y2],[x,y]])}}return d}}}();var removeUnusedDefElems=this.removeUnusedDefElems=function(){var defs=svgcontent.getElementsByTagNameNS(NS.SVG,"defs");if(!defs||!defs.length)return 0;var i,j,defelem_uses=[],numRemoved=0,attrs=["fill","stroke","filter","marker-start","marker-mid","marker-end"],alen=attrs.length,all_els=svgcontent.getElementsByTagNameNS(NS.SVG,"*"),all_len=all_els.length;for(i=0;all_len>i;i++){var el=all_els[i];for(j=0;alen>j;j++){var ref=svgedit.utilities.getUrlFromAttr(el.getAttribute(attrs[j]));ref&&defelem_uses.push(ref.substr(1))}var href=getHref(el);href&&0===href.indexOf("#")&&defelem_uses.push(href.substr(1))}var defelems=$(defs).find("linearGradient, radialGradient, filter, marker, svg, symbol");for(i=defelems.length;i--;){var defelem=defelems[i],id=defelem.id;defelem_uses.indexOf(id)<0&&(removedElements[id]=defelem,defelem.parentNode.removeChild(defelem),numRemoved++)}return numRemoved};this.svgCanvasToString=function(){for(;removeUnusedDefElems()>0;);pathActions.clear(!0),$.each(svgcontent.childNodes,function(i,node){i&&8===node.nodeType&&node.data.indexOf("Created with")>=0&&svgcontent.insertBefore(node,svgcontent.firstChild)}),current_group&&(leaveContext(),selectOnly([current_group]));var naked_svgs=[];$(svgcontent).find("g:data(gsvg)").each(function(){var i,attrs=this.attributes,len=attrs.length;for(i=0;len>i;i++)("id"==attrs[i].nodeName||"style"==attrs[i].nodeName)&&len--;if(0>=len){var svg=this.firstChild;naked_svgs.push(svg),$(this).replaceWith(svg)}});var output=this.svgToString(svgcontent,0);return naked_svgs.length&&$(naked_svgs).each(function(){groupSvgElem(this)}),output},this.svgToString=function(elem,indent){var out=[],toXml=svgedit.utilities.toXml,unit=curConfig.baseUnit,unit_re=new RegExp("^-?[\\d\\.]+"+unit+"$");if(elem){cleanupElement(elem);var attr,i,attrs=elem.attributes,childs=elem.childNodes;for(i=0;indent>i;i++)out.push(" ");if(out.push("<"),out.push(elem.nodeName),"svgcontent"===elem.id){var res=getResolution(),vb="";"px"!==unit&&(res.w=svgedit.units.convertUnit(res.w,unit)+unit,res.h=svgedit.units.convertUnit(res.h,unit)+unit),out.push(' width="'+res.w+'" height="'+res.h+'"'+vb+' xmlns="'+NS.SVG+'"');var nsuris={};$(elem).find("*").andSelf().each(function(){var uri=this.namespaceURI;uri&&!nsuris[uri]&&nsMap[uri]&&"xmlns"!==nsMap[uri]&&"xml"!==nsMap[uri]&&(nsuris[uri]=!0,out.push(" xmlns:"+nsMap[uri]+'="'+uri+'"')),$.each(this.attributes,function(i,attr){var uri=attr.namespaceURI;uri&&!nsuris[uri]&&"xmlns"!==nsMap[uri]&&"xml"!==nsMap[uri]&&(nsuris[uri]=!0,out.push(" xmlns:"+nsMap[uri]+'="'+uri+'"'))})}),i=attrs.length;for(var attr_names=["width","height","xmlns","x","y","viewBox","id","overflow"];i--;){attr=attrs.item(i);var attrVal=toXml(attr.value);0!==attr.nodeName.indexOf("xmlns:")&&""!=attrVal&&-1==attr_names.indexOf(attr.localName)&&(!attr.namespaceURI||nsMap[attr.namespaceURI])&&(out.push(" "),out.push(attr.nodeName),out.push('="'),out.push(attrVal),out.push('"'))}}else{if("defs"===elem.nodeName&&!elem.firstChild)return;var moz_attrs=["-moz-math-font-style","_moz-math-font-style"];for(i=attrs.length-1;i>=0;i--){attr=attrs.item(i);var attrVal=toXml(attr.value);if(!(moz_attrs.indexOf(attr.localName)>=0)&&""!=attrVal){if(0===attrVal.indexOf("pointer-events"))continue;if("class"===attr.localName&&0===attrVal.indexOf("se_"))continue;if(out.push(" "),"d"===attr.localName&&(attrVal=pathActions.convertPath(elem,!0)),isNaN(attrVal)?unit_re.test(attrVal)&&(attrVal=svgedit.units.shortFloat(attrVal)+unit):attrVal=svgedit.units.shortFloat(attrVal),save_options.apply&&"image"===elem.nodeName&&"href"===attr.localName&&save_options.images&&"embed"===save_options.images){var img=encodableImages[attrVal];img&&(attrVal=img)}(!attr.namespaceURI||attr.namespaceURI==NS.SVG||nsMap[attr.namespaceURI])&&(out.push(attr.nodeName),out.push('="'),out.push(attrVal),out.push('"'))}}}if(elem.hasChildNodes()){out.push(">"),indent++;var bOneLine=!1;for(i=0;i<childs.length;i++){var child=childs.item(i);switch(child.nodeType){case 1:out.push("\n"),out.push(this.svgToString(childs.item(i),indent));break;case 3:var str=child.nodeValue.replace(/^\s+|\s+$/g,"");""!=str&&(bOneLine=!0,out.push(String(toXml(str))));break;case 4:out.push("\n"),out.push(new Array(indent+1).join(" ")),out.push("<![CDATA["),out.push(child.nodeValue),out.push("]]>");break;case 8:out.push("\n"),out.push(new Array(indent+1).join(" ")),out.push("<!--"),out.push(child.data),out.push("-->")}}if(indent--,!bOneLine)for(out.push("\n"),i=0;indent>i;i++)out.push(" ");out.push("</"),out.push(elem.nodeName),out.push(">")}else out.push("/>")}return out.join("")},this.embedImage=function(val,callback){$(new Image).load(function(){var canvas=document.createElement("canvas");canvas.width=this.width,canvas.height=this.height,canvas.getContext("2d").drawImage(this,0,0);try{var urldata=";svgedit_url="+encodeURIComponent(val);urldata=canvas.toDataURL().replace(";base64",urldata+";base64"),encodableImages[val]=urldata}catch(e){encodableImages[val]=!1}last_good_img_url=val,callback&&callback(encodableImages[val])}).attr("src",val)},this.setGoodImage=function(val){last_good_img_url=val},this.open=function(){},this.save=function(opts){clearSelection(),opts&&$.extend(save_options,opts),save_options.apply=!0;var str=this.svgCanvasToString();call("saved",str)},this.rasterExport=function(imgType,quality,exportWindowName){var mimeType="image/"+imgType.toLowerCase();clearSelection();var issues=[],issue_list={feGaussianBlur:uiStrings.exportNoBlur,foreignObject:uiStrings.exportNoforeignObject,"[stroke-dasharray]":uiStrings.exportNoDashArray},content=$(svgcontent);"font"in $("<canvas>")[0].getContext("2d")||(issue_list.text=uiStrings.exportNoText),$.each(issue_list,function(sel,descr){content.find(sel).length&&issues.push(descr)});var str=this.svgCanvasToString();call("exported",{svg:str,issues:issues,type:imgType,mimeType:mimeType,quality:quality,exportWindowName:exportWindowName})},this.getSvgString=function(){return save_options.apply=!1,this.svgCanvasToString()},this.randomizeIds=function(enableRandomization){arguments.length>0&&0==enableRandomization?svgedit.draw.randomizeIds(!1,getCurrentDrawing()):svgedit.draw.randomizeIds(!0,getCurrentDrawing())};var uniquifyElems=this.uniquifyElems=function(g){var ids={},ref_elems=["filter","linearGradient","pattern","radialGradient","symbol","textPath","use"];svgedit.utilities.walkTree(g,function(n){if(1==n.nodeType){n.id&&(n.id in ids||(ids[n.id]={elem:null,attrs:[],hrefs:[]}),ids[n.id].elem=n),$.each(ref_attrs,function(i,attr){var attrnode=n.getAttributeNode(attr);if(attrnode){var url=svgedit.utilities.getUrlFromAttr(attrnode.value),refid=url?url.substr(1):null;refid&&(refid in ids||(ids[refid]={elem:null,attrs:[],hrefs:[]}),ids[refid].attrs.push(attrnode))}});var href=svgedit.utilities.getHref(n);if(href&&ref_elems.indexOf(n.nodeName)>=0){var refid=href.substr(1);refid&&(refid in ids||(ids[refid]={elem:null,attrs:[],hrefs:[]}),ids[refid].hrefs.push(n))}}});var oldid;for(oldid in ids)if(oldid){var elem=ids[oldid].elem;if(elem){var newid=getNextId();elem.id=newid;for(var attrs=ids[oldid].attrs,j=attrs.length;j--;){var attr=attrs[j];attr.ownerElement.setAttribute(attr.name,"url(#"+newid+")")}for(var hreffers=ids[oldid].hrefs,k=hreffers.length;k--;){var hreffer=hreffers[k];svgedit.utilities.setHref(hreffer,"#"+newid)}}}},setUseData=this.setUseData=function(parent){var elems=$(parent);"use"!==parent.tagName&&(elems=elems.find("use")),elems.each(function(){var id=getHref(this).substr(1),ref_elem=svgedit.utilities.getElem(id);ref_elem&&($(this).data("ref",ref_elem),("symbol"==ref_elem.tagName||"svg"==ref_elem.tagName)&&$(this).data("symbol",ref_elem).data("ref",ref_elem))})},convertGradients=this.convertGradients=function(elem){var elems=$(elem).find("linearGradient, radialGradient");!elems.length&&svgedit.browser.isWebkit()&&(elems=$(elem).find("*").filter(function(){return this.tagName.indexOf("Gradient")>=0})),elems.each(function(){var grad=this;if("userSpaceOnUse"===$(grad).attr("gradientUnits")){var elems=$(svgcontent).find('[fill="url(#'+grad.id+')"],[stroke="url(#'+grad.id+')"]');if(!elems.length)return;var bb=svgedit.utilities.getBBox(elems[0]);if(!bb)return;if("linearGradient"===grad.tagName){var g_coords=$(grad).attr(["x1","y1","x2","y2"]),tlist=grad.gradientTransform.baseVal;if(tlist&&tlist.numberOfItems>0){var m=svgedit.math.transformListToTransform(tlist).matrix,pt1=svgedit.math.transformPoint(g_coords.x1,g_coords.y1,m),pt2=svgedit.math.transformPoint(g_coords.x2,g_coords.y2,m);g_coords.x1=pt1.x,g_coords.y1=pt1.y,g_coords.x2=pt2.x,g_coords.y2=pt2.y,grad.removeAttribute("gradientTransform")}$(grad).attr({x1:(g_coords.x1-bb.x)/bb.width,y1:(g_coords.y1-bb.y)/bb.height,x2:(g_coords.x2-bb.x)/bb.width,y2:(g_coords.y2-bb.y)/bb.height}),grad.removeAttribute("gradientUnits")}}})},convertToGroup=this.convertToGroup=function(elem){elem||(elem=selectedElements[0]);var ts,$elem=$(elem),batchCmd=new svgedit.history.BatchCommand;if($elem.data("gsvg")){var svg=elem.firstChild,pt=$(svg).attr(["x","y"]);$(elem.firstChild.firstChild).unwrap(),$(elem).removeData("gsvg");var tlist=svgedit.transformlist.getTransformList(elem),xform=svgroot.createSVGTransform();xform.setTranslate(pt.x,pt.y),tlist.appendItem(xform),svgedit.recalculate.recalculateDimensions(elem),call("selected",[elem])}else if($elem.data("symbol")){elem=$elem.data("symbol"),ts=$elem.attr("transform");var pos=$elem.attr(["x","y"]),vb=elem.getAttribute("viewBox");if(vb){var nums=vb.split(" ");pos.x-=+nums[0],pos.y-=+nums[1]}ts+=" translate("+(pos.x||0)+","+(pos.y||0)+")";var prev=$elem.prev();batchCmd.addSubCommand(new svgedit.history.RemoveElementCommand($elem[0],$elem[0].nextSibling,$elem[0].parentNode)),$elem.remove();var i,has_more=$(svgcontent).find("use:data(symbol)").length,g=svgdoc.createElementNS(NS.SVG,"g"),childs=elem.childNodes;for(i=0;i<childs.length;i++)g.appendChild(childs[i].cloneNode(!0));if(svgedit.browser.isGecko()){var dupeGrads=$(svgedit.utilities.findDefs()).children("linearGradient,radialGradient,pattern").clone();$(g).append(dupeGrads)}ts&&g.setAttribute("transform",ts);var parent=elem.parentNode;if(uniquifyElems(g),svgedit.browser.isGecko()&&$(findDefs()).append($(g).find("linearGradient,radialGradient,pattern")),g.id=getNextId(),prev.after(g),parent){if(!has_more){var nextSibling=elem.nextSibling;parent.removeChild(elem),batchCmd.addSubCommand(new svgedit.history.RemoveElementCommand(elem,nextSibling,parent))}batchCmd.addSubCommand(new svgedit.history.InsertElementCommand(g))}setUseData(g),convertGradients(svgedit.browser.isGecko()?svgedit.utilities.findDefs():g),svgedit.utilities.walkTreePost(g,function(n){try{svgedit.recalculate.recalculateDimensions(n)}catch(e){console.log(e)}}),$(g).find(visElems).each(function(){this.id||(this.id=getNextId())}),selectOnly([g]);var cm=pushGroupProperties(g,!0);cm&&batchCmd.addSubCommand(cm),addCommandToHistory(batchCmd)}else console.log("Unexpected element to ungroup:",elem)};this.setSvgString=function(xmlString){try{var newDoc=svgedit.utilities.text2xml(xmlString);this.prepareSvg(newDoc);var batchCmd=new svgedit.history.BatchCommand("Change Source"),nextSibling=svgcontent.nextSibling,oldzoom=svgroot.removeChild(svgcontent);batchCmd.addSubCommand(new svgedit.history.RemoveElementCommand(oldzoom,nextSibling,svgroot)),svgcontent=svgdoc.adoptNode?svgdoc.adoptNode(newDoc.documentElement):svgdoc.importNode(newDoc.documentElement,!0),svgroot.appendChild(svgcontent);var content=$(svgcontent);canvas.current_drawing_=new svgedit.draw.Drawing(svgcontent,idprefix);var nonce=getCurrentDrawing().getNonce();nonce?call("setnonce",nonce):call("unsetnonce"),content.find("image").each(function(){var image=this;preventClickDefault(image);var val=getHref(this);if(val){if(0===val.indexOf("data:")){var m=val.match(/svgedit_url=(.*?);/);if(m){var url=decodeURIComponent(m[1]);$(new Image).load(function(){image.setAttributeNS(NS.XLINK,"xlink:href",url)}).attr("src",url)}}canvas.embedImage(val)}}),content.find("svg").each(function(){if(!$(this).closest("defs").length){uniquifyElems(this);var pa=this.parentNode;1===pa.childNodes.length&&"g"===pa.nodeName?($(pa).data("gsvg",this),pa.id=pa.id||getNextId()):groupSvgElem(this)}}),svgedit.browser.isGecko()&&content.find("linearGradient, radialGradient, pattern").appendTo(svgedit.utilities.findDefs()),setUseData(content),convertGradients(content[0]),svgedit.utilities.walkTreePost(svgcontent,function(n){try{svgedit.recalculate.recalculateDimensions(n)}catch(e){console.log(e)}});var attrs={id:"svgcontent",overflow:curConfig.show_outside_canvas?"visible":"hidden"},percs=!1;if(content.attr("viewBox")){var vb=content.attr("viewBox").split(" ");attrs.width=vb[2],attrs.height=vb[3]}else $.each(["width","height"],function(i,dim){var val=content.attr(dim);val||(val="100%"),"%"===String(val).substr(-1)?percs=!0:attrs[dim]=svgedit.units.convertToNum(dim,val)});if(identifyLayers(),content.children().find(visElems).each(function(){this.id||(this.id=getNextId())}),percs){var bb=getStrokedBBox();attrs.width=bb.width+bb.x,attrs.height=bb.height+bb.y}attrs.width<=0&&(attrs.width=100),attrs.height<=0&&(attrs.height=100),content.attr(attrs),this.contentW=attrs.width,this.contentH=attrs.height,batchCmd.addSubCommand(new svgedit.history.InsertElementCommand(svgcontent));var changes=content.attr(["width","height"]);batchCmd.addSubCommand(new svgedit.history.ChangeElementCommand(svgroot,changes)),current_zoom=1,svgedit.transformlist.resetListMap(),clearSelection(),svgedit.path.clearData(),svgroot.appendChild(selectorManager.selectorParentGroup),addCommandToHistory(batchCmd),call("changed",[svgcontent])}catch(e){return console.log(e),!1}return!0},this.importSvgString=function(xmlString){var j,ts;try{var uid=svgedit.utilities.encode64(xmlString.length+xmlString).substr(0,32),useExisting=!1;import_ids[uid]&&$(import_ids[uid].symbol).parents("#svgroot").length&&(useExisting=!0);var symbol,batchCmd=new svgedit.history.BatchCommand("Import SVG");if(useExisting)symbol=import_ids[uid].symbol,ts=import_ids[uid].xform;else{var newDoc=svgedit.utilities.text2xml(xmlString);this.prepareSvg(newDoc);var svg;svg=svgdoc.adoptNode?svgdoc.adoptNode(newDoc.documentElement):svgdoc.importNode(newDoc.documentElement,!0),uniquifyElems(svg);var innerw=svgedit.units.convertToNum("width",svg.getAttribute("width")),innerh=svgedit.units.convertToNum("height",svg.getAttribute("height")),innervb=svg.getAttribute("viewBox"),vb=innervb?innervb.split(" "):[0,0,innerw,innerh];for(j=0;4>j;++j)vb[j]=+vb[j];var canvash=(+svgcontent.getAttribute("width"),+svgcontent.getAttribute("height"));ts=innerh>innerw?"scale("+canvash/3/vb[3]+")":"scale("+canvash/3/vb[2]+")",ts="translate(0) "+ts+" translate(0)",symbol=svgdoc.createElementNS(NS.SVG,"symbol");var defs=svgedit.utilities.findDefs();for(svgedit.browser.isGecko()&&$(svg).find("linearGradient, radialGradient, pattern").appendTo(defs);svg.firstChild;){var first=svg.firstChild;symbol.appendChild(first)}var i,attrs=svg.attributes;for(i=0;i<attrs.length;i++){var attr=attrs[i];symbol.setAttribute(attr.nodeName,attr.value)}symbol.id=getNextId(),import_ids[uid]={symbol:symbol,xform:ts},svgedit.utilities.findDefs().appendChild(symbol),batchCmd.addSubCommand(new svgedit.history.InsertElementCommand(symbol))}var use_el=svgdoc.createElementNS(NS.SVG,"use");use_el.id=getNextId(),setHref(use_el,"#"+symbol.id),(current_group||getCurrentDrawing().getCurrentLayer()).appendChild(use_el),batchCmd.addSubCommand(new svgedit.history.InsertElementCommand(use_el)),clearSelection(),use_el.setAttribute("transform",ts),svgedit.recalculate.recalculateDimensions(use_el),$(use_el).data("symbol",symbol).data("ref",symbol),addToSelection([use_el]),addCommandToHistory(batchCmd),call("changed",[svgcontent])}catch(e){return console.log(e),!1}return!0};var identifyLayers=canvas.identifyLayers=function(){leaveContext(),getCurrentDrawing().identifyLayers()};this.createLayer=function(name){var batchCmd=new svgedit.history.BatchCommand("Create Layer"),new_layer=getCurrentDrawing().createLayer(name);batchCmd.addSubCommand(new svgedit.history.InsertElementCommand(new_layer)),addCommandToHistory(batchCmd),clearSelection(),call("changed",[new_layer])},this.cloneLayer=function(name){var batchCmd=new svgedit.history.BatchCommand("Duplicate Layer"),new_layer=svgdoc.createElementNS(NS.SVG,"g"),layer_title=svgdoc.createElementNS(NS.SVG,"title");layer_title.textContent=name,new_layer.appendChild(layer_title);var current_layer=getCurrentDrawing().getCurrentLayer();$(current_layer).after(new_layer);var i,childs=current_layer.childNodes;for(i=0;i<childs.length;i++){var ch=childs[i];"title"!=ch.localName&&new_layer.appendChild(copyElem(ch))}clearSelection(),identifyLayers(),batchCmd.addSubCommand(new svgedit.history.InsertElementCommand(new_layer)),addCommandToHistory(batchCmd),canvas.setCurrentLayer(name),call("changed",[new_layer])},this.deleteCurrentLayer=function(){var current_layer=getCurrentDrawing().getCurrentLayer(),nextSibling=current_layer.nextSibling,parent=current_layer.parentNode;if(current_layer=getCurrentDrawing().deleteCurrentLayer()){var batchCmd=new svgedit.history.BatchCommand("Delete Layer");return batchCmd.addSubCommand(new svgedit.history.RemoveElementCommand(current_layer,nextSibling,parent)),addCommandToHistory(batchCmd),clearSelection(),call("changed",[parent]),!0}return!1},this.setCurrentLayer=function(name){var result=getCurrentDrawing().setCurrentLayer(svgedit.utilities.toXml(name));return result&&clearSelection(),result},this.renameCurrentLayer=function(newname){var i,drawing=getCurrentDrawing();if(drawing.current_layer){var oldLayer=drawing.current_layer;if(!canvas.setCurrentLayer(newname)){var batchCmd=new svgedit.history.BatchCommand("Rename Layer");for(i=0;i<drawing.getNumLayers()&&drawing.all_layers[i][1]!=oldLayer;++i);var oldname=drawing.getLayerName(i);drawing.all_layers[i][0]=svgedit.utilities.toXml(newname);var len=oldLayer.childNodes.length;for(i=0;len>i;++i){var child=oldLayer.childNodes.item(i);if(child&&"title"==child.tagName){for(;child.firstChild;)child.removeChild(child.firstChild);return child.textContent=newname,batchCmd.addSubCommand(new svgedit.history.ChangeElementCommand(child,{"#text":oldname})),addCommandToHistory(batchCmd),call("changed",[oldLayer]),!0}}}drawing.current_layer=oldLayer}return!1},this.setCurrentLayerPosition=function(newpos){var oldpos,drawing=getCurrentDrawing();if(drawing.current_layer&&newpos>=0&&newpos<drawing.getNumLayers()){for(oldpos=0;oldpos<drawing.getNumLayers()&&drawing.all_layers[oldpos][1]!=drawing.current_layer;++oldpos);if(oldpos==drawing.getNumLayers())return!1;if(oldpos!=newpos){var refLayer=null,oldNextSibling=drawing.current_layer.nextSibling;return newpos>oldpos?newpos<drawing.getNumLayers()-1&&(refLayer=drawing.all_layers[newpos+1][1]):refLayer=drawing.all_layers[newpos][1],svgcontent.insertBefore(drawing.current_layer,refLayer),addCommandToHistory(new svgedit.history.MoveElementCommand(drawing.current_layer,oldNextSibling,svgcontent)),identifyLayers(),canvas.setCurrentLayer(drawing.getLayerName(newpos)),!0}}return!1},this.setLayerVisibility=function(layername,bVisible){var drawing=getCurrentDrawing(),prevVisibility=drawing.getLayerVisibility(layername),layer=drawing.setLayerVisibility(layername,bVisible);if(!layer)return!1;var oldDisplay=prevVisibility?"inline":"none";return addCommandToHistory(new svgedit.history.ChangeElementCommand(layer,{display:oldDisplay},"Layer Visibility")),layer==drawing.getCurrentLayer()&&(clearSelection(),pathActions.clear()),!0},this.moveSelectedToLayer=function(layername){var i,layer=null,drawing=getCurrentDrawing();for(i=0;i<drawing.getNumLayers();++i)if(drawing.getLayerName(i)==layername){layer=drawing.all_layers[i][1];break}if(!layer)return!1;var batchCmd=new svgedit.history.BatchCommand("Move Elements to Layer"),selElems=selectedElements;for(i=selElems.length;i--;){var elem=selElems[i];if(elem){var oldNextSibling=elem.nextSibling,oldLayer=elem.parentNode;layer.appendChild(elem),batchCmd.addSubCommand(new svgedit.history.MoveElementCommand(elem,oldNextSibling,oldLayer))}}return addCommandToHistory(batchCmd),!0},this.mergeLayer=function(skipHistory){var batchCmd=new svgedit.history.BatchCommand("Merge Layer"),drawing=getCurrentDrawing(),prev=$(drawing.current_layer).prev()[0];if(prev){var childs=drawing.current_layer.childNodes,layerNextSibling=(childs.length,drawing.current_layer.nextSibling);for(batchCmd.addSubCommand(new svgedit.history.RemoveElementCommand(drawing.current_layer,layerNextSibling,svgcontent));drawing.current_layer.firstChild;){var ch=drawing.current_layer.firstChild;if("title"!=ch.localName){var oldNextSibling=ch.nextSibling;prev.appendChild(ch),batchCmd.addSubCommand(new svgedit.history.MoveElementCommand(ch,oldNextSibling,drawing.current_layer))}else{var chNextSibling=ch.nextSibling;batchCmd.addSubCommand(new svgedit.history.RemoveElementCommand(ch,chNextSibling,drawing.current_layer)),drawing.current_layer.removeChild(ch)}}return svgcontent.removeChild(drawing.current_layer),skipHistory||(clearSelection(),identifyLayers(),call("changed",[svgcontent]),addCommandToHistory(batchCmd)),drawing.current_layer=prev,batchCmd}},this.mergeAllLayers=function(){var batchCmd=new svgedit.history.BatchCommand("Merge all Layers"),drawing=getCurrentDrawing();for(drawing.current_layer=drawing.all_layers[drawing.getNumLayers()-1][1];$(svgcontent).children("g").length>1;)batchCmd.addSubCommand(canvas.mergeLayer(!0));clearSelection(),identifyLayers(),call("changed",[svgcontent]),addCommandToHistory(batchCmd)};var leaveContext=this.leaveContext=function(){var i,len=disabled_elems.length;if(len){for(i=0;len>i;i++){var elem=disabled_elems[i],orig=elData(elem,"orig_opac");1!==orig?elem.setAttribute("opacity",orig):elem.removeAttribute("opacity"),elem.setAttribute("style","pointer-events: inherit")}disabled_elems=[],clearSelection(!0),call("contextset",null)}current_group=null},setContext=this.setContext=function(elem){leaveContext(),"string"==typeof elem&&(elem=svgedit.utilities.getElem(elem)),current_group=elem,$(elem).parentsUntil("#svgcontent").andSelf().siblings().each(function(){var opac=this.getAttribute("opacity")||1;elData(this,"orig_opac",opac),this.setAttribute("opacity",.33*opac),this.setAttribute("style","pointer-events: none"),disabled_elems.push(this)}),clearSelection(),call("contextset",current_group)};this.clear=function(){pathActions.clear(),clearSelection(),canvas.clearSvgContentElement(),canvas.current_drawing_=new svgedit.draw.Drawing(svgcontent),canvas.createLayer("Layer 1"),canvas.undoMgr.resetUndoStack(),selectorManager.initGroup(),rubberBox=selectorManager.getRubberBandBox(),call("cleared")},this.linkControlPoints=pathActions.linkControlPoints,this.getContentElem=function(){return svgcontent},this.getRootElem=function(){return svgroot},this.getSelectedElems=function(){return selectedElements};var getResolution=this.getResolution=function(){var width=svgcontent.getAttribute("width")/current_zoom,height=svgcontent.getAttribute("height")/current_zoom;return{w:width,h:height,zoom:current_zoom}};this.getZoom=function(){return current_zoom},this.getVersion=function(){return"svgcanvas.js ($Rev: 2840 $)"},this.setUiStrings=function(strs){$.extend(uiStrings,strs.notification)},this.setConfig=function(opts){$.extend(curConfig,opts)},this.getTitle=function(elem){var i;if(elem=elem||selectedElements[0]){elem=$(elem).data("gsvg")||$(elem).data("symbol")||elem;var childs=elem.childNodes;for(i=0;i<childs.length;i++)if("title"==childs[i].nodeName)return childs[i].textContent;return""}},this.setGroupTitle=function(val){var elem=selectedElements[0];elem=$(elem).data("gsvg")||elem;var ts=$(elem).children("title"),batchCmd=new svgedit.history.BatchCommand("Set Label");if(val.length)if(ts.length){var title=ts[0];batchCmd.addSubCommand(new svgedit.history.ChangeElementCommand(title,{"#text":title.textContent})),title.textContent=val}else title=svgdoc.createElementNS(NS.SVG,"title"),title.textContent=val,$(elem).prepend(title),batchCmd.addSubCommand(new svgedit.history.InsertElementCommand(title));else{var tsNextSibling=ts.nextSibling;batchCmd.addSubCommand(new svgedit.history.RemoveElementCommand(ts[0],tsNextSibling,elem)),ts.remove()}addCommandToHistory(batchCmd)},this.getDocumentTitle=function(){return canvas.getTitle(svgcontent)},this.setDocumentTitle=function(newtitle){var i,childs=svgcontent.childNodes,doc_title=!1,old_title="",batchCmd=new svgedit.history.BatchCommand("Change Image Title");for(i=0;i<childs.length;i++)if("title"==childs[i].nodeName){doc_title=childs[i],old_title=doc_title.textContent;break}doc_title||(doc_title=svgdoc.createElementNS(NS.SVG,"title"),svgcontent.insertBefore(doc_title,svgcontent.firstChild)),newtitle.length?doc_title.textContent=newtitle:doc_title.parentNode.removeChild(doc_title),batchCmd.addSubCommand(new svgedit.history.ChangeElementCommand(doc_title,{"#text":old_title})),addCommandToHistory(batchCmd)},this.getEditorNS=function(add){return add&&svgcontent.setAttribute("xmlns:se",NS.SE),NS.SE},this.setResolution=function(x,y){var batchCmd,res=getResolution(),w=res.w,h=res.h;if("fit"==x){var bbox=getStrokedBBox();if(!bbox)return!1;batchCmd=new svgedit.history.BatchCommand("Fit Canvas to Content");var visEls=getVisibleElements();addToSelection(visEls);var dx=[],dy=[];$.each(visEls,function(){dx.push(-1*bbox.x),dy.push(-1*bbox.y)});var cmd=canvas.moveSelectedElements(dx,dy,!0);batchCmd.addSubCommand(cmd),clearSelection(),x=Math.round(bbox.width),y=Math.round(bbox.height)}if(x!=w||y!=h){var handle=svgroot.suspendRedraw(1e3);batchCmd||(batchCmd=new svgedit.history.BatchCommand("Change Image Dimensions")),x=svgedit.units.convertToNum("width",x),y=svgedit.units.convertToNum("height",y),svgcontent.setAttribute("width",x),svgcontent.setAttribute("height",y),this.contentW=x,this.contentH=y,batchCmd.addSubCommand(new svgedit.history.ChangeElementCommand(svgcontent,{width:w,height:h})),svgcontent.setAttribute("viewBox",[0,0,x/current_zoom,y/current_zoom].join(" ")),batchCmd.addSubCommand(new svgedit.history.ChangeElementCommand(svgcontent,{viewBox:["0 0",w,h].join(" ")})),addCommandToHistory(batchCmd),svgroot.unsuspendRedraw(handle),call("changed",[svgcontent])}return!0},this.getOffset=function(){return $(svgcontent).attr(["x","y"])},this.setBBoxZoom=function(val,editor_w,editor_h){var bb,spacer=.85,calcZoom=function(bb){if(!bb)return!1;var w_zoom=Math.round(editor_w/bb.width*100*spacer)/100,h_zoom=Math.round(editor_h/bb.height*100*spacer)/100,zoomlevel=Math.min(w_zoom,h_zoom);return canvas.setZoom(zoomlevel),{zoom:zoomlevel,bbox:bb}};if("object"==typeof val){if(bb=val,0==bb.width||0==bb.height){var newzoom=bb.zoom?bb.zoom:current_zoom*bb.factor;return canvas.setZoom(newzoom),{zoom:current_zoom,bbox:bb}}return calcZoom(bb)}switch(val){case"selection":if(!selectedElements[0])return;var sel_elems=$.map(selectedElements,function(n){return n?n:void 0});bb=getStrokedBBox(sel_elems);break;case"canvas":var res=getResolution();spacer=.95,bb={width:res.w,height:res.h,x:0,y:0};break;case"content":bb=getStrokedBBox();break;case"layer":bb=getStrokedBBox(getVisibleElements(getCurrentDrawing().getCurrentLayer()));break;default:return}return calcZoom(bb)},this.setZoom=function(zoomlevel){var res=getResolution();svgcontent.setAttribute("viewBox","0 0 "+res.w/zoomlevel+" "+res.h/zoomlevel),current_zoom=zoomlevel,$.each(selectedElements,function(i,elem){elem&&selectorManager.requestSelector(elem).resize()}),pathActions.zoomChange(),runExtensions("zoomChanged",zoomlevel)},this.getMode=function(){return current_mode},this.setMode=function(name){pathActions.clear(!0),textActions.clear(),cur_properties=selectedElements[0]&&"text"==selectedElements[0].nodeName?cur_text:cur_shape,current_mode=name},this.getColor=function(type){return cur_properties[type]},this.setColor=function(type,val,preventUndo){function addNonG(e){"g"!=e.nodeName&&elems.push(e)}cur_shape[type]=val,cur_properties[type+"_paint"]={type:"solidColor"};for(var elems=[],i=selectedElements.length;i--;){var elem=selectedElements[i];elem&&("g"==elem.tagName?svgedit.utilities.walkTree(elem,addNonG):"fill"==type?"polyline"!=elem.tagName&&"line"!=elem.tagName&&elems.push(elem):elems.push(elem))}elems.length>0&&(preventUndo?changeSelectedAttributeNoUndo(type,val,elems):(changeSelectedAttribute(type,val,elems),call("changed",elems)))};var setGradient=this.setGradient=function(type){if(cur_properties[type+"_paint"]&&"solidColor"!=cur_properties[type+"_paint"].type){var grad=canvas[type+"Grad"],duplicate_grad=findDuplicateGradient(grad),defs=svgedit.utilities.findDefs();if(duplicate_grad)grad=duplicate_grad;else{grad=defs.appendChild(svgdoc.importNode(grad,!0)),grad.id=getNextId()}canvas.setColor(type,"url(#"+grad.id+")")}},findDuplicateGradient=function(grad){for(var defs=svgedit.utilities.findDefs(),existing_grads=$(defs).find("linearGradient, radialGradient"),i=existing_grads.length,rad_attrs=["r","cx","cy","fx","fy"];i--;){var og=existing_grads[i];if("linearGradient"==grad.tagName){if(grad.getAttribute("x1")!=og.getAttribute("x1")||grad.getAttribute("y1")!=og.getAttribute("y1")||grad.getAttribute("x2")!=og.getAttribute("x2")||grad.getAttribute("y2")!=og.getAttribute("y2"))continue}else{var grad_attrs=$(grad).attr(rad_attrs),og_attrs=$(og).attr(rad_attrs),diff=!1;if($.each(rad_attrs,function(i,attr){grad_attrs[attr]!=og_attrs[attr]&&(diff=!0)}),diff)continue}var stops=grad.getElementsByTagNameNS(NS.SVG,"stop"),ostops=og.getElementsByTagNameNS(NS.SVG,"stop");if(stops.length==ostops.length){for(var j=stops.length;j--;){var stop=stops[j],ostop=ostops[j];if(stop.getAttribute("offset")!=ostop.getAttribute("offset")||stop.getAttribute("stop-opacity")!=ostop.getAttribute("stop-opacity")||stop.getAttribute("stop-color")!=ostop.getAttribute("stop-color"))break
}if(-1==j)return og}}return null};this.setPaint=function(type,paint){var p=new $.jGraduate.Paint(paint);switch(this.setPaintOpacity(type,p.alpha/100,!0),cur_properties[type+"_paint"]=p,p.type){case"solidColor":this.setColor(type,"none"!=p.solidColor?"#"+p.solidColor:"none");break;case"linearGradient":case"radialGradient":canvas[type+"Grad"]=p[p.type],setGradient(type)}},this.setStrokePaint=function(paint){this.setPaint("stroke",paint)},this.setFillPaint=function(paint){this.setPaint("fill",paint)},this.getStrokeWidth=function(){return cur_properties.stroke_width},this.setStrokeWidth=function(val){function addNonG(e){"g"!=e.nodeName&&elems.push(e)}if(0==val&&["line","path"].indexOf(current_mode)>=0)return void canvas.setStrokeWidth(1);cur_properties.stroke_width=val;for(var elems=[],i=selectedElements.length;i--;){var elem=selectedElements[i];elem&&("g"==elem.tagName?svgedit.utilities.walkTree(elem,addNonG):elems.push(elem))}elems.length>0&&(changeSelectedAttribute("stroke-width",val,elems),call("changed",selectedElements))},this.setStrokeAttr=function(attr,val){cur_shape[attr.replace("-","_")]=val;for(var elems=[],i=selectedElements.length;i--;){var elem=selectedElements[i];elem&&("g"==elem.tagName?svgedit.utilities.walkTree(elem,function(e){"g"!=e.nodeName&&elems.push(e)}):elems.push(elem))}elems.length>0&&(changeSelectedAttribute(attr,val,elems),call("changed",selectedElements))},this.getStyle=function(){return cur_shape},this.getOpacity=function(){return cur_shape.opacity},this.setOpacity=function(val){cur_shape.opacity=val,changeSelectedAttribute("opacity",val)},this.getFillOpacity=function(){return cur_shape.fill_opacity},this.getStrokeOpacity=function(){return cur_shape.stroke_opacity},this.setPaintOpacity=function(type,val,preventUndo){cur_shape[type+"_opacity"]=val,preventUndo?changeSelectedAttributeNoUndo(type+"-opacity",val):changeSelectedAttribute(type+"-opacity",val)},this.getPaintOpacity=function(type){return"fill"===type?this.getFillOpacity():this.getStrokeOpacity()},this.getBlur=function(elem){var val=0;if(elem){var filter_url=elem.getAttribute("filter");if(filter_url){var blur=svgedit.utilities.getElem(elem.id+"_blur");blur&&(val=blur.firstChild.getAttribute("stdDeviation"))}}return val},function(){function finishChange(){var bCmd=canvas.undoMgr.finishUndoableChange();cur_command.addSubCommand(bCmd),addCommandToHistory(cur_command),cur_command=null,filter=null}var cur_command=null,filter=null,filterHidden=!1;canvas.setBlurNoUndo=function(val){if(!filter)return void canvas.setBlur(val);if(0===val)changeSelectedAttributeNoUndo("filter",""),filterHidden=!0;else{var elem=selectedElements[0];filterHidden&&changeSelectedAttributeNoUndo("filter","url(#"+elem.id+"_blur)"),svgedit.browser.isWebkit()&&(console.log("e",elem),elem.removeAttribute("filter"),elem.setAttribute("filter","url(#"+elem.id+"_blur)")),changeSelectedAttributeNoUndo("stdDeviation",val,[filter.firstChild]),canvas.setBlurOffsets(filter,val)}},canvas.setBlurOffsets=function(filter,stdDev){stdDev>3?svgedit.utilities.assignAttributes(filter,{x:"-50%",y:"-50%",width:"200%",height:"200%"},100):svgedit.browser.isWebkit()||(filter.removeAttribute("x"),filter.removeAttribute("y"),filter.removeAttribute("width"),filter.removeAttribute("height"))},canvas.setBlur=function(val,complete){if(cur_command)return void finishChange();var elem=selectedElements[0],elem_id=elem.id;filter=svgedit.utilities.getElem(elem_id+"_blur"),val-=0;var batchCmd=new svgedit.history.BatchCommand;if(filter)0===val&&(filter=null);else{var newblur=addSvgElementFromJson({element:"feGaussianBlur",attr:{"in":"SourceGraphic",stdDeviation:val}});filter=addSvgElementFromJson({element:"filter",attr:{id:elem_id+"_blur"}}),filter.appendChild(newblur),svgedit.utilities.findDefs().appendChild(filter),batchCmd.addSubCommand(new svgedit.history.InsertElementCommand(filter))}var changes={filter:elem.getAttribute("filter")};return 0===val?(elem.removeAttribute("filter"),void batchCmd.addSubCommand(new svgedit.history.ChangeElementCommand(elem,changes))):(changeSelectedAttribute("filter","url(#"+elem_id+"_blur)"),batchCmd.addSubCommand(new svgedit.history.ChangeElementCommand(elem,changes)),canvas.setBlurOffsets(filter,val),cur_command=batchCmd,canvas.undoMgr.beginUndoableChange("stdDeviation",[filter?filter.firstChild:null]),void(complete&&(canvas.setBlurNoUndo(val),finishChange())))}}(),this.getBold=function(){var selected=selectedElements[0];return null!=selected&&"text"==selected.tagName&&null==selectedElements[1]?"bold"==selected.getAttribute("font-weight"):!1},this.setBold=function(b){var selected=selectedElements[0];null!=selected&&"text"==selected.tagName&&null==selectedElements[1]&&changeSelectedAttribute("font-weight",b?"bold":"normal"),selectedElements[0].textContent||textActions.setCursor()},this.getItalic=function(){var selected=selectedElements[0];return null!=selected&&"text"==selected.tagName&&null==selectedElements[1]?"italic"==selected.getAttribute("font-style"):!1},this.setItalic=function(i){var selected=selectedElements[0];null!=selected&&"text"==selected.tagName&&null==selectedElements[1]&&changeSelectedAttribute("font-style",i?"italic":"normal"),selectedElements[0].textContent||textActions.setCursor()},this.getFontFamily=function(){return cur_text.font_family},this.setFontFamily=function(val){cur_text.font_family=val,changeSelectedAttribute("font-family",val),selectedElements[0]&&!selectedElements[0].textContent&&textActions.setCursor()},this.setFontColor=function(val){cur_text.fill=val,changeSelectedAttribute("fill",val)},this.getFontColor=function(){return cur_text.fill},this.getFontSize=function(){return cur_text.font_size},this.setFontSize=function(val){cur_text.font_size=val,changeSelectedAttribute("font-size",val),selectedElements[0].textContent||textActions.setCursor()},this.getText=function(){var selected=selectedElements[0];return null==selected?"":selected.textContent},this.setTextContent=function(val){changeSelectedAttribute("#text",val),textActions.init(val),textActions.setCursor()},this.setImageURL=function(val){var elem=selectedElements[0];if(elem){var attrs=$(elem).attr(["width","height"]),setsize=!attrs.width||!attrs.height,cur_href=getHref(elem);if(cur_href!==val)setsize=!0;else if(!setsize)return;var batchCmd=new svgedit.history.BatchCommand("Change Image URL");setHref(elem,val),batchCmd.addSubCommand(new svgedit.history.ChangeElementCommand(elem,{"#href":cur_href})),setsize?$(new Image).load(function(){var changes=$(elem).attr(["width","height"]);$(elem).attr({width:this.width,height:this.height}),selectorManager.requestSelector(elem).resize(),batchCmd.addSubCommand(new svgedit.history.ChangeElementCommand(elem,changes)),addCommandToHistory(batchCmd),call("changed",[elem])}).attr("src",val):addCommandToHistory(batchCmd)}},this.setLinkURL=function(val){var elem=selectedElements[0];if(elem){if("a"!==elem.tagName){var parents_a=$(elem).parents("a");if(!parents_a.length)return;elem=parents_a[0]}var cur_href=getHref(elem);if(cur_href!==val){var batchCmd=new svgedit.history.BatchCommand("Change Link URL");setHref(elem,val),batchCmd.addSubCommand(new svgedit.history.ChangeElementCommand(elem,{"#href":cur_href})),addCommandToHistory(batchCmd)}}},this.setRectRadius=function(val){var selected=selectedElements[0];if(null!=selected&&"rect"==selected.tagName){var r=selected.getAttribute("rx");r!=val&&(selected.setAttribute("rx",val),selected.setAttribute("ry",val),addCommandToHistory(new svgedit.history.ChangeElementCommand(selected,{rx:r,ry:r},"Radius")),call("changed",[selected]))}},this.makeHyperlink=function(url){canvas.groupSelectedElements("a",url)},this.removeHyperlink=function(){canvas.ungroupSelectedElement()},this.setSegType=function(new_type){pathActions.setSegType(new_type)},this.convertToPath=function(elem,getBBox){if(null==elem){return void $.each(selectedElements,function(i,elem){elem&&canvas.convertToPath(elem)})}if(!getBBox)var batchCmd=new svgedit.history.BatchCommand("Convert element to Path");var attrs=getBBox?{}:{fill:cur_shape.fill,"fill-opacity":cur_shape.fill_opacity,stroke:cur_shape.stroke,"stroke-width":cur_shape.stroke_width,"stroke-dasharray":cur_shape.stroke_dasharray,"stroke-linejoin":cur_shape.stroke_linejoin,"stroke-linecap":cur_shape.stroke_linecap,"stroke-opacity":cur_shape.stroke_opacity,opacity:cur_shape.opacity,visibility:"hidden"};$.each(["marker-start","marker-end","marker-mid","filter","clip-path"],function(){elem.getAttribute(this)&&(attrs[this]=elem.getAttribute(this))});var path=addSvgElementFromJson({element:"path",attr:attrs}),eltrans=elem.getAttribute("transform");eltrans&&path.setAttribute("transform",eltrans);var id=elem.id,parent=elem.parentNode;elem.nextSibling?parent.insertBefore(path,elem):parent.appendChild(path);var a,rx,d="",joinSegs=function(segs){$.each(segs,function(j,seg){var i,l=seg[0],pts=seg[1];for(d+=l,i=0;i<pts.length;i+=2)d+=pts[i]+","+pts[i+1]+" "})},num=1.81;switch(elem.tagName){case"ellipse":case"circle":a=$(elem).attr(["rx","ry","cx","cy"]);var cx=a.cx,cy=a.cy;rx=a.rx,ry=a.ry,"circle"==elem.tagName&&(rx=ry=$(elem).attr("r")),joinSegs([["M",[cx-rx,cy]],["C",[cx-rx,cy-ry/num,cx-rx/num,cy-ry,cx,cy-ry]],["C",[cx+rx/num,cy-ry,cx+rx,cy-ry/num,cx+rx,cy]],["C",[cx+rx,cy+ry/num,cx+rx/num,cy+ry,cx,cy+ry]],["C",[cx-rx/num,cy+ry,cx-rx,cy+ry/num,cx-rx,cy]],["Z",[]]]);break;case"path":d=elem.getAttribute("d");break;case"line":a=$(elem).attr(["x1","y1","x2","y2"]),d="M"+a.x1+","+a.y1+"L"+a.x2+","+a.y2;break;case"polyline":case"polygon":d="M"+elem.getAttribute("points");break;case"rect":var r=$(elem).attr(["rx","ry"]);rx=r.rx,ry=r.ry;var b=elem.getBBox(),x=b.x,y=b.y,w=b.width,h=b.height;num=4-num,joinSegs(rx||ry?[["M",[x,y+ry]],["C",[x,y+ry/num,x+rx/num,y,x+rx,y]],["L",[x+w-rx,y]],["C",[x+w-rx/num,y,x+w,y+ry/num,x+w,y+ry]],["L",[x+w,y+h-ry]],["C",[x+w,y+h-ry/num,x+w-rx/num,y+h,x+w-rx,y+h]],["L",[x+rx,y+h]],["C",[x+rx/num,y+h,x,y+h-ry/num,x,y+h-ry]],["L",[x,y+ry]],["Z",[]]]:[["M",[x,y]],["L",[x+w,y]],["L",[x+w,y+h]],["L",[x,y+h]],["L",[x,y]],["Z",[]]]);break;default:path.parentNode.removeChild(path)}if(d&&path.setAttribute("d",d),getBBox){pathActions.resetOrientation(path);var bb=!1;try{bb=path.getBBox()}catch(e){}return path.parentNode.removeChild(path),bb}if(eltrans){var tlist=svgedit.transformlist.getTransformList(path);svgedit.math.hasMatrixTransform(tlist)&&pathActions.resetOrientation(path)}var nextSibling=elem.nextSibling;batchCmd.addSubCommand(new svgedit.history.RemoveElementCommand(elem,nextSibling,parent)),batchCmd.addSubCommand(new svgedit.history.InsertElementCommand(path)),clearSelection(),elem.parentNode.removeChild(elem),path.setAttribute("id",id),path.removeAttribute("visibility"),addToSelection([path],!0),addCommandToHistory(batchCmd)};var changeSelectedAttributeNoUndo=function(attr,newValue,elems){var handle=svgroot.suspendRedraw(1e3);"pathedit"==current_mode&&pathActions.moveNode(attr,newValue),elems=elems||selectedElements;for(var i=elems.length,no_xy_elems=["g","polyline","path"],good_g_attrs=["transform","opacity","filter"];i--;){var elem=elems[i];if(null!=elem)if(("x"===attr||"y"===attr)&&no_xy_elems.indexOf(elem.tagName)>=0){var bbox=getStrokedBBox([elem]),diff_x="x"===attr?newValue-bbox.x:0,diff_y="y"===attr?newValue-bbox.y:0;canvas.moveSelectedElements(diff_x*current_zoom,diff_y*current_zoom,!0)}else{"g"===elem.tagName&&good_g_attrs.indexOf(attr)>=0;var oldval="#text"===attr?elem.textContent:elem.getAttribute(attr);if(null==oldval&&(oldval=""),oldval!==String(newValue)){if("#text"==attr){{svgedit.utilities.getBBox(elem).width}elem.textContent=newValue,/rotate/.test(elem.getAttribute("transform"))&&(elem=ffClone(elem))}else"#href"==attr?setHref(elem,newValue):elem.setAttribute(attr,newValue);"textedit"===current_mode&&"#text"!==attr&&elem.textContent.length&&textActions.toSelectMode(elem),svgedit.browser.isGecko()&&"text"===elem.nodeName&&/rotate/.test(elem.getAttribute("transform"))&&(0===String(newValue).indexOf("url")||["font-size","font-family","x","y"].indexOf(attr)>=0&&elem.textContent)&&(elem=ffClone(elem)),selectedElements.indexOf(elem)>=0&&setTimeout(function(){elem.parentNode&&selectorManager.requestSelector(elem).resize()},0);var angle=svgedit.utilities.getRotationAngle(elem);if(0!=angle&&"transform"!=attr)for(var tlist=svgedit.transformlist.getTransformList(elem),n=tlist.numberOfItems;n--;){var xform=tlist.getItem(n);if(4==xform.type){tlist.removeItem(n);var box=svgedit.utilities.getBBox(elem),center=svgedit.math.transformPoint(box.x+box.width/2,box.y+box.height/2,svgedit.math.transformListToTransform(tlist).matrix),cx=center.x,cy=center.y,newrot=svgroot.createSVGTransform();newrot.setRotate(angle,cx,cy),tlist.insertItemBefore(newrot,n);break}}}}}svgroot.unsuspendRedraw(handle)},changeSelectedAttribute=this.changeSelectedAttribute=function(attr,val,elems){elems=elems||selectedElements,canvas.undoMgr.beginUndoableChange(attr,elems);elems.length;changeSelectedAttributeNoUndo(attr,val,elems);var batchCmd=canvas.undoMgr.finishUndoableChange();batchCmd.isEmpty()||addCommandToHistory(batchCmd)};this.deleteSelectedElements=function(){var i,batchCmd=new svgedit.history.BatchCommand("Delete Elements"),len=selectedElements.length,selectedCopy=[];for(i=0;len>i;++i){var selected=selectedElements[i];if(null==selected)break;var parent=selected.parentNode,t=selected;selectorManager.releaseSelector(t),svgedit.path.removePath_(t.id),"a"===parent.tagName&&1===parent.childNodes.length&&(t=parent,parent=parent.parentNode);var nextSibling=t.nextSibling,elem=parent.removeChild(t);selectedCopy.push(selected),selectedElements[i]=null,batchCmd.addSubCommand(new RemoveElementCommand(elem,nextSibling,parent))}batchCmd.isEmpty()||addCommandToHistory(batchCmd),call("changed",selectedCopy),clearSelection()},this.cutSelectedElements=function(){var i,batchCmd=new svgedit.history.BatchCommand("Cut Elements"),len=selectedElements.length,selectedCopy=[];for(i=0;len>i;++i){var selected=selectedElements[i];if(null==selected)break;var parent=selected.parentNode,t=selected;selectorManager.releaseSelector(t),svgedit.path.removePath_(t.id);var nextSibling=t.nextSibling,elem=parent.removeChild(t);selectedCopy.push(selected),selectedElements[i]=null,batchCmd.addSubCommand(new RemoveElementCommand(elem,nextSibling,parent))}batchCmd.isEmpty()||addCommandToHistory(batchCmd),call("changed",selectedCopy),clearSelection(),canvas.clipBoard=selectedCopy},this.copySelectedElements=function(){canvas.clipBoard=$.merge([],selectedElements)},this.pasteElements=function(type,x,y){var cb=canvas.clipBoard,len=cb.length;if(len){for(var pasted=[],batchCmd=new svgedit.history.BatchCommand("Paste elements");len--;){var elem=cb[len];if(elem){var copy=copyElem(elem);svgedit.utilities.getElem(elem.id)||(copy.id=elem.id),pasted.push(copy),(current_group||getCurrentDrawing().getCurrentLayer()).appendChild(copy),batchCmd.addSubCommand(new svgedit.history.InsertElementCommand(copy))}}if(selectOnly(pasted),"in_place"!==type){var ctr_x,ctr_y;type?"point"===type&&(ctr_x=x,ctr_y=y):(ctr_x=lastClickPoint.x,ctr_y=lastClickPoint.y);var bbox=getStrokedBBox(pasted),cx=ctr_x-(bbox.x+bbox.width/2),cy=ctr_y-(bbox.y+bbox.height/2),dx=[],dy=[];$.each(pasted,function(){dx.push(cx),dy.push(cy)});var cmd=canvas.moveSelectedElements(dx,dy,!1);batchCmd.addSubCommand(cmd)}addCommandToHistory(batchCmd),call("changed",pasted)}},this.groupSelectedElements=function(type,urlArg){type||(type="g");var cmd_str="";switch(type){case"a":cmd_str="Make hyperlink";var url="";arguments.length>1&&(url=urlArg);break;default:type="g",cmd_str="Group Elements"}var batchCmd=new svgedit.history.BatchCommand(cmd_str),g=addSvgElementFromJson({element:type,attr:{id:getNextId()}});"a"===type&&setHref(g,url),batchCmd.addSubCommand(new svgedit.history.InsertElementCommand(g));for(var i=selectedElements.length;i--;){var elem=selectedElements[i];if(null!=elem){"a"===elem.parentNode.tagName&&1===elem.parentNode.childNodes.length&&(elem=elem.parentNode);var oldNextSibling=elem.nextSibling,oldParent=elem.parentNode;g.appendChild(elem),batchCmd.addSubCommand(new svgedit.history.MoveElementCommand(elem,oldNextSibling,oldParent))}}batchCmd.isEmpty()||addCommandToHistory(batchCmd),selectOnly([g],!0)};var pushGroupProperties=this.pushGroupProperties=function(g,undoable){var gfilter,gblur,changes,children=g.childNodes,len=children.length,xform=g.getAttribute("transform"),glist=svgedit.transformlist.getTransformList(g),m=svgedit.math.transformListToTransform(glist).matrix,batchCmd=new svgedit.history.BatchCommand("Push group properties"),i=0,gangle=svgedit.utilities.getRotationAngle(g),gattrs=$(g).attr(["filter","opacity"]);for(i=0;len>i;i++){var elem=children[i];if(1===elem.nodeType){if(null!==gattrs.opacity&&1!==gattrs.opacity){var new_opac=(elem.getAttribute("opacity")||1,Math.round((elem.getAttribute("opacity")||1)*gattrs.opacity*100)/100);changeSelectedAttribute("opacity",new_opac,[elem])}if(gattrs.filter){var cblur=this.getBlur(elem),orig_cblur=cblur;gblur||(gblur=this.getBlur(g)),cblur?cblur=Number(gblur)+Number(cblur):0===cblur&&(cblur=gblur),orig_cblur?gfilter=svgedit.utilities.getRefElem(elem.getAttribute("filter")):gfilter?(gfilter=copyElem(gfilter),svgedit.utilities.findDefs().appendChild(gfilter)):gfilter=svgedit.utilities.getRefElem(gattrs.filter);var suffix="feGaussianBlur"===gfilter.firstChild.tagName?"blur":"filter";gfilter.id=elem.id+"_"+suffix,changeSelectedAttribute("filter","url(#"+gfilter.id+")",[elem]),cblur&&(changeSelectedAttribute("stdDeviation",cblur,[gfilter.firstChild]),canvas.setBlurOffsets(gfilter,cblur))}var chtlist=svgedit.transformlist.getTransformList(elem);if(~elem.tagName.indexOf("Gradient")&&(chtlist=null),chtlist&&"defs"!==elem.tagName&&glist.numberOfItems){if(gangle&&1==glist.numberOfItems){var rgm=glist.getItem(0).matrix,rcm=svgroot.createSVGMatrix(),cangle=svgedit.utilities.getRotationAngle(elem);cangle&&(rcm=chtlist.getItem(0).matrix);var cbox=svgedit.utilities.getBBox(elem),ceqm=svgedit.math.transformListToTransform(chtlist).matrix,coldc=svgedit.math.transformPoint(cbox.x+cbox.width/2,cbox.y+cbox.height/2,ceqm),sangle=gangle+cangle,r2=svgroot.createSVGTransform();r2.setRotate(sangle,coldc.x,coldc.y);var trm=svgedit.math.matrixMultiply(rgm,rcm,r2.matrix.inverse());if(cangle&&chtlist.removeItem(0),sangle&&(chtlist.numberOfItems?chtlist.insertItemBefore(r2,0):chtlist.appendItem(r2)),trm.e||trm.f){var tr=svgroot.createSVGTransform();tr.setTranslate(trm.e,trm.f),chtlist.numberOfItems?chtlist.insertItemBefore(tr,0):chtlist.appendItem(tr)}}else{var oldxform=elem.getAttribute("transform");changes={},changes.transform=oldxform||"";var newxform=svgroot.createSVGTransform(),chm=svgedit.math.transformListToTransform(chtlist).matrix,chm_inv=chm.inverse(),gm=svgedit.math.matrixMultiply(chm_inv,m,chm);newxform.setMatrix(gm),chtlist.appendItem(newxform)}var cmd=svgedit.recalculate.recalculateDimensions(elem);cmd&&batchCmd.addSubCommand(cmd)}}}return xform&&(changes={},changes.transform=xform,g.setAttribute("transform",""),g.removeAttribute("transform"),batchCmd.addSubCommand(new svgedit.history.ChangeElementCommand(g,changes))),undoable&&!batchCmd.isEmpty()?batchCmd:void 0};this.ungroupSelectedElement=function(){var g=selectedElements[0];if(g){if($(g).data("gsvg")||$(g).data("symbol"))return void convertToGroup(g);if("use"===g.tagName){var symbol=svgedit.utilities.getElem(getHref(g).substr(1));return $(g).data("symbol",symbol).data("ref",symbol),void convertToGroup(g)}var parents_a=$(g).parents("a");if(parents_a.length&&(g=parents_a[0]),"g"===g.tagName||"a"===g.tagName){var batchCmd=new svgedit.history.BatchCommand("Ungroup Elements"),cmd=pushGroupProperties(g,!0);cmd&&batchCmd.addSubCommand(cmd);for(var parent=g.parentNode,anchor=g.nextSibling,children=new Array(g.childNodes.length),i=0;g.firstChild;){var elem=g.firstChild,oldNextSibling=elem.nextSibling,oldParent=elem.parentNode;if("title"!==elem.tagName)children[i++]=elem=parent.insertBefore(elem,anchor),batchCmd.addSubCommand(new svgedit.history.MoveElementCommand(elem,oldNextSibling,oldParent));else{var nextSibling=elem.nextSibling;batchCmd.addSubCommand(new svgedit.history.RemoveElementCommand(elem,nextSibling,oldParent)),oldParent.removeChild(elem)}}clearSelection();var gNextSibling=g.nextSibling;g=parent.removeChild(g),batchCmd.addSubCommand(new svgedit.history.RemoveElementCommand(g,gNextSibling,parent)),batchCmd.isEmpty()||addCommandToHistory(batchCmd),addToSelection(children)}}},this.moveToTopSelectedElement=function(){var selected=selectedElements[0];if(null!=selected){var t=selected,oldParent=t.parentNode,oldNextSibling=t.nextSibling;t=t.parentNode.appendChild(t),oldNextSibling!=t.nextSibling&&(addCommandToHistory(new svgedit.history.MoveElementCommand(t,oldNextSibling,oldParent,"top")),call("changed",[t]))}},this.moveToBottomSelectedElement=function(){var selected=selectedElements[0];if(null!=selected){var t=selected,oldParent=t.parentNode,oldNextSibling=t.nextSibling,firstChild=t.parentNode.firstChild;"title"==firstChild.tagName&&(firstChild=firstChild.nextSibling),"defs"==firstChild.tagName&&(firstChild=firstChild.nextSibling),t=t.parentNode.insertBefore(t,firstChild),oldNextSibling!=t.nextSibling&&(addCommandToHistory(new svgedit.history.MoveElementCommand(t,oldNextSibling,oldParent,"bottom")),call("changed",[t]))}},this.moveUpDownSelected=function(dir){var selected=selectedElements[0];if(selected){curBBoxes=[];var closest,found_cur,list=$(getIntersectionList(getStrokedBBox([selected]))).toArray();if("Down"==dir&&list.reverse(),$.each(list,function(){return found_cur?(closest=this,!1):void(this==selected&&(found_cur=!0))}),closest){var t=selected,oldParent=t.parentNode,oldNextSibling=t.nextSibling;$(closest)["Down"==dir?"before":"after"](t),oldNextSibling!=t.nextSibling&&(addCommandToHistory(new svgedit.history.MoveElementCommand(t,oldNextSibling,oldParent,"Move "+dir)),call("changed",[t]))}}},this.moveSelectedElements=function(dx,dy,undoable){dx.constructor!=Array&&(dx/=current_zoom,dy/=current_zoom),undoable=undoable||!0;for(var batchCmd=new svgedit.history.BatchCommand("position"),i=selectedElements.length;i--;){var selected=selectedElements[i];if(null!=selected){var xform=svgroot.createSVGTransform(),tlist=svgedit.transformlist.getTransformList(selected);dx.constructor==Array?xform.setTranslate(dx[i],dy[i]):xform.setTranslate(dx,dy),tlist.numberOfItems?tlist.insertItemBefore(xform,0):tlist.appendItem(xform);var cmd=svgedit.recalculate.recalculateDimensions(selected);cmd&&batchCmd.addSubCommand(cmd),selectorManager.requestSelector(selected).resize()}}return batchCmd.isEmpty()?void 0:(undoable&&addCommandToHistory(batchCmd),call("changed",selectedElements),batchCmd)},this.cloneSelectedElements=function(x,y){function sortfunction(a,b){return $(b).index()-$(a).index()}var i,elem,batchCmd=new svgedit.history.BatchCommand("Clone Elements"),len=selectedElements.length;for(selectedElements.sort(sortfunction),i=0;len>i&&(elem=selectedElements[i],null!=elem);++i);var copiedElements=selectedElements.slice(0,i);for(this.clearSelection(!0),i=copiedElements.length;i--;)elem=copiedElements[i]=copyElem(copiedElements[i]),(current_group||getCurrentDrawing().getCurrentLayer()).appendChild(elem),batchCmd.addSubCommand(new svgedit.history.InsertElementCommand(elem));batchCmd.isEmpty()||(addToSelection(copiedElements.reverse()),this.moveSelectedElements(x,y,!1),addCommandToHistory(batchCmd))},this.alignSelectedElements=function(type,relative_to){var i,elem,bboxes=[],minx=Number.MAX_VALUE,maxx=Number.MIN_VALUE,miny=Number.MAX_VALUE,maxy=Number.MIN_VALUE,curwidth=Number.MIN_VALUE,curheight=Number.MIN_VALUE,len=selectedElements.length;if(len){for(i=0;len>i&&null!=selectedElements[i];++i)switch(elem=selectedElements[i],bboxes[i]=getStrokedBBox([elem]),relative_to){case"smallest":(("l"==type||"c"==type||"r"==type)&&(curwidth==Number.MIN_VALUE||curwidth>bboxes[i].width)||("t"==type||"m"==type||"b"==type)&&(curheight==Number.MIN_VALUE||curheight>bboxes[i].height))&&(minx=bboxes[i].x,miny=bboxes[i].y,maxx=bboxes[i].x+bboxes[i].width,maxy=bboxes[i].y+bboxes[i].height,curwidth=bboxes[i].width,curheight=bboxes[i].height);break;case"largest":(("l"==type||"c"==type||"r"==type)&&(curwidth==Number.MIN_VALUE||curwidth<bboxes[i].width)||("t"==type||"m"==type||"b"==type)&&(curheight==Number.MIN_VALUE||curheight<bboxes[i].height))&&(minx=bboxes[i].x,miny=bboxes[i].y,maxx=bboxes[i].x+bboxes[i].width,maxy=bboxes[i].y+bboxes[i].height,curwidth=bboxes[i].width,curheight=bboxes[i].height);break;default:bboxes[i].x<minx&&(minx=bboxes[i].x),bboxes[i].y<miny&&(miny=bboxes[i].y),bboxes[i].x+bboxes[i].width>maxx&&(maxx=bboxes[i].x+bboxes[i].width),bboxes[i].y+bboxes[i].height>maxy&&(maxy=bboxes[i].y+bboxes[i].height)}"page"==relative_to&&(minx=0,miny=0,maxx=canvas.contentW,maxy=canvas.contentH);var dx=new Array(len),dy=new Array(len);for(i=0;len>i&&null!=selectedElements[i];++i){elem=selectedElements[i];var bbox=bboxes[i];switch(dx[i]=0,dy[i]=0,type){case"l":dx[i]=minx-bbox.x;break;case"c":dx[i]=(minx+maxx)/2-(bbox.x+bbox.width/2);break;case"r":dx[i]=maxx-(bbox.x+bbox.width);break;case"t":dy[i]=miny-bbox.y;break;case"m":dy[i]=(miny+maxy)/2-(bbox.y+bbox.height/2);break;case"b":dy[i]=maxy-(bbox.y+bbox.height)}}this.moveSelectedElements(dx,dy)}},this.contentW=getResolution().w,this.contentH=getResolution().h,this.updateCanvas=function(w,h){svgroot.setAttribute("width",w),svgroot.setAttribute("height",h);var bg=$("#canvasBackground")[0],old_x=svgcontent.getAttribute("x"),old_y=svgcontent.getAttribute("y"),x=w/2-this.contentW*current_zoom/2,y=h/2-this.contentH*current_zoom/2;svgedit.utilities.assignAttributes(svgcontent,{width:this.contentW*current_zoom,height:this.contentH*current_zoom,x:x,y:y,viewBox:"0 0 "+this.contentW+" "+this.contentH}),svgedit.utilities.assignAttributes(bg,{width:svgcontent.getAttribute("width"),height:svgcontent.getAttribute("height"),x:x,y:y});var bg_img=svgedit.utilities.getElem("background_image");return bg_img&&svgedit.utilities.assignAttributes(bg_img,{width:"100%",height:"100%"}),selectorManager.selectorParentGroup.setAttribute("transform","translate("+x+","+y+")"),runExtensions("canvasUpdated",{new_x:x,new_y:y,old_x:old_x,old_y:old_y,d_x:x-old_x,d_y:y-old_y}),{x:x,y:y,old_x:old_x,old_y:old_y,d_x:x-old_x,d_y:y-old_y}},this.setBackground=function(color,url){var bg=svgedit.utilities.getElem("canvasBackground"),border=$(bg).find("rect")[0],bg_img=svgedit.utilities.getElem("background_image");border.setAttribute("fill",color),url?(bg_img||(bg_img=svgdoc.createElementNS(NS.SVG,"image"),svgedit.utilities.assignAttributes(bg_img,{id:"background_image",width:"100%",height:"100%",preserveAspectRatio:"xMinYMin",style:"pointer-events:none"})),setHref(bg_img,url),bg.appendChild(bg_img)):bg_img&&bg_img.parentNode.removeChild(bg_img)},this.cycleElement=function(next){var num,cur_elem=selectedElements[0],elem=!1,all_elems=getVisibleElements(current_group||getCurrentDrawing().getCurrentLayer());if(all_elems.length){if(null==cur_elem)num=next?all_elems.length-1:0,elem=all_elems[num];else for(var i=all_elems.length;i--;)if(all_elems[i]==cur_elem){num=next?i-1:i+1,num>=all_elems.length?num=0:0>num&&(num=all_elems.length-1),elem=all_elems[num];break}selectOnly([elem],!0),call("selected",selectedElements)}},this.clear(),this.getPrivateMethods=function(){var obj={addCommandToHistory:addCommandToHistory,setGradient:setGradient,addSvgElementFromJson:addSvgElementFromJson,assignAttributes:assignAttributes,BatchCommand:BatchCommand,call:call,ChangeElementCommand:ChangeElementCommand,copyElem:copyElem,ffClone:ffClone,findDefs:findDefs,findDuplicateGradient:findDuplicateGradient,getElem:getElem,getId:getId,getIntersectionList:getIntersectionList,getMouseTarget:getMouseTarget,getNextId:getNextId,getPathBBox:getPathBBox,getUrlFromAttr:getUrlFromAttr,hasMatrixTransform:hasMatrixTransform,identifyLayers:identifyLayers,InsertElementCommand:InsertElementCommand,isIdentity:svgedit.math.isIdentity,logMatrix:logMatrix,matrixMultiply:matrixMultiply,MoveElementCommand:MoveElementCommand,preventClickDefault:preventClickDefault,recalculateAllSelectedDimensions:recalculateAllSelectedDimensions,recalculateDimensions:recalculateDimensions,remapElement:remapElement,RemoveElementCommand:RemoveElementCommand,removeUnusedDefElems:removeUnusedDefElems,round:round,runExtensions:runExtensions,sanitizeSvg:sanitizeSvg,SVGEditTransformList:svgedit.transformlist.SVGTransformList,toString:toString,transformBox:svgedit.math.transformBox,transformListToTransform:transformListToTransform,transformPoint:transformPoint,walkTree:svgedit.utilities.walkTree};return obj}};var saveAs;!function(){window.svgEditor||(window.svgEditor=function($){function loadSvgString(str,callback){var success=svgCanvas.setSvgString(str)!==!1;callback=callback||$.noop,success?callback(!0):$.alert(uiStrings.notification.errorLoadingSVG,function(){callback(!1)})}function checkCanvg(callCanvg){return function(win,data){window.canvg?callCanvg(win,data):$.getScript("canvg/rgbcolor.js",function(){$.getScript("canvg/canvg.js",function(){callCanvg(win,data)})})}}var editor={};editor.tool_scale=1,editor.langChanged=!1,editor.showSaveWarning=!1,editor.storagePromptClosed=!1;var svgCanvas,urldata,Utils=svgedit.utilities,isReady=!1,callbacks=[],customHandlers={},defaultPrefs={lang:"",iconsize:"",bkgd_color:"#FFF",bkgd_url:"",img_save:"embed",save_notice_done:!1,export_notice_done:!1},curPrefs={},curConfig={extensions:[],allowedOrigins:[]},defaultExtensions=["ext-overview_window.js","ext-markers.js","ext-connector.js","ext-eyedropper.js","ext-shapes.js","ext-imagelib.js","ext-grid.js","ext-polygon.js","ext-star.js","ext-panning.js","ext-storage.js"],defaultConfig={canvasName:"default",canvas_expansion:3,initFill:{color:"FF0000",opacity:1},initStroke:{width:5,color:"000000",opacity:1},initOpacity:1,colorPickerCSS:null,initTool:"select",wireframe:!1,showlayers:!1,no_save_warning:!1,imgPath:"images/",langPath:"locale/",extPath:"extensions/",jGraduatePath:"jgraduate/images/",dimensions:[640,480],gridSnapping:!1,gridColor:"#000",baseUnit:"px",snappingStep:10,showRulers:!0,preventAllURLConfig:!1,preventURLContentLoading:!1,lockExtensions:!1,noDefaultExtensions:!1,showGrid:!1,noStorageOnLoad:!1,forceStorage:!1,emptyStorageOnDecline:!1},uiStrings=editor.uiStrings={common:{ok:"OK",cancel:"Cancel",key_up:"Up",key_down:"Down",key_backspace:"Backspace",key_del:"Del"},layers:{layer:"Layer"},notification:{invalidAttrValGiven:"Invalid value given",noContentToFitTo:"No content to fit to",dupeLayerName:"There is already a layer named that!",enterUniqueLayerName:"Please enter a unique layer name",enterNewLayerName:"Please enter the new layer name",layerHasThatName:"Layer already has that name",QmoveElemsToLayer:"Move selected elements to layer '%s'?",QwantToClear:"Do you want to clear the drawing?\nThis will also erase your undo history!",QwantToOpen:"Do you want to open a new file?\nThis will also erase your undo history!",QerrorsRevertToSource:"There were parsing errors in your SVG source.\nRevert back to original SVG source?",QignoreSourceChanges:"Ignore changes made to SVG source?",featNotSupported:"Feature not supported",enterNewImgURL:"Enter the new image URL",defsFailOnSave:"NOTE: Due to a bug in your browser, this image may appear wrong (missing gradients or elements). It will however appear correct once actually saved.",loadingImage:"Loading image, please wait...",saveFromBrowser:"Select 'Save As...' in your browser to save this image as a %s file.",noteTheseIssues:"Also note the following issues: ",unsavedChanges:"There are unsaved changes.",enterNewLinkURL:"Enter the new hyperlink URL",errorLoadingSVG:"Error: Unable to load SVG data",URLloadFail:"Unable to load from URL",retrieving:"Retrieving '%s' ..."}};return $.pref=function(key,val){return val?(curPrefs[key]=val,void(editor.curPrefs=curPrefs)):key in curPrefs?curPrefs[key]:defaultPrefs[key]},editor.loadContentAndPrefs=function(){if(curConfig.forceStorage||!curConfig.noStorageOnLoad&&document.cookie.match(/(?:^|;\s*)store=(?:prefsAndContent|prefsOnly)/)){if(editor.storage&&(curConfig.forceStorage||!curConfig.noStorageOnLoad&&document.cookie.match(/(?:^|;\s*)store=prefsAndContent/))){var name="svgedit-"+curConfig.canvasName,cached=editor.storage.getItem(name);
cached&&editor.loadFromString(cached)}var key;for(key in defaultPrefs)if(defaultPrefs.hasOwnProperty(key)){var storeKey="svg-edit-"+key;if(editor.storage){var val=editor.storage.getItem(storeKey);val&&(defaultPrefs[key]=String(val))}else if(window.widget)defaultPrefs[key]=widget.preferenceForKey(storeKey);else{var result=document.cookie.match(new RegExp("(?:^|;\\s*)"+Utils.preg_quote(encodeURIComponent(storeKey))+"=([^;]+)"));defaultPrefs[key]=result?decodeURIComponent(result[1]):""}}}},editor.setConfig=function(opts,cfgCfg){function extendOrAdd(cfgObj,key,val){cfgObj[key]&&"object"==typeof cfgObj[key]?$.extend(!0,cfgObj[key],val):cfgObj[key]=val}cfgCfg=cfgCfg||{},$.each(opts,function(key,val){if(opts.hasOwnProperty(key))if(defaultPrefs.hasOwnProperty(key)){if(cfgCfg.overwrite===!1&&(curConfig.preventAllURLConfig||curPrefs.hasOwnProperty(key)))return;cfgCfg.allowInitialUserOverride===!0?defaultPrefs[key]=val:$.pref(key,val)}else if(["extensions","allowedOrigins"].indexOf(key)>-1){if(cfgCfg.overwrite===!1&&(curConfig.preventAllURLConfig||"allowedOrigins"===key||"extensions"===key&&curConfig.lockExtensions))return;curConfig[key]=curConfig[key].concat(val)}else if(defaultConfig.hasOwnProperty(key)){if(cfgCfg.overwrite===!1&&(curConfig.preventAllURLConfig||curConfig.hasOwnProperty(key)))return;if(curConfig.hasOwnProperty(key)){if(cfgCfg.overwrite===!1)return;extendOrAdd(curConfig,key,val)}else cfgCfg.allowInitialUserOverride===!0?extendOrAdd(defaultConfig,key,val):defaultConfig[key]&&"object"==typeof defaultConfig[key]?(curConfig[key]={},$.extend(!0,curConfig[key],val)):curConfig[key]=val}}),editor.curConfig=curConfig},editor.setCustomHandlers=function(opts){editor.ready(function(){opts.open&&($('#tool_open > input[type="file"]').remove(),$("#tool_open").show(),svgCanvas.open=opts.open),opts.save&&(editor.showSaveWarning=!1,svgCanvas.bind("saved",opts.save)),opts.exportImage&&svgCanvas.bind("exported",checkCanvg(opts.exportImage)),customHandlers=opts})},editor.randomizeIds=function(){svgCanvas.randomizeIds(arguments)},editor.init=function(){function setupCurPrefs(){curPrefs=$.extend(!0,{},defaultPrefs,curPrefs),editor.curPrefs=curPrefs}function setupCurConfig(){curConfig=$.extend(!0,{},defaultConfig,curConfig),curConfig.noDefaultExtensions||(curConfig.extensions=curConfig.extensions.concat(defaultExtensions)),$.each(["extensions","allowedOrigins"],function(i,cfg){curConfig[cfg]=$.grep(curConfig[cfg],function(n,i){return i===curConfig[cfg].indexOf(n)})}),editor.curConfig=curConfig}function setStrokeOpt(opt,changeElem){var id=opt.id,bits=id.split("_"),pre=bits[0],val=bits[1];changeElem&&svgCanvas.setStrokeAttr("stroke-"+pre,val),operaRepaint(),setIcon("#cur_"+pre,id,20),$(opt).addClass("current").siblings().removeClass("current")}function setBackground(color,url){$.pref("bkgd_color",color),$.pref("bkgd_url",url),svgCanvas.setBackground(color,url)}function promptImgURL(){var curhref=svgCanvas.getHref(selectedElement);curhref=0===curhref.indexOf("data:")?"":curhref,$.prompt(uiStrings.notification.enterNewImgURL,curhref,function(url){url&&setImageURL(url)})}function updateRulers(scanvas,zoom){zoom||(zoom=svgCanvas.getZoom()),scanvas||(scanvas=$("#svgcanvas"));var d,i,limit=3e4,contentElem=svgCanvas.getContentElem(),units=svgedit.units.getTypeMap(),unit=units[curConfig.baseUnit];for(d=0;2>d;d++){var isX=0===d,dim=isX?"x":"y",lentype=isX?"width":"height",contentDim=Number(contentElem.getAttribute(dim)),$hcanv_orig=$("#ruler_"+dim+" canvas:first"),$hcanv=$hcanv_orig.clone();$hcanv_orig.replaceWith($hcanv);var hcanv=$hcanv[0],ruler_len=scanvas[lentype](),total_len=ruler_len;hcanv.parentNode.style[lentype]=total_len+"px";var ctx_arr,num,ctx_arr_num,ctx_num=0,ctx=hcanv.getContext("2d");if(ctx.fillStyle="rgb(200,0,0)",ctx.fillRect(0,0,hcanv.width,hcanv.height),$hcanv.siblings().remove(),ruler_len>=limit){ctx_arr_num=parseInt(ruler_len/limit,10)+1,ctx_arr=[],ctx_arr[0]=ctx;var copy;for(i=1;ctx_arr_num>i;i++)hcanv[lentype]=limit,copy=hcanv.cloneNode(!0),hcanv.parentNode.appendChild(copy),ctx_arr[i]=copy.getContext("2d");copy[lentype]=ruler_len%limit,ruler_len=limit}hcanv[lentype]=ruler_len;var u_multi=unit*zoom,raw_m=50/u_multi,multi=1;for(i=0;i<r_intervals.length&&(num=r_intervals[i],multi=num,!(num>=raw_m));i++);var big_int=multi*u_multi;ctx.font="9px sans-serif";for(var ruler_d=contentDim/u_multi%multi*u_multi,label_pos=ruler_d-big_int;total_len>ruler_d;){label_pos+=big_int;var cur_d=Math.round(ruler_d)+.5;isX?(ctx.moveTo(cur_d,15),ctx.lineTo(cur_d,0)):(ctx.moveTo(15,cur_d),ctx.lineTo(0,cur_d)),num=(label_pos-contentDim)/u_multi;var label;if(multi>=1)label=Math.round(num);else{var decs=String(multi).split(".")[1].length;label=num.toFixed(decs)}if(0!==label&&1e3!==label&&label%1e3===0&&(label=label/1e3+"K"),isX)ctx.fillText(label,ruler_d+2,8);else{var str=String(label).split("");for(i=0;i<str.length;i++)ctx.fillText(str[i],1,ruler_d+9+9*i)}var part=big_int/10;for(i=1;10>i;i++){var sub_d=Math.round(ruler_d+part*i)+.5;if(ctx_arr&&sub_d>ruler_len){if(ctx_num++,ctx.stroke(),ctx_num>=ctx_arr_num){i=10,ruler_d=total_len;continue}ctx=ctx_arr[ctx_num],ruler_d-=limit,sub_d=Math.round(ruler_d+part*i)+.5}var line_num=i%2?12:10;isX?(ctx.moveTo(sub_d,15),ctx.lineTo(sub_d,line_num)):(ctx.moveTo(15,sub_d),ctx.lineTo(line_num,sub_d))}ruler_d+=big_int}ctx.strokeStyle="#000",ctx.stroke()}}function deleteLayer(){svgCanvas.deleteCurrentLayer()&&(updateContextPanel(),populateLayers(),$("#layerlist tr.layer").removeClass("layersel"),$("#layerlist tr.layer:first").addClass("layersel"))}function cloneLayer(){var name=svgCanvas.getCurrentDrawing().getCurrentLayerName()+" copy";$.prompt(uiStrings.notification.enterUniqueLayerName,name,function(newName){if(newName){if(svgCanvas.getCurrentDrawing().hasLayer(newName))return void $.alert(uiStrings.notification.dupeLayerName);svgCanvas.cloneLayer(newName),updateContextPanel(),populateLayers()}})}function mergeLayer(){$("#layerlist tr.layersel").index()!=svgCanvas.getCurrentDrawing().getNumLayers()-1&&(svgCanvas.mergeLayer(),updateContextPanel(),populateLayers())}function moveLayer(pos){var curIndex=$("#layerlist tr.layersel").index(),total=svgCanvas.getCurrentDrawing().getNumLayers();(curIndex>0||total-1>curIndex)&&(curIndex+=pos,svgCanvas.setCurrentLayerPosition(total-curIndex-1),populateLayers())}function stepFontSize(elem,step){var orig_val=Number(elem.value),sug_val=orig_val+step,increasing=sug_val>=orig_val;return 0===step?orig_val:orig_val>=24?Math.round(increasing?1.1*orig_val:orig_val/1.1):1>=orig_val?increasing?2*orig_val:orig_val/2:sug_val}function stepZoom(elem,step){var orig_val=Number(elem.value);if(0===orig_val)return 100;var sug_val=orig_val+step;return 0===step?orig_val:orig_val>=100?sug_val:sug_val>=orig_val?2*orig_val:orig_val/2}function onDragEnter(e){e.stopPropagation(),e.preventDefault()}function onDragOver(e){e.stopPropagation(),e.preventDefault()}function onDragLeave(e){e.stopPropagation(),e.preventDefault()}try{"localStorage"in window&&(editor.storage=localStorage)}catch(err){}var good_langs=[];$("#lang_select option").each(function(){good_langs.push(this.value)}),function(){var src,qstr;if(urldata=$.deparam.querystring(!0),$.isEmptyObject(urldata))setupCurConfig(),editor.loadContentAndPrefs(),setupCurPrefs();else{if(urldata.dimensions&&(urldata.dimensions=urldata.dimensions.split(",")),urldata.bkgd_color&&(urldata.bkgd_color="#"+urldata.bkgd_color),urldata.extensions&&(urldata.extensions=urldata.extensions.match(/[:\/\\]/)?"":urldata.extensions.split(",")),$.each(["extPath","imgPath","langPath","jGraduatePath"],function(pathConfig){urldata[pathConfig]&&delete urldata[pathConfig]}),editor.setConfig(urldata,{overwrite:!1}),setupCurConfig(),!curConfig.preventURLContentLoading){if(src=urldata.source,qstr=$.param.querystring(),src||qstr.indexOf("source=data:")>=0&&(src=qstr.match(/source=(data:[^&]*)/)[1]),src)return void(0===src.indexOf("data:")?editor.loadFromDataURI(src):editor.loadFromString(src));if(urldata.url)return void editor.loadFromURL(urldata.url)}(!urldata.noStorageOnLoad||curConfig.forceStorage)&&editor.loadContentAndPrefs(),setupCurPrefs()}}(),function(){var svgEditorReadyEvent,w=window.opener;if(w)try{svgEditorReadyEvent=w.document.createEvent("Event"),svgEditorReadyEvent.initEvent("svgEditorReady",!0,!0),w.document.documentElement.dispatchEvent(svgEditorReadyEvent)}catch(e){}}();var setIcon=editor.setIcon=function(elem,icon_id){var icon="string"==typeof icon_id?$.getSvgIcon(icon_id,!0):icon_id.clone();return icon?void $(elem).empty().append(icon):void console.log("NOTE: Icon image missing: "+icon_id)},extFunc=function(){$.each(curConfig.extensions,function(){var extname=this;extname.match(/^ext-.*\.js/)&&$.getScript(curConfig.extPath+extname,function(d){if(!d){var s=document.createElement("script");s.src=curConfig.extPath+extname,document.querySelector("head").appendChild(s)}})}),editor.putLocale(null,good_langs)};"file:"===document.location.protocol?setTimeout(extFunc,100):extFunc(),$.svgIcons(curConfig.imgPath+"svg_edit_icons.svg",{w:24,h:24,id_match:!1,no_img:!svgedit.browser.isWebkit(),fallback_path:curConfig.imgPath,fallback:{new_image:"clear.png",save:"save.png",open:"open.png",source:"source.png",docprops:"document-properties.png",wireframe:"wireframe.png",undo:"undo.png",redo:"redo.png",select:"select.png",select_node:"select_node.png",pencil:"fhpath.png",pen:"line.png",square:"square.png",rect:"rect.png",fh_rect:"freehand-square.png",circle:"circle.png",ellipse:"ellipse.png",fh_ellipse:"freehand-circle.png",path:"path.png",text:"text.png",image:"image.png",zoom:"zoom.png",clone:"clone.png",node_clone:"node_clone.png","delete":"delete.png",node_delete:"node_delete.png",group:"shape_group_elements.png",ungroup:"shape_ungroup.png",move_top:"move_top.png",move_bottom:"move_bottom.png",to_path:"to_path.png",link_controls:"link_controls.png",reorient:"reorient.png",align_left:"align-left.png",align_center:"align-center.png",align_right:"align-right.png",align_top:"align-top.png",align_middle:"align-middle.png",align_bottom:"align-bottom.png",go_up:"go-up.png",go_down:"go-down.png",ok:"save.png",cancel:"cancel.png",arrow_right:"flyouth.png",arrow_down:"dropdown.gif"},placement:{"#tool_clear div,#layer_new":"new_image","#tool_save div":"save","#tool_export div":"export","#tool_open div div":"open","#tool_import div div":"import","#tool_source":"source","#tool_docprops > div":"docprops","#tool_wireframe":"wireframe","#tool_undo":"undo","#tool_redo":"redo","#tool_select":"select","#tool_fhpath":"pencil","#tool_line":"pen","#tool_rect,#tools_rect_show":"rect","#tool_square":"square","#tool_fhrect":"fh_rect","#tool_ellipse,#tools_ellipse_show":"ellipse","#tool_circle":"circle","#tool_fhellipse":"fh_ellipse","#tool_path":"path","#tool_text,#layer_rename":"text","#tool_image":"image","#tool_zoom":"zoom","#tool_clone,#tool_clone_multi":"clone","#tool_node_clone":"node_clone","#layer_delete,#tool_delete,#tool_delete_multi":"delete","#tool_node_delete":"node_delete","#tool_add_subpath":"add_subpath","#tool_openclose_path":"open_path","#tool_move_top":"move_top","#tool_move_bottom":"move_bottom","#tool_topath":"to_path","#tool_node_link":"link_controls","#tool_reorient":"reorient","#tool_group_elements":"group_elements","#tool_ungroup":"ungroup","#tool_unlink_use":"unlink_use","#tool_alignleft, #tool_posleft":"align_left","#tool_aligncenter, #tool_poscenter":"align_center","#tool_alignright, #tool_posright":"align_right","#tool_aligntop, #tool_postop":"align_top","#tool_alignmiddle, #tool_posmiddle":"align_middle","#tool_alignbottom, #tool_posbottom":"align_bottom","#cur_position":"align","#linecap_butt,#cur_linecap":"linecap_butt","#linecap_round":"linecap_round","#linecap_square":"linecap_square","#linejoin_miter,#cur_linejoin":"linejoin_miter","#linejoin_round":"linejoin_round","#linejoin_bevel":"linejoin_bevel","#url_notice":"warning","#layer_up":"go_up","#layer_down":"go_down","#layer_moreopts":"context_menu","#layerlist td.layervis":"eye","#tool_source_save,#tool_docprops_save,#tool_prefs_save":"ok","#tool_source_cancel,#tool_docprops_cancel,#tool_prefs_cancel":"cancel","#rwidthLabel, #iwidthLabel":"width","#rheightLabel, #iheightLabel":"height","#cornerRadiusLabel span":"c_radius","#angleLabel":"angle","#linkLabel,#tool_make_link,#tool_make_link_multi":"globe_link","#zoomLabel":"zoom","#tool_fill label":"fill","#tool_stroke .icon_label":"stroke","#group_opacityLabel":"opacity","#blurLabel":"blur","#font_sizeLabel":"fontsize",".flyout_arrow_horiz":"arrow_right",".dropdown button, #main_button .dropdown":"arrow_down","#palette .palette_item:first, #fill_bg, #stroke_bg":"no_color"},resize:{"#logo .svg_icon":28,".flyout_arrow_horiz .svg_icon":5,".layer_button .svg_icon, #layerlist td.layervis .svg_icon":14,".dropdown button .svg_icon":7,"#main_button .dropdown .svg_icon":9,".palette_item:first .svg_icon":15,"#fill_bg .svg_icon, #stroke_bg .svg_icon":16,".toolbar_button button .svg_icon":16,".stroke_tool div div .svg_icon":20,"#tools_bottom label .svg_icon":18},callback:function(){$(".toolbar_button button > svg, .toolbar_button button > img").each(function(){$(this).parent().prepend(this)});var min_height,tleft=$("#tools_left");0!==tleft.length&&(min_height=tleft.offset().top+tleft.outerHeight());var size=$.pref("iconsize");editor.setIconSize(size||($(window).height()<min_height?"s":"m")),$(".tools_flyout").each(function(){var shower=$("#"+this.id+"_show"),sel=shower.attr("data-curopt");if(!shower.children("svg, img").length){var clone=$(sel).children().clone();clone.length&&(clone[0].removeAttribute("style"),shower.append(clone))}}),editor.runCallbacks(),setTimeout(function(){$(".flyout_arrow_horiz:empty").each(function(){$(this).append($.getSvgIcon("arrow_right").width(5).height(5))})},1)}}),editor.canvas=svgCanvas=new $.SvgCanvas(document.getElementById("svgcanvas"),curConfig);var supportsNonSS,resize_timer,changeZoom,Actions,curScrollPos,palette=["#000000","#3f3f3f","#7f7f7f","#bfbfbf","#ffffff","#ff0000","#ff7f00","#ffff00","#7fff00","#00ff00","#00ff7f","#00ffff","#007fff","#0000ff","#7f00ff","#ff00ff","#ff007f","#7f0000","#7f3f00","#7f7f00","#3f7f00","#007f00","#007f3f","#007f7f","#003f7f","#00007f","#3f007f","#7f007f","#7f003f","#ffaaaa","#ffd4aa","#ffffaa","#d4ffaa","#aaffaa","#aaffd4","#aaffff","#aad4ff","#aaaaff","#d4aaff","#ffaaff","#ffaad4"],modKey=svgedit.browser.isMac()?"meta+":"ctrl+",path=svgCanvas.pathActions,undoMgr=svgCanvas.undoMgr,defaultImageURL=curConfig.imgPath+"logo.png",workarea=$("#workarea"),canv_menu=$("#cmenu_canvas"),exportWindow=null,zoomInIcon="crosshair",zoomOutIcon="crosshair",ui_context="toolbars",origSource="",paintBox={fill:null,stroke:null};!function(){$("#dialog_container").draggable({cancel:"#dialog_content, #dialog_buttons *",containment:"window"});var box=$("#dialog_box"),btn_holder=$("#dialog_buttons"),dialog_content=$("#dialog_content"),box_hide=function(){box.hide()},dbox=function(type,msg,callback,defaultVal,opts,changeCb,checkbox){var ok,ctrl,chkbx;if("dialog"==type?dialog_content.html("").append(msg):dialog_content.html("<p>"+msg.replace(/\n/g,"</p><p>")+"</p>").toggleClass("prompt","prompt"==type),btn_holder.empty(),ok=$('<input type="button" value="'+uiStrings.common.ok+'">').appendTo(btn_holder),"alert"!==type&&$('<input type="button" value="'+uiStrings.common.cancel+'">').appendTo(btn_holder).click(function(){box.hide(),callback&&callback(!1)}),"dialog"==type){if(callback){btn_holder.empty();for(var btn_name in callback)$('<input type="button" value="'+btn_name+'">').appendTo(btn_holder).click(callback[btn_name])}}else if("prompt"===type)ctrl=$('<input type="text">').prependTo(btn_holder),ctrl.val(defaultVal||""),ctrl.bind("keydown","return",function(){ok.click()});else if("select"===type){var div=$('<div style="text-align:center;">');if(ctrl=$("<select>").appendTo(div),checkbox){var label=$("<label>").text(checkbox.label);chkbx=$('<input type="checkbox">').appendTo(label),chkbx.val(checkbox.value),checkbox.tooltip&&label.attr("title",checkbox.tooltip),chkbx.prop("checked",!!checkbox.checked),div.append($("<div>").append(label))}$.each(opts||[],function(opt,val){ctrl.append("object"==typeof val?$("<option>").val(val.value).html(val.text):$("<option>").html(val))}),dialog_content.append(div),defaultVal&&ctrl.val(defaultVal),changeCb&&ctrl.bind("change","return",changeCb),ctrl.bind("keydown","return",function(){ok.click()})}"process"===type&&ok.hide(),box.show(),ok.click(function(){box.hide();var resp="prompt"===type||"select"===type?ctrl.val():!0;callback&&(chkbx?callback(resp,chkbx.prop("checked")):callback(resp))}).focus(),("prompt"===type||"select"===type)&&ctrl.focus()};$.open_dialog=function(html,cb){dbox("dialog",html,cb)},$.alert=function(msg,cb){dbox("alert",msg,cb)},$.confirm=function(msg,cb){dbox("confirm",msg,cb)},$.process_cancel=function(msg,cb){dbox("process",msg,cb)},$.prompt=function(msg,txt,cb){dbox("prompt",msg,cb,txt)},$.select=function(msg,opts,cb,changeCb,txt,checkbox){dbox("select",msg,cb,txt,opts,changeCb,checkbox)},$.main_dialog_hide=box_hide}();var i,setSelectMode=function(){var curr=$(".tool_button_current");curr.length&&"tool_select"!==curr[0].id&&(curr.removeClass("tool_button_current").addClass("tool_button"),$("#tool_select").addClass("tool_button_current").removeClass("tool_button"),$("#styleoverrides").text("#svgcanvas svg *{cursor:move;pointer-events:all} #svgcanvas svg{cursor:default}")),svgCanvas.setMode("select"),workarea.css("cursor","auto")},textBeingEntered=!1,selectedElement=null,multiselected=!1,editingsource=!1,docprops=!1,preferences=!1,cur_context="",origTitle=$("title:first").text(),r_intervals=[];for(i=.1;1e5>i;i*=10)r_intervals.push(i),r_intervals.push(2*i),r_intervals.push(5*i);var toggleHighlightLayer=function(layerNameToHighlight){var i,curNames=[],numLayers=svgCanvas.getCurrentDrawing().getNumLayers();for(i=0;numLayers>i;i++)curNames[i]=svgCanvas.getCurrentDrawing().getLayerName(i);if(layerNameToHighlight)for(i=0;numLayers>i;++i)curNames[i]!=layerNameToHighlight&&svgCanvas.getCurrentDrawing().setLayerOpacity(curNames[i],.5);else for(i=0;numLayers>i;++i)svgCanvas.getCurrentDrawing().setLayerOpacity(curNames[i],1)},populateLayers=function(){svgCanvas.clearSelection();for(var layerlist=$("#layerlist tbody").empty(),selLayerNames=$("#selLayerNames").empty(),drawing=svgCanvas.getCurrentDrawing(),currentLayerName=drawing.getCurrentLayerName(),layer=svgCanvas.getCurrentDrawing().getNumLayers(),icon=$.getSvgIcon("eye");layer--;){var name=drawing.getLayerName(layer),layerTr=$('<tr class="layer">').toggleClass("layersel",name===currentLayerName),layerVis=$('<td class="layervis">').toggleClass("layerinvis",!drawing.getLayerVisibility(name)),layerName=$('<td class="layername">'+name+"</td>");layerlist.append(layerTr.append(layerVis,layerName)),selLayerNames.append('<option value="'+name+'">'+name+"</option>")}if(void 0!==icon){var copy=icon.clone();$("td.layervis",layerlist).append(copy),$.resizeSvgIcons({"td.layervis .svg_icon":14})}$("#layerlist td.layername").mouseup(function(evt){$("#layerlist tr.layer").removeClass("layersel"),$(this.parentNode).addClass("layersel"),svgCanvas.setCurrentLayer(this.textContent),evt.preventDefault()}).mouseover(function(){toggleHighlightLayer(this.textContent)}).mouseout(function(){toggleHighlightLayer()}),$("#layerlist td.layervis").click(function(){var row=$(this.parentNode).prevAll().length,name=$("#layerlist tr.layer:eq("+row+") td.layername").text(),vis=$(this).hasClass("layerinvis");svgCanvas.setLayerVisibility(name,vis),$(this).toggleClass("layerinvis")});for(var num=5-$("#layerlist tr.layer").size();num-->0;)layerlist.append('<tr><td style="color:white">_</td><td/></tr>')},showSourceEditor=function(e,forSaving){editingsource||(editingsource=!0,origSource=svgCanvas.getSvgString(),$("#save_output_btns").toggle(!!forSaving),$("#tool_source_back").toggle(!forSaving),$("#svg_source_textarea").val(origSource),$("#svg_source_editor").fadeIn(),$("#svg_source_textarea").focus())},togglePathEditMode=function(editmode,elems){$("#path_node_panel").toggle(editmode),$("#tools_bottom_2,#tools_bottom_3").toggle(!editmode),editmode?($(".tool_button_current").removeClass("tool_button_current").addClass("tool_button"),$("#tool_select").addClass("tool_button_current").removeClass("tool_button"),setIcon("#tool_select","select_node"),multiselected=!1,elems.length&&(selectedElement=elems[0])):setTimeout(function(){setIcon("#tool_select","select")},1e3)},saveHandler=function(wind,svg){if(editor.showSaveWarning=!1,svg='<?xml version="1.0"?>\n'+svg,svgedit.browser.isIE())return void showSourceEditor(0,!0);var win=wind.open("data:image/svg+xml;base64,"+Utils.encode64(svg)),done=$.pref("save_notice_done");if("all"!==done){var note=uiStrings.notification.saveFromBrowser.replace("%s","SVG");svgedit.browser.isGecko()?-1!==svg.indexOf("<defs")?(note+="\n\n"+uiStrings.notification.defsFailOnSave,$.pref("save_notice_done","all"),done="all"):$.pref("save_notice_done","part"):$.pref("save_notice_done","all"),"part"!==done&&win.alert(note)}};saveAs||(saveAs=function(blob){var blobUrl=URL.createObjectURL(blob);try{var xhr=new XMLHttpRequest;xhr.responseType="blob",xhr.onload=function(){var recoveredBlob=xhr.response,reader=new FileReader;reader.onload=function(){var blobAsDataUrl=reader.result;exportWindow.location.href=blobAsDataUrl},reader.readAsDataURL(recoveredBlob)},xhr.open("GET",blobUrl),xhr.send()}catch(e){exportWindow.location.href=blobUrl}});var exportHandler=function(win,data){var issues=data.issues,type=data.type||"PNG",exportWindowName=data.exportWindowName,dataURLType=("ICO"===type?"BMP":type).toLowerCase();exportWindowName&&(exportWindow=window.open("",exportWindowName)),$("#export_canvas").length||$("<canvas>",{id:"export_canvas"}).hide().appendTo("body");var c=$("#export_canvas")[0];if("PDF"===type){var res=svgCanvas.getResolution(),orientation=res.w>res.h?"landscape":"portrait",units="pt",doc=new jsPDF(orientation,units,[res.w,res.h]),docTitle=svgCanvas.getDocumentTitle();return doc.setProperties({title:docTitle}),svgElementToPdf(data.svg,doc,{}),void doc.save(docTitle+".pdf")}c.width=svgCanvas.contentW,c.height=svgCanvas.contentH,canvg(c,data.svg,{renderCallback:function(){var datauri=data.quality?c.toDataURL("image/"+dataURLType,data.quality):c.toDataURL("image/"+dataURLType);exportWindow.location.href=datauri;var done=$.pref("export_notice_done");if("all"!==done){var note=uiStrings.notification.saveFromBrowser.replace("%s",type);if(issues.length){var pre="\n  ";note+="\n\n"+uiStrings.notification.noteTheseIssues+pre+issues.join(pre)}$.pref("export_notice_done","all"),exportWindow.alert(note)}}})},operaRepaint=function(){window.opera&&$("<p/>").hide().appendTo("body").remove()},toolButtonClick=editor.toolButtonClick=function(button,noHiding){if($(button).hasClass("disabled"))return!1;if($(button).parent().hasClass("tools_flyout"))return!0;var fadeFlyouts="normal";return noHiding||$(".tools_flyout").fadeOut(fadeFlyouts),$("#styleoverrides").text(""),workarea.css("cursor","auto"),$(".tool_button_current").removeClass("tool_button_current").addClass("tool_button"),$(button).addClass("tool_button_current").removeClass("tool_button"),!0},clickSelect=editor.clickSelect=function(){toolButtonClick("#tool_select")&&(svgCanvas.setMode("select"),$("#styleoverrides").text("#svgcanvas svg *{cursor:move;pointer-events:all}, #svgcanvas svg{cursor:default}"))},setImageURL=editor.setImageURL=function(url){url||(url=defaultImageURL),svgCanvas.setImageURL(url),$("#image_url").val(url),0===url.indexOf("data:")?($("#image_url").hide(),$("#change_image_url").show()):(svgCanvas.embedImage(url,function(dataURI){$("#url_notice").toggle(!dataURI),defaultImageURL=url}),$("#image_url").show(),$("#change_image_url").hide())},setInputWidth=function(elem){var w=Math.min(Math.max(12+6*elem.value.length,50),300);$(elem).width(w)},updateCanvas=editor.updateCanvas=function(center,new_ctr){var w=workarea.width(),h=workarea.height(),w_orig=w,h_orig=h,zoom=svgCanvas.getZoom(),w_area=workarea,cnvs=$("#svgcanvas"),old_ctr={x:w_area[0].scrollLeft+w_orig/2,y:w_area[0].scrollTop+h_orig/2},multi=curConfig.canvas_expansion;w=Math.max(w_orig,svgCanvas.contentW*zoom*multi),h=Math.max(h_orig,svgCanvas.contentH*zoom*multi),w==w_orig&&h==h_orig?workarea.css("overflow","hidden"):workarea.css("overflow","scroll");var old_can_y=cnvs.height()/2,old_can_x=cnvs.width()/2;cnvs.width(w).height(h);var new_can_y=h/2,new_can_x=w/2,offset=svgCanvas.updateCanvas(w,h),ratio=new_can_x/old_can_x,scroll_x=w/2-w_orig/2,scroll_y=h/2-h_orig/2;if(new_ctr)new_ctr.x+=offset.x,new_ctr.y+=offset.y;else{var old_dist_x=old_ctr.x-old_can_x,new_x=new_can_x+old_dist_x*ratio,old_dist_y=old_ctr.y-old_can_y,new_y=new_can_y+old_dist_y*ratio;new_ctr={x:new_x,y:new_y}}center?svgCanvas.contentW>w_area.width()?(workarea[0].scrollLeft=offset.x-10,workarea[0].scrollTop=offset.y-10):(w_area[0].scrollLeft=scroll_x,w_area[0].scrollTop=scroll_y):(w_area[0].scrollLeft=new_ctr.x-w_orig/2,w_area[0].scrollTop=new_ctr.y-h_orig/2),curConfig.showRulers&&(updateRulers(cnvs,zoom),workarea.scroll()),urldata.storagePrompt===!0||editor.storagePromptClosed||$("#dialog_box").hide()},updateToolButtonState=function(){var index,button,bNoFill="none"==svgCanvas.getColor("fill"),bNoStroke="none"==svgCanvas.getColor("stroke"),buttonsNeedingStroke=["#tool_fhpath","#tool_line"],buttonsNeedingFillAndStroke=["#tools_rect .tool_button","#tools_ellipse .tool_button","#tool_text","#tool_path"];if(bNoStroke)for(index in buttonsNeedingStroke)button=buttonsNeedingStroke[index],$(button).hasClass("tool_button_current")&&clickSelect(),$(button).addClass("disabled");else for(index in buttonsNeedingStroke)button=buttonsNeedingStroke[index],$(button).removeClass("disabled");if(bNoStroke&&bNoFill)for(index in buttonsNeedingFillAndStroke)button=buttonsNeedingFillAndStroke[index],$(button).hasClass("tool_button_current")&&clickSelect(),$(button).addClass("disabled");else for(index in buttonsNeedingFillAndStroke)button=buttonsNeedingFillAndStroke[index],$(button).removeClass("disabled");svgCanvas.runExtensions("toolButtonStateUpdate",{nofill:bNoFill,nostroke:bNoStroke}),$(".tools_flyout").each(function(){var shower=$("#"+this.id+"_show"),has_enabled=!1;$(this).children().each(function(){$(this).hasClass("disabled")||(has_enabled=!0)}),shower.toggleClass("disabled",!has_enabled)}),operaRepaint()},updateToolbar=function(){var i,len;if(null!=selectedElement)switch(selectedElement.tagName){case"use":case"image":case"foreignObject":break;case"g":case"a":var gWidth=null,childs=selectedElement.getElementsByTagName("*");for(i=0,len=childs.length;len>i;i++){var swidth=childs[i].getAttribute("stroke-width");0===i?gWidth=swidth:gWidth!==swidth&&(gWidth=null)}$("#stroke_width").val(null===gWidth?"":gWidth),paintBox.fill.update(!0),paintBox.stroke.update(!0);break;default:paintBox.fill.update(!0),paintBox.stroke.update(!0),$("#stroke_width").val(selectedElement.getAttribute("stroke-width")||1),$("#stroke_style").val(selectedElement.getAttribute("stroke-dasharray")||"none");var attr=selectedElement.getAttribute("stroke-linejoin")||"miter";0!=$("#linejoin_"+attr).length&&setStrokeOpt($("#linejoin_"+attr)[0]),attr=selectedElement.getAttribute("stroke-linecap")||"butt",0!=$("#linecap_"+attr).length&&setStrokeOpt($("#linecap_"+attr)[0])}if(null!=selectedElement){var opac_perc=100*(selectedElement.getAttribute("opacity")||1);$("#group_opacity").val(opac_perc),$("#opac_slider").slider("option","value",opac_perc),$("#elem_id").val(selectedElement.id)}updateToolButtonState()},updateContextPanel=function(){var elem=selectedElement;null==elem||elem.parentNode||(elem=null);var currentLayerName=svgCanvas.getCurrentDrawing().getCurrentLayerName(),currentMode=svgCanvas.getMode(),unit="px"!==curConfig.baseUnit?curConfig.baseUnit:null,is_node="pathedit"==currentMode,menu_items=$("#cmenu_canvas li");if($("#selected_panel, #multiselected_panel, #g_panel, #rect_panel, #circle_panel,#ellipse_panel, #line_panel, #text_panel, #image_panel, #container_panel, #use_panel, #a_panel").hide(),null!=elem){var elname=elem.nodeName,angle=svgCanvas.getRotationAngle(elem);$("#angle").val(angle);var blurval=svgCanvas.getBlur(elem);if($("#blur").val(blurval),$("#blur_slider").slider("option","value",blurval),svgCanvas.addedNew&&"image"===elname&&0!==svgCanvas.getHref(elem).indexOf("data:")&&promptImgURL(),is_node||"pathedit"==currentMode){var point=path.getNodePoint();if($("#tool_add_subpath").removeClass("push_button_pressed").addClass("tool_button"),$("#tool_node_delete").toggleClass("disabled",!path.canDeleteNodes),setIcon("#tool_openclose_path",path.closed_subpath?"open_path":"close_path"),point){var seg_type=$("#seg_type");unit&&(point.x=svgedit.units.convertUnit(point.x),point.y=svgedit.units.convertUnit(point.y)),$("#path_node_x").val(point.x),$("#path_node_y").val(point.y),point.type?seg_type.val(point.type).removeAttr("disabled"):seg_type.val(4).attr("disabled","disabled")}return}if($("#selected_panel").show(),["line","circle","ellipse"].indexOf(elname)>=0)$("#xy_panel").hide();else{var x,y;if(["g","polyline","path"].indexOf(elname)>=0){var bb=svgCanvas.getStrokedBBox([elem]);bb&&(x=bb.x,y=bb.y)}else x=elem.getAttribute("x"),y=elem.getAttribute("y");unit&&(x=svgedit.units.convertUnit(x),y=svgedit.units.convertUnit(y)),$("#selected_x").val(x||0),$("#selected_y").val(y||0),$("#xy_panel").show()}var no_path=-1==["image","text","path","g","use"].indexOf(elname);$("#tool_topath").toggle(no_path),$("#tool_reorient").toggle("path"===elname),$("#tool_reorient").toggleClass("disabled",0===angle);var panels={g:[],a:[],rect:["rx","width","height"],image:["width","height"],circle:["cx","cy","r"],ellipse:["cx","cy","rx","ry"],line:["x1","y1","x2","y2"],text:[],use:[]},el_name=elem.tagName,link_href=null;if("a"===el_name&&(link_href=svgCanvas.getHref(elem),$("#g_panel").show()),"a"===elem.parentNode.tagName&&($(elem).siblings().length||($("#a_panel").show(),link_href=svgCanvas.getHref(elem.parentNode))),$("#tool_make_link, #tool_make_link").toggle(!link_href),link_href&&$("#link_url").val(link_href),panels[el_name]){var cur_panel=panels[el_name];if($("#"+el_name+"_panel").show(),$.each(cur_panel,function(i,item){var attrVal=elem.getAttribute(item);if("px"!==curConfig.baseUnit&&elem[item]){var bv=elem[item].baseVal.value;attrVal=svgedit.units.convertUnit(bv)}$("#"+el_name+"_"+item).val(attrVal||0)}),"text"==el_name)$("#text_panel").css("display","inline"),svgCanvas.getItalic()?$("#tool_italic").addClass("push_button_pressed").removeClass("tool_button"):$("#tool_italic").removeClass("push_button_pressed").addClass("tool_button"),svgCanvas.getBold()?$("#tool_bold").addClass("push_button_pressed").removeClass("tool_button"):$("#tool_bold").removeClass("push_button_pressed").addClass("tool_button"),$("#font_family").val(elem.getAttribute("font-family")),$("#font_size").val(elem.getAttribute("font-size")),$("#text").val(elem.textContent),svgCanvas.addedNew&&setTimeout(function(){$("#text").focus().select()},100);else if("image"==el_name)setImageURL(svgCanvas.getHref(elem));else if("g"===el_name||"use"===el_name){$("#container_panel").show();var title=svgCanvas.getTitle(),label=$("#g_title")[0];label.value=title,setInputWidth(label),$("#g_title").prop("disabled","use"==el_name)}}menu_items[("g"===el_name?"en":"dis")+"ableContextMenuItems"]("#ungroup"),menu_items[("g"!==el_name&&multiselected?"en":"dis")+"ableContextMenuItems"]("#group")}else multiselected?($("#multiselected_panel").show(),menu_items.enableContextMenuItems("#group").disableContextMenuItems("#ungroup")):menu_items.disableContextMenuItems("#delete,#cut,#copy,#group,#ungroup,#move_front,#move_up,#move_down,#move_back");$("#tool_undo").toggleClass("disabled",0===undoMgr.getUndoStackSize()),$("#tool_redo").toggleClass("disabled",0===undoMgr.getRedoStackSize()),svgCanvas.addedNew=!1,elem&&!is_node||multiselected?($("#selLayerNames").removeAttr("disabled").val(currentLayerName),canv_menu.enableContextMenuItems("#delete,#cut,#copy,#move_front,#move_up,#move_down,#move_back")):$("#selLayerNames").attr("disabled","disabled")
},updateWireFrame=function(){if(!supportsNonSS){var rule="#workarea.wireframe #svgcontent * { stroke-width: "+1/svgCanvas.getZoom()+"px; }";$("#wireframe_rules").text(workarea.hasClass("wireframe")?rule:"")}},updateTitle=function(title){title=title||svgCanvas.getDocumentTitle();var newTitle=origTitle+(title?": "+title:"");$("title:first").text(newTitle)},selectedChanged=function(win,elems){var mode=svgCanvas.getMode();"select"===mode&&setSelectMode();var is_node="pathedit"==mode;selectedElement=1===elems.length||null==elems[1]?elems[0]:null,multiselected=elems.length>=2&&null!=elems[1],null!=selectedElement&&(is_node||updateToolbar()),togglePathEditMode(is_node,elems),updateContextPanel(),svgCanvas.runExtensions("selectedChanged",{elems:elems,selectedElement:selectedElement,multiselected:multiselected})},elementTransition=function(win,elems){var mode=svgCanvas.getMode(),elem=elems[0];if(elem){if(multiselected=elems.length>=2&&null!=elems[1],!multiselected)switch(mode){case"rotate":var ang=svgCanvas.getRotationAngle(elem);$("#angle").val(ang),$("#tool_reorient").toggleClass("disabled",0===ang)}svgCanvas.runExtensions("elementTransition",{elems:elems})}},elementChanged=function(win,elems){var i,mode=svgCanvas.getMode();for("select"===mode&&setSelectMode(),i=0;i<elems.length;++i){var elem=elems[i];elem&&"svg"===elem.tagName?(populateLayers(),updateCanvas()):elem&&selectedElement&&null==selectedElement.parentNode&&(selectedElement=elem)}editor.showSaveWarning=!0,updateContextPanel(),selectedElement&&"select"===mode&&(paintBox.fill.update(),paintBox.stroke.update()),svgCanvas.runExtensions("elementChanged",{elems:elems})},zoomDone=function(){updateWireFrame()},zoomChanged=svgCanvas.zoomChanged=function(win,bbox,autoCenter){var scrbar=15,w_area=workarea,z_info=svgCanvas.setBBoxZoom(bbox,w_area.width()-scrbar,w_area.height()-scrbar);if(z_info){var zoomlevel=z_info.zoom,bb=z_info.bbox;if(.001>zoomlevel)return void changeZoom({value:.1});$("#zoom").val((100*zoomlevel).toFixed(1)),autoCenter?updateCanvas():updateCanvas(!1,{x:bb.x*zoomlevel+bb.width*zoomlevel/2,y:bb.y*zoomlevel+bb.height*zoomlevel/2}),"zoom"==svgCanvas.getMode()&&bb.width&&setSelectMode(),zoomDone()}};changeZoom=function(ctl){var zoomlevel=ctl.value/100;if(.001>zoomlevel)return void(ctl.value=.1);var zoom=svgCanvas.getZoom(),w_area=workarea;zoomChanged(window,{width:0,height:0,x:(w_area[0].scrollLeft+w_area.width()/2)/zoom,y:(w_area[0].scrollTop+w_area.height()/2)/zoom,zoom:zoomlevel},!0)},$("#cur_context_panel").delegate("a","click",function(){var link=$(this);return link.attr("data-root")?svgCanvas.leaveContext():svgCanvas.setContext(link.text()),svgCanvas.clearSelection(),!1});var contextChanged=function(win,context){var link_str="";if(context){var str="";link_str='<a href="#" data-root="y">'+svgCanvas.getCurrentDrawing().getCurrentLayerName()+"</a>",$(context).parentsUntil("#svgcontent > g").andSelf().each(function(){this.id&&(str+=" > "+this.id,link_str+=this!==context?' > <a href="#">'+this.id+"</a>":" > "+this.id)}),cur_context=str}else cur_context=null;$("#cur_context_panel").toggle(!!context).html(link_str),updateTitle()},prepPaints=function(){paintBox.fill.prep(),paintBox.stroke.prep()},flyout_funcs={},setFlyoutTitles=function(){$(".tools_flyout").each(function(){var shower=$("#"+this.id+"_show");if(!shower.data("isLibrary")){var tooltips=[];$(this).children().each(function(){tooltips.push(this.title)}),shower[0].title=tooltips.join(" / ")}})},setFlyoutPositions=function(){$(".tools_flyout").each(function(){var shower=$("#"+this.id+"_show"),pos=shower.offset(),w=shower.outerWidth();$(this).css({left:(pos.left+w)*editor.tool_scale,top:pos.top})})},setupFlyouts=function(holders){$.each(holders,function(hold_sel,btn_opts){var buttons=$(hold_sel).children(),show_sel=hold_sel+"_show",shower=$(show_sel),def=!1;buttons.addClass("tool_button").unbind("click mousedown mouseup").each(function(i){var opts=btn_opts[i];flyout_funcs[opts.sel]=opts.fn,opts.isDefault&&(def=i);var func=function(event){var options=opts;if("keydown"===event.type){var flyoutIsSelected=$(options.parent+"_show").hasClass("tool_button_current"),currentOperation=$(options.parent+"_show").attr("data-curopt");$.each(holders[opts.parent],function(i,tool){tool.sel==currentOperation&&(options=event.shiftKey&&flyoutIsSelected?holders[opts.parent][i+1]||holders[opts.parent][0]:tool)})}if($(this).hasClass("disabled"))return!1;toolButtonClick(show_sel)&&options.fn();var icon;icon=options.icon?$.getSvgIcon(options.icon,!0):$(options.sel).children().eq(0).clone(),icon[0].setAttribute("width",shower.width()),icon[0].setAttribute("height",shower.height()),shower.children(":not(.flyout_arrow_horiz)").remove(),shower.append(icon).attr("data-curopt",options.sel)};$(this).mouseup(func),opts.key&&$(document).bind("keydown",opts.key[0]+" shift+"+opts.key[0],func)}),def?shower.attr("data-curopt",btn_opts[def].sel):shower.attr("data-curopt")||shower.attr("data-curopt",btn_opts[0].sel);var timer,pos=$(show_sel).position();shower.mousedown(function(evt){if(shower.hasClass("disabled"))return!1;var holder=$(hold_sel),l=pos.left+34,w=-1*holder.width(),time=holder.data("shown_popop")?200:0;timer=setTimeout(function(){shower.data("isLibrary")?holder.css("left",l).show():holder.css("left",w).show().animate({left:l},150),holder.data("shown_popop",!0)},time),evt.preventDefault()}).mouseup(function(){clearTimeout(timer);var opt=$(this).attr("data-curopt");return shower.data("isLibrary")&&$(show_sel.replace("_show","")).is(":visible")?void toolButtonClick(show_sel,!0):void(toolButtonClick(show_sel)&&flyout_funcs[opt]&&flyout_funcs[opt]())})}),setFlyoutTitles(),setFlyoutPositions()},makeFlyoutHolder=function(id,child){var div=$("<div>",{"class":"tools_flyout",id:id}).appendTo("#svg_editor").append(child);return div},uaPrefix=function(){var prop,regex=/^(Moz|Webkit|Khtml|O|ms|Icab)(?=[A-Z])/,someScript=document.getElementsByTagName("script")[0];for(prop in someScript.style)if(regex.test(prop))return prop.match(regex)[0];return"WebkitOpacity"in someScript.style?"Webkit":"KhtmlOpacity"in someScript.style?"Khtml":""}(),scaleElements=function(elems,scale){var sides=["top","left","bottom","right"];elems.each(function(){var i,el=$(this),w=el.outerWidth()*(scale-1),h=el.outerHeight()*(scale-1);for(i=0;4>i;i++){var s=sides[i],cur=el.data("orig_margin-"+s);null==cur&&(cur=parseInt(el.css("margin-"+s),10),el.data("orig_margin-"+s,cur));var val=cur*scale;"right"===s?val+=w:"bottom"===s&&(val+=h),el.css("margin-"+s,val)}})},setIconSize=editor.setIconSize=function(size){var sel_toscale="#tools_top .toolset, #editor_panel > *, #history_panel > *,				#main_button, #tools_left > *, #path_node_panel > *, #multiselected_panel > *,				#g_panel > *, #tool_font_size > *, .tools_flyout",elems=$(sel_toscale),scale=1;if("number"==typeof size)scale=size;else{var icon_sizes={s:.75,m:1,l:1.25,xl:1.5};scale=icon_sizes[size]}editor.tool_scale=scale,setFlyoutPositions();var hidden_ps=elems.parents(":hidden");hidden_ps.css("visibility","hidden").show(),scaleElements(elems,scale),hidden_ps.css("visibility","visible").hide(),$.pref("iconsize",size),$("#iconsize").val(size);var cssResizeRules={"#tools_top":{left:50+$("#main_button").width(),height:72},"#tools_left":{width:31,top:74},"div#workarea":{left:38,top:74}},rule_elem=$("#tool_size_rules");if(rule_elem.length?rule_elem.empty():rule_elem=$('<style id="tool_size_rules"></style>').appendTo("head"),"m"!==size){var styleStr="";$.each(cssResizeRules,function(selector,rules){selector="#svg_editor "+selector.replace(/,/g,", #svg_editor"),styleStr+=selector+"{",$.each(rules,function(prop,values){var val;"number"==typeof values?val=values*scale+"px":(values[size]||values.all)&&(val=values[size]||values.all),styleStr+=prop+":"+val+";"}),styleStr+="}"});var prefix="-"+uaPrefix.toLowerCase()+"-";styleStr+=sel_toscale+"{"+prefix+"transform: scale("+scale+");} #svg_editor div.toolset .toolset {"+prefix+"transform: scale(1); margin: 1px !important;} #svg_editor .ui-slider {"+prefix+"transform: scale("+1/scale+");}",rule_elem.text(styleStr)}setFlyoutPositions()},addAltDropDown=function(elem,list,callback,opts){var button=$(elem);list=$(list);var on_button=!1,dropUp=opts.dropUp;dropUp&&$(elem).addClass("dropup"),list.find("li").bind("mouseup",function(){opts.seticon&&(setIcon("#cur_"+button[0].id,$(this).children()),$(this).addClass("current").siblings().removeClass("current")),callback.apply(this,arguments)}),$(window).mouseup(function(){on_button||(button.removeClass("down"),list.hide(),list.css({top:0,left:0})),on_button=!1}),button.bind("mousedown",function(){var off=button.offset();dropUp?(off.top-=list.height(),off.left+=8):off.top+=button.height(),list.offset(off),button.hasClass("down")?(list.hide(),list.css({top:0,left:0})):(list.show(),on_button=!0),button.toggleClass("down")}).hover(function(){on_button=!0}).mouseout(function(){on_button=!1}),opts.multiclick&&list.mousedown(function(){on_button=!0})},extsPreLang=[],extAdded=function(win,ext){function prepResize(){resize_timer&&(clearTimeout(resize_timer),resize_timer=null),resize_done||(resize_timer=setTimeout(function(){resize_done=!0,setIconSize($.pref("iconsize"))},50))}if(ext){var cb_called=!1,resize_done=!1,cb_ready=!0;if(ext.langReady)if(editor.langChanged){var lang=$.pref("lang");ext.langReady({lang:lang,uiStrings:uiStrings})}else extsPreLang.push(ext);var runCallback=function(){ext.callback&&!cb_called&&cb_ready&&(cb_called=!0,ext.callback())},btn_selects=[];if(ext.context_tools&&$.each(ext.context_tools,function(i,tool){var html,cont_id=tool.container_id?' id="'+tool.container_id+'"':"",panel=$("#"+tool.panel);switch(panel.length||(panel=$("<div>",{id:tool.panel}).appendTo("#tools_top")),tool.type){case"tool_button":html='<div class="tool_button">'+tool.id+"</div>";var div=$(html).appendTo(panel);tool.events&&$.each(tool.events,function(evt,func){$(div).bind(evt,func)});break;case"select":html="<label"+cont_id+'><select id="'+tool.id+'">',$.each(tool.options,function(val,text){var sel=val==tool.defval?" selected":"";html+='<option value="'+val+'"'+sel+">"+text+"</option>"}),html+="</select></label>";var sel=$(html).appendTo(panel).find("select");$.each(tool.events,function(evt,func){$(sel).bind(evt,func)});break;case"button-select":html='<div id="'+tool.id+'" class="dropdown toolset" title="'+tool.title+'"><div id="cur_'+tool.id+'" class="icon_label"></div><button></button></div>';var list=$('<ul id="'+tool.id+'_opts"></ul>').appendTo("#option_lists");tool.colnum&&list.addClass("optcols"+tool.colnum);{$(html).appendTo(panel).children()}btn_selects.push({elem:"#"+tool.id,list:"#"+tool.id+"_opts",title:tool.title,callback:tool.events.change,cur:"#cur_"+tool.id});break;case"input":html="<label"+cont_id+'><span id="'+tool.id+'_label">'+tool.label+':</span><input id="'+tool.id+'" title="'+tool.title+'" size="'+(tool.size||"4")+'" value="'+(tool.defval||"")+'" type="text"/></label>';var inp=$(html).appendTo(panel).find("input");tool.spindata&&inp.SpinButton(tool.spindata),tool.events&&$.each(tool.events,function(evt,func){inp.bind(evt,func)})}}),ext.buttons){var fallback_obj={},placement_obj={},svgicons=ext.svgicons,holders={};$.each(ext.buttons,function(i,btn){for(var icon,svgicon,tls_id,id=btn.id,num=i;$("#"+id).length;)id=btn.id+"_"+ ++num;svgicons?(fallback_obj[id]=btn.icon,svgicon=btn.svgicon||btn.id,"app_menu"==btn.type?placement_obj["#"+id+" > div"]=svgicon:placement_obj["#"+id]=svgicon):icon=$('<img src="'+btn.icon+'">');var cls,parent;switch(btn.type){case"mode_flyout":case"mode":cls="tool_button",parent="#tools_left";break;case"context":cls="tool_button",parent="#"+btn.panel,$(parent).length||$("<div>",{id:btn.panel}).appendTo("#tools_top");break;case"app_menu":cls="",parent="#main_menu ul"}var flyout_holder,cur_h,show_btn,ref_data,ref_btn,button=$(btn.list||"app_menu"==btn.type?"<li/>":"<div/>").attr("id",id).attr("title",btn.title).addClass(cls);if(btn.includeWith||btn.list){if(btn.list)button.addClass("push_button"),$("#"+btn.list+"_opts").append(button),btn.isDefault&&($("#cur_"+btn.list).append(button.children().clone()),svgicon=btn.svgicon||btn.id,placement_obj["#cur_"+btn.list]=svgicon);else if(btn.includeWith){var opts=btn.includeWith;ref_btn=$(opts.button),flyout_holder=ref_btn.parent(),ref_btn.parent().hasClass("tools_flyout")||(tls_id=ref_btn[0].id.replace("tool_","tools_"),show_btn=ref_btn.clone().attr("id",tls_id+"_show").append($("<div>",{"class":"flyout_arrow_horiz"})),ref_btn.before(show_btn),flyout_holder=makeFlyoutHolder(tls_id,ref_btn)),ref_data=Actions.getButtonData(opts.button),opts.isDefault&&(placement_obj["#"+tls_id+"_show"]=btn.id),cur_h=holders["#"+flyout_holder[0].id]=[{sel:"#"+id,fn:btn.events.click,icon:btn.id,key:btn.key,isDefault:btn.includeWith?btn.includeWith.isDefault:0},ref_data];var pos="position"in opts?opts.position:"last",len=flyout_holder.children().length;!isNaN(pos)&&pos>=0&&len>pos?flyout_holder.children().eq(pos).before(button):(flyout_holder.append(button),cur_h.reverse())}}else"position"in btn?$(parent).children().eq(btn.position).length?$(parent).children().eq(btn.position).before(button):$(parent).children().last().before(button):button.appendTo(parent),"mode_flyout"==btn.type?(ref_btn=$(button),flyout_holder=ref_btn.parent(),ref_btn.parent().hasClass("tools_flyout")||(tls_id=ref_btn[0].id.replace("tool_","tools_"),show_btn=ref_btn.clone().attr("id",tls_id+"_show").append($("<div>",{"class":"flyout_arrow_horiz"})),ref_btn.before(show_btn),flyout_holder=makeFlyoutHolder(tls_id,ref_btn),flyout_holder.data("isLibrary",!0),show_btn.data("isLibrary",!0)),placement_obj["#"+tls_id+"_show"]=btn.id,cur_h=holders["#"+flyout_holder[0].id]=[{sel:"#"+id,fn:btn.events.click,icon:btn.id,isDefault:!0},ref_data]):"app_menu"==btn.type&&button.append("<div>").append(btn.title);svgicons||button.append(icon),btn.list||$.each(btn.events,function(name,func){"click"==name&&"mode"==btn.type?(btn.includeWith?button.bind(name,func):button.bind(name,function(){toolButtonClick(button)&&func()}),btn.key&&($(document).bind("keydown",btn.key,func),btn.title&&button.attr("title",btn.title+" ["+btn.key+"]"))):button.bind(name,func)}),setupFlyouts(holders)}),$.each(btn_selects,function(){addAltDropDown(this.elem,this.list,this.callback,{seticon:!0})}),svgicons&&(cb_ready=!1),$.svgIcons(svgicons,{w:24,h:24,id_match:!1,no_img:!svgedit.browser.isWebkit(),fallback:fallback_obj,placement:placement_obj,callback:function(){"m"!==$.pref("iconsize")&&prepResize(),cb_ready=!0,runCallback()}})}runCallback()}},getPaint=function(color,opac,type){var opts={alpha:opac};if(0===color.indexOf("url(#")){var refElem=svgCanvas.getRefElem(color);refElem=refElem?refElem.cloneNode(!0):$("#"+type+"_color defs *")[0],opts[refElem.tagName]=refElem}else opts.solidColor=0===color.indexOf("#")?color.substr(1):"none";return new $.jGraduate.Paint(opts)};$("#text").focus(function(){textBeingEntered=!0}),$("#text").blur(function(){textBeingEntered=!1}),svgCanvas.bind("selected",selectedChanged),svgCanvas.bind("transition",elementTransition),svgCanvas.bind("changed",elementChanged),svgCanvas.bind("saved",saveHandler),svgCanvas.bind("exported",checkCanvg(exportHandler)),svgCanvas.bind("zoomed",zoomChanged),svgCanvas.bind("contextset",contextChanged),svgCanvas.bind("extension_added",extAdded),svgCanvas.textActions.setInputElem($("#text")[0]);var str='<div class="palette_item" data-rgb="none"></div>';$.each(palette,function(i,item){str+='<div class="palette_item" style="background-color: '+item+';" data-rgb="'+item+'"></div>'}),$("#palette").append(str);var color_blocks=["#FFF","#888","#000"];str="",$.each(color_blocks,function(){str+='<div class="color_block" style="background-color:'+this+';"></div>'}),$("#bg_blocks").append(str);var blocks=$("#bg_blocks div"),cur_bg="cur_background";blocks.each(function(){var blk=$(this);blk.click(function(){blocks.removeClass(cur_bg),$(this).addClass(cur_bg)})}),setBackground($.pref("bkgd_color"),$.pref("bkgd_url")),$("#image_save_opts input").val([$.pref("img_save")]);var changeRectRadius=function(ctl){svgCanvas.setRectRadius(ctl.value)},changeFontSize=function(ctl){svgCanvas.setFontSize(ctl.value)},changeStrokeWidth=function(ctl){var val=ctl.value;0==val&&selectedElement&&["line","polyline"].indexOf(selectedElement.nodeName)>=0&&(val=ctl.value=1),svgCanvas.setStrokeWidth(val)},changeRotationAngle=function(ctl){svgCanvas.setRotationAngle(ctl.value),$("#tool_reorient").toggleClass("disabled",0===parseInt(ctl.value,10))},changeOpacity=function(ctl,val){null==val&&(val=ctl.value),$("#group_opacity").val(val),ctl&&ctl.handle||$("#opac_slider").slider("option","value",val),svgCanvas.setOpacity(val/100)},changeBlur=function(ctl,val,noUndo){null==val&&(val=ctl.value),$("#blur").val(val);var complete=!1;ctl&&ctl.handle||($("#blur_slider").slider("option","value",val),complete=!0),noUndo?svgCanvas.setBlurNoUndo(val):svgCanvas.setBlur(val,complete)};$("#stroke_style").change(function(){svgCanvas.setStrokeAttr("stroke-dasharray",$(this).val()),operaRepaint()}),$("#stroke_linejoin").change(function(){svgCanvas.setStrokeAttr("stroke-linejoin",$(this).val()),operaRepaint()}),$("select").change(function(){$(this).blur()});var promptMoveLayerOnce=!1;$("#selLayerNames").change(function(){var destLayer=this.options[this.selectedIndex].value,confirmStr=uiStrings.notification.QmoveElemsToLayer.replace("%s",destLayer),moveToLayer=function(ok){ok&&(promptMoveLayerOnce=!0,svgCanvas.moveSelectedToLayer(destLayer),svgCanvas.clearSelection(),populateLayers())};destLayer&&(promptMoveLayerOnce?moveToLayer(!0):$.confirm(confirmStr,moveToLayer))}),$("#font_family").change(function(){svgCanvas.setFontFamily(this.value)}),$("#seg_type").change(function(){svgCanvas.setSegType($(this).val())}),$("#text").keyup(function(){svgCanvas.setTextContent(this.value)}),$("#image_url").change(function(){setImageURL(this.value)}),$("#link_url").change(function(){this.value.length?svgCanvas.setLinkURL(this.value):svgCanvas.removeHyperlink()}),$("#g_title").change(function(){svgCanvas.setGroupTitle(this.value)}),$(".attr_changer").change(function(){var attr=this.getAttribute("data-attr"),val=this.value,valid=svgedit.units.isValidUnit(attr,val,selectedElement);if(!valid)return $.alert(uiStrings.notification.invalidAttrValGiven),this.value=selectedElement.getAttribute(attr),!1;if("id"!==attr)if(isNaN(val))val=svgCanvas.convertToNum(attr,val);else if("px"!==curConfig.baseUnit){var unitData=svgedit.units.getTypeMap();(selectedElement[attr]||"pathedit"===svgCanvas.getMode()||"x"===attr||"y"===attr)&&(val*=unitData[curConfig.baseUnit])}if("id"===attr){var elem=selectedElement;svgCanvas.clearSelection(),elem.id=val,svgCanvas.addToSelection([elem],!0)}else svgCanvas.changeSelectedAttribute(attr,val);this.blur()}),$("#palette").mouseover(function(){var inp=$('<input type="hidden">');$(this).append(inp),inp.focus().remove()}),$(".palette_item").mousedown(function(evt){var paint,picker=evt.shiftKey||2===evt.button?"stroke":"fill",color=$(this).data("rgb");"none"===color||"transparent"===color||"initial"===color?(color="none",paint=new $.jGraduate.Paint):paint=new $.jGraduate.Paint({alpha:100,solidColor:color.substr(1)}),paintBox[picker].setPaint(paint),svgCanvas.setColor(picker,color),"none"!==color&&1!==svgCanvas.getPaintOpacity(picker)&&svgCanvas.setPaintOpacity(picker,1),updateToolButtonState()}).bind("contextmenu",function(e){e.preventDefault()}),$("#toggle_stroke_tools").on("click",function(){$("#tools_bottom").toggleClass("expanded")}),function(){var last_x=null,last_y=null,w_area=workarea[0],panning=!1,keypan=!1;$("#svgcanvas").bind("mousemove mouseup",function(evt){return panning!==!1?(w_area.scrollLeft-=evt.clientX-last_x,w_area.scrollTop-=evt.clientY-last_y,last_x=evt.clientX,last_y=evt.clientY,"mouseup"===evt.type&&(panning=!1),!1):void 0}).mousedown(function(evt){return 1===evt.button||keypan===!0?(panning=!0,last_x=evt.clientX,last_y=evt.clientY,!1):void 0}),$(window).mouseup(function(){panning=!1}),$(document).bind("keydown","space",function(evt){svgCanvas.spaceKey=keypan=!0,evt.preventDefault()}).bind("keyup","space",function(evt){evt.preventDefault(),svgCanvas.spaceKey=keypan=!1}).bind("keydown","shift",function(){"zoom"===svgCanvas.getMode()&&workarea.css("cursor",zoomOutIcon)}).bind("keyup","shift",function(){"zoom"===svgCanvas.getMode()&&workarea.css("cursor",zoomInIcon)}),editor.setPanning=function(active){svgCanvas.spaceKey=keypan=active}}(),function(){var button=$("#main_icon"),overlay=$("#main_icon span"),list=$("#main_menu"),on_button=!1,height=0,js_hover=!0,set_click=!1;$(window).mouseup(function(evt){on_button||(button.removeClass("buttondown"),"INPUT"!=evt.target.tagName?list.fadeOut(200):set_click||(set_click=!0,$(evt.target).click(function(){list.css("margin-left","-9999px").show()}))),on_button=!1}).mousedown(function(evt){var islib=$(evt.target).closest("div.tools_flyout, .contextMenu").length;islib||$(".tools_flyout:visible,.contextMenu").fadeOut(250)}),overlay.bind("mousedown",function(){button.hasClass("buttondown")?list.fadeOut(200):(list.css("margin-left",0).show(),height||(height=list.height()),list.css("height",0).animate({height:height},200),on_button=!0),button.toggleClass("buttondown buttonup")}).hover(function(){on_button=!0}).mouseout(function(){on_button=!1});var list_items=$("#main_menu li");list_items.mouseover(function(){js_hover="rgba(0, 0, 0, 0)"==$(this).css("background-color"),list_items.unbind("mouseover"),js_hover&&list_items.mouseover(function(){this.style.backgroundColor="#FFC"}).mouseout(function(){return this.style.backgroundColor="transparent",!0})})}(),editor.addDropDown=function(elem,callback,dropUp){if(0!=$(elem).length){var button=$(elem).find("button"),list=$(elem).find("ul").attr("id",$(elem)[0].id+"-list"),on_button=!1;dropUp?$(elem).addClass("dropup"):$("#option_lists").append(list),list.find("li").bind("mouseup",callback),$(window).mouseup(function(){on_button||(button.removeClass("down"),list.hide()),on_button=!1}),button.bind("mousedown",function(){if(button.hasClass("down"))list.hide();else{if(!dropUp){var pos=$(elem).position();list.css({top:pos.top+24,left:pos.left-10})}list.show(),on_button=!0}button.toggleClass("down")}).hover(function(){on_button=!0}).mouseout(function(){on_button=!1})}},editor.addDropDown("#font_family_dropdown",function(){$("#font_family").val($(this).text()).change()}),editor.addDropDown("#opacity_dropdown",function(){if(!$(this).find("div").length){var perc=parseInt($(this).text().split("%")[0],10);changeOpacity(!1,perc)}},!0),$("#opac_slider").slider({start:function(){$("#opacity_dropdown li:not(.special)").hide()},stop:function(){$("#opacity_dropdown li").show(),$(window).mouseup()},slide:function(evt,ui){changeOpacity(ui)}}),editor.addDropDown("#blur_dropdown",$.noop);var slideStart=!1;$("#blur_slider").slider({max:10,step:.1,stop:function(evt,ui){slideStart=!1,changeBlur(ui),$("#blur_dropdown li").show(),$(window).mouseup()},start:function(){slideStart=!0},slide:function(evt,ui){changeBlur(ui,null,slideStart)}}),editor.addDropDown("#zoom_dropdown",function(){var item=$(this),val=item.data("val");val?zoomChanged(window,val):changeZoom({value:parseFloat(item.text())})},!0),addAltDropDown("#stroke_linecap","#linecap_opts",function(){setStrokeOpt(this,!0)},{dropUp:!0}),addAltDropDown("#stroke_linejoin","#linejoin_opts",function(){setStrokeOpt(this,!0)},{dropUp:!0}),addAltDropDown("#tool_position","#position_opts",function(){var letter=this.id.replace("tool_pos","").charAt(0);svgCanvas.alignSelectedElements(letter,"page")},{multiclick:!0}),function(){var inp,unfocus=function(){$(inp).blur()};$("#svg_editor").find("button, select, input:not(#text)").focus(function(){inp=this,ui_context="toolbars",workarea.mousedown(unfocus)}).blur(function(){ui_context="canvas",workarea.unbind("mousedown",unfocus),"textedit"==svgCanvas.getMode()&&$("#text").focus()})}();var clickFHPath=function(){toolButtonClick("#tool_fhpath")&&svgCanvas.setMode("fhpath")},clickLine=function(){toolButtonClick("#tool_line")&&svgCanvas.setMode("line")},clickSquare=function(){toolButtonClick("#tool_square")&&svgCanvas.setMode("square")},clickRect=function(){toolButtonClick("#tool_rect")&&svgCanvas.setMode("rect")},clickFHRect=function(){toolButtonClick("#tool_fhrect")&&svgCanvas.setMode("fhrect")},clickCircle=function(){toolButtonClick("#tool_circle")&&svgCanvas.setMode("circle")},clickEllipse=function(){toolButtonClick("#tool_ellipse")&&svgCanvas.setMode("ellipse")},clickFHEllipse=function(){toolButtonClick("#tool_fhellipse")&&svgCanvas.setMode("fhellipse")},clickImage=function(){toolButtonClick("#tool_image")&&svgCanvas.setMode("image")},clickZoom=function(){toolButtonClick("#tool_zoom")&&(svgCanvas.setMode("zoom"),workarea.css("cursor",zoomInIcon))},zoomImage=function(multiplier){var res=svgCanvas.getResolution();multiplier=multiplier?res.zoom*multiplier:1,$("#zoom").val(100*multiplier),svgCanvas.setZoom(multiplier),zoomDone(),updateCanvas(!0)},dblclickZoom=function(){toolButtonClick("#tool_zoom")&&(zoomImage(),setSelectMode())},clickText=function(){toolButtonClick("#tool_text")&&svgCanvas.setMode("text")},clickPath=function(){toolButtonClick("#tool_path")&&svgCanvas.setMode("path")},deleteSelected=function(){(null!=selectedElement||multiselected)&&svgCanvas.deleteSelectedElements()},cutSelected=function(){(null!=selectedElement||multiselected)&&svgCanvas.cutSelectedElements()},copySelected=function(){(null!=selectedElement||multiselected)&&svgCanvas.copySelectedElements()},pasteInCenter=function(){var zoom=svgCanvas.getZoom(),x=(workarea[0].scrollLeft+workarea.width()/2)/zoom-svgCanvas.contentW,y=(workarea[0].scrollTop+workarea.height()/2)/zoom-svgCanvas.contentH;svgCanvas.pasteElements("point",x,y)},moveToTopSelected=function(){null!=selectedElement&&svgCanvas.moveToTopSelectedElement()},moveToBottomSelected=function(){null!=selectedElement&&svgCanvas.moveToBottomSelectedElement()},moveUpDownSelected=function(dir){null!=selectedElement&&svgCanvas.moveUpDownSelected(dir)},convertToPath=function(){null!=selectedElement&&svgCanvas.convertToPath()},reorientPath=function(){null!=selectedElement&&path.reorient()},makeHyperlink=function(){(null!=selectedElement||multiselected)&&$.prompt(uiStrings.notification.enterNewLinkURL,"http://",function(url){url&&svgCanvas.makeHyperlink(url)})},moveSelected=function(dx,dy){if(null!=selectedElement||multiselected){if(curConfig.gridSnapping){var multi=svgCanvas.getZoom()*curConfig.snappingStep;dx*=multi,dy*=multi}svgCanvas.moveSelectedElements(dx,dy)}},linkControlPoints=function(){$("#tool_node_link").toggleClass("push_button_pressed tool_button");var linked=$("#tool_node_link").hasClass("push_button_pressed");path.linkControlPoints(linked)},clonePathNode=function(){path.getNodePoint()&&path.clonePathNode()},deletePathNode=function(){path.getNodePoint()&&path.deletePathNode()},addSubPath=function(){var button=$("#tool_add_subpath"),sp=!button.hasClass("push_button_pressed");button.toggleClass("push_button_pressed tool_button"),path.addSubPath(sp)},opencloseSubPath=function(){path.opencloseSubPath()},selectNext=function(){svgCanvas.cycleElement(1)},selectPrev=function(){svgCanvas.cycleElement(0)},rotateSelected=function(cw,step){if(null!=selectedElement&&!multiselected){cw||(step*=-1);var angle=parseFloat($("#angle").val())+step;svgCanvas.setRotationAngle(angle),updateContextPanel()}},clickClear=function(){var dims=curConfig.dimensions;$.confirm(uiStrings.notification.QwantToClear,function(ok){ok&&(setSelectMode(),svgCanvas.clear(),svgCanvas.setResolution(dims[0],dims[1]),updateCanvas(!0),zoomImage(),populateLayers(),updateContextPanel(),prepPaints(),svgCanvas.runExtensions("onNewDocument"))})},clickBold=function(){return svgCanvas.setBold(!svgCanvas.getBold()),updateContextPanel(),!1},clickItalic=function(){return svgCanvas.setItalic(!svgCanvas.getItalic()),updateContextPanel(),!1},clickSave=function(){var saveOpts={images:$.pref("img_save"),round_digits:6};svgCanvas.save(saveOpts)},clickExport=function(){$.select("Select an image type for export: ",["PNG","JPEG","BMP","WEBP","PDF"],function(imgType){if(imgType){if(!customHandlers.exportImage){var str=uiStrings.notification.loadingImage;exportWindow=window.open("data:text/html;charset=utf-8,"+encodeURIComponent("<title>"+str+"</title><h1>"+str+"</h1>"),"svg-edit-exportWindow")}var quality=parseInt($("#image-slider").val(),10)/100;svgCanvas.rasterExport(imgType,quality,exportWindow&&exportWindow.name)}},function(){var sel=$(this);"JPEG"===sel.val()||"WEBP"===sel.val()?$("#image-slider").length||$('<div><label>Quality: <input id="image-slider" type="range" min="1" max="100" value="92" /></label></div>').appendTo(sel.parent()):$("#image-slider").parent().remove()})},clickOpen=function(){svgCanvas.open()},clickImport=function(){},clickUndo=function(){undoMgr.getUndoStackSize()>0&&(undoMgr.undo(),populateLayers())},clickRedo=function(){undoMgr.getRedoStackSize()>0&&(undoMgr.redo(),populateLayers())},clickGroup=function(){multiselected?svgCanvas.groupSelectedElements():selectedElement&&svgCanvas.ungroupSelectedElement()},clickClone=function(){svgCanvas.cloneSelectedElements(20,20)},clickAlign=function(){var letter=this.id.replace("tool_align","").charAt(0);svgCanvas.alignSelectedElements(letter,$("#align_relative_to").val())},clickWireframe=function(){if($("#tool_wireframe").toggleClass("push_button_pressed tool_button"),workarea.toggleClass("wireframe"),!supportsNonSS){var wf_rules=$("#wireframe_rules");wf_rules.length?wf_rules.empty():wf_rules=$('<style id="wireframe_rules"></style>').appendTo("head"),updateWireFrame()}};$("#svg_docprops_container, #svg_prefs_container").draggable({cancel:"button,fieldset",containment:"window"});var showDocProperties=function(){if(!docprops){docprops=!0,$("#image_save_opts input").val([$.pref("img_save")]);var res=svgCanvas.getResolution();"px"!==curConfig.baseUnit&&(res.w=svgedit.units.convertUnit(res.w)+curConfig.baseUnit,res.h=svgedit.units.convertUnit(res.h)+curConfig.baseUnit),$("#canvas_width").val(res.w),$("#canvas_height").val(res.h),$("#canvas_title").val(svgCanvas.getDocumentTitle()),$("#svg_docprops").show()}},showPreferences=function(){if(!preferences){preferences=!0,$("#main_menu").hide();var blocks=$("#bg_blocks div"),cur_bg="cur_background",canvas_bg=curPrefs.bkgd_color,url=$.pref("bkgd_url");blocks.each(function(){var blk=$(this),is_bg=blk.css("background-color")==canvas_bg;blk.toggleClass(cur_bg,is_bg),is_bg&&$("#canvas_bg_url").removeClass(cur_bg)}),canvas_bg||blocks.eq(0).addClass(cur_bg),url&&$("#canvas_bg_url").val(url),$("#grid_snapping_on").prop("checked",curConfig.gridSnapping),$("#grid_snapping_step").attr("value",curConfig.snappingStep),$("#grid_color").attr("value",curConfig.gridColor),$("#svg_prefs").show()}},hideSourceEditor=function(){$("#svg_source_editor").hide(),editingsource=!1,$("#svg_source_textarea").blur()},saveSourceEditor=function(){if(editingsource){var saveChanges=function(){svgCanvas.clearSelection(),hideSourceEditor(),zoomImage(),populateLayers(),updateTitle(),prepPaints()};svgCanvas.setSvgString($("#svg_source_textarea").val())?saveChanges():$.confirm(uiStrings.notification.QerrorsRevertToSource,function(ok){return ok?void saveChanges():!1}),setSelectMode()}},hideDocProperties=function(){$("#svg_docprops").hide(),$("#canvas_width,#canvas_height").removeAttr("disabled"),$("#resolution")[0].selectedIndex=0,$("#image_save_opts input").val([$.pref("img_save")]),docprops=!1},hidePreferences=function(){$("#svg_prefs").hide(),preferences=!1},saveDocProperties=function(){var newTitle=$("#canvas_title").val();updateTitle(newTitle),svgCanvas.setDocumentTitle(newTitle);var width=$("#canvas_width"),w=width.val(),height=$("#canvas_height"),h=height.val();return"fit"==w||svgedit.units.isValidUnit("width",w)?(width.parent().removeClass("error"),"fit"==h||svgedit.units.isValidUnit("height",h)?(height.parent().removeClass("error"),svgCanvas.setResolution(w,h)?($.pref("img_save",$("#image_save_opts :checked").val()),updateCanvas(),void hideDocProperties()):($.alert(uiStrings.notification.noContentToFitTo),!1)):($.alert(uiStrings.notification.invalidAttrValGiven),height.parent().addClass("error"),!1)):($.alert(uiStrings.notification.invalidAttrValGiven),width.parent().addClass("error"),!1)
},savePreferences=editor.savePreferences=function(){var color=$("#bg_blocks div.cur_background").css("background-color")||"#FFF";setBackground(color,$("#canvas_bg_url").val());var lang=$("#lang_select").val();lang!==$.pref("lang")&&editor.putLocale(lang,good_langs),setIconSize($("#iconsize").val()),curConfig.gridSnapping=$("#grid_snapping_on")[0].checked,curConfig.snappingStep=$("#grid_snapping_step").val(),curConfig.gridColor=$("#grid_color").val(),curConfig.showRulers=$("#show_rulers")[0].checked,$("#rulers").toggle(curConfig.showRulers),curConfig.showRulers&&updateRulers(),curConfig.baseUnit=$("#base_unit").val(),svgCanvas.setConfig(curConfig),updateCanvas(),hidePreferences()},resetScrollPos=$.noop,cancelOverlays=function(){return $("#dialog_box").hide(),editingsource||docprops||preferences?(editingsource?origSource!==$("#svg_source_textarea").val()?$.confirm(uiStrings.notification.QignoreSourceChanges,function(ok){ok&&hideSourceEditor()}):hideSourceEditor():docprops?hideDocProperties():preferences&&hidePreferences(),void resetScrollPos()):void(cur_context&&svgCanvas.leaveContext())},win_wh={width:$(window).width(),height:$(window).height()};if(svgedit.browser.isIE()&&!function(){resetScrollPos=function(){0===workarea[0].scrollLeft&&0===workarea[0].scrollTop&&(workarea[0].scrollLeft=curScrollPos.left,workarea[0].scrollTop=curScrollPos.top)},curScrollPos={left:workarea[0].scrollLeft,top:workarea[0].scrollTop},$(window).resize(resetScrollPos),editor.ready(function(){setTimeout(function(){resetScrollPos()},500)}),workarea.scroll(function(){curScrollPos={left:workarea[0].scrollLeft,top:workarea[0].scrollTop}})}(),$(window).resize(function(){$.each(win_wh,function(type,val){var curval=$(window)[type]();workarea[0]["scroll"+("width"===type?"Left":"Top")]-=(curval-val)/2,win_wh[type]=curval}),setFlyoutPositions()}),function(){workarea.scroll(function(){0!=$("#ruler_x").length&&($("#ruler_x")[0].scrollLeft=workarea[0].scrollLeft),0!=$("#ruler_y").length&&($("#ruler_y")[0].scrollTop=workarea[0].scrollTop)})}(),$("#url_notice").click(function(){$.alert(this.title)}),$("#change_image_url").click(promptImgURL),function(){var toolnames=["clear","open","save","source","delete","delete_multi","paste","clone","clone_multi","move_top","move_bottom"],all_tools="",cur_class="tool_button_current";$.each(toolnames,function(i,item){all_tools+=(i?",":"")+"#tool_"+item}),$(all_tools).mousedown(function(){$(this).addClass(cur_class)}).bind("mousedown mouseout",function(){$(this).removeClass(cur_class)}),$("#tool_undo, #tool_redo").mousedown(function(){$(this).hasClass("disabled")||$(this).addClass(cur_class)}).bind("mousedown mouseout",function(){$(this).removeClass(cur_class)})}(),svgedit.browser.isMac()&&!window.opera){var shortcutButtons=["tool_clear","tool_save","tool_source","tool_undo","tool_redo","tool_clone"];for(i=shortcutButtons.length;i--;){var button=document.getElementById(shortcutButtons[i]);if(button){var title=button.title,index=title.indexOf("Ctrl+");button.title=[title.substr(0,index),"Cmd+",title.substr(index+5)].join("")}}}var colorPicker=function(elem){var picker="stroke_color"==elem.attr("id")?"stroke":"fill",paint=paintBox[picker].paint,title="stroke"==picker?"Pick a Stroke Paint and Opacity":"Pick a Fill Paint and Opacity",pos=elem.offset();$("#color_picker").draggable({cancel:".jGraduate_tabs, .jGraduate_colPick, .jGraduate_gradPick, .jPicker",containment:"window"}).css(curConfig.colorPickerCSS||{left:pos.left-140,bottom:40}).jGraduate({paint:paint,window:{pickerTitle:title},images:{clientPath:curConfig.jGraduatePath},newstop:"inverse"},function(p){paint=new $.jGraduate.Paint(p),paintBox[picker].setPaint(paint),svgCanvas.setPaint(picker,paint),$("#color_picker").hide()},function(){$("#color_picker").hide()})},PaintBox=function(container,type){var paintColor,paintOpacity,cur=curConfig["fill"===type?"initFill":"initStroke"],svgdocbox=(new DOMParser).parseFromString('<svg xmlns="http://www.w3.org/2000/svg"><rect width="16.5" height="16.5"					fill="#'+cur.color+'" opacity="'+cur.opacity+'"/>					<defs><linearGradient id="gradbox_"/></defs></svg>',"text/xml"),docElem=svgdocbox.documentElement;docElem=$(container)[0].appendChild(document.importNode(docElem,!0)),docElem.setAttribute("width",16.5),this.rect=docElem.firstChild,this.defs=docElem.getElementsByTagName("defs")[0],this.grad=this.defs.firstChild,this.paint=new $.jGraduate.Paint({solidColor:cur.color}),this.type=type,this.setPaint=function(paint,apply){this.paint=paint;var fillAttr="none",ptype=paint.type,opac=paint.alpha/100;switch(ptype){case"solidColor":fillAttr="none"!=paint[ptype]?"#"+paint[ptype]:paint[ptype];break;case"linearGradient":case"radialGradient":this.defs.removeChild(this.grad),this.grad=this.defs.appendChild(paint[ptype]);var id=this.grad.id="gradbox_"+this.type;fillAttr="url(#"+id+")"}this.rect.setAttribute("fill",fillAttr),this.rect.setAttribute("opacity",opac),apply&&(svgCanvas.setColor(this.type,paintColor,!0),svgCanvas.setPaintOpacity(this.type,paintOpacity,!0))},this.update=function(apply){if(selectedElement){var i,len,type=this.type;switch(selectedElement.tagName){case"use":case"image":case"foreignObject":return;case"g":case"a":var gPaint=null,childs=selectedElement.getElementsByTagName("*");for(i=0,len=childs.length;len>i;i++){var elem=childs[i],p=elem.getAttribute(type);if(0===i)gPaint=p;else if(gPaint!==p){gPaint=null;break}}if(null===gPaint)return void(paintColor=null);paintColor=gPaint,paintOpacity=1;break;default:paintOpacity=parseFloat(selectedElement.getAttribute(type+"-opacity")),isNaN(paintOpacity)&&(paintOpacity=1);var defColor="fill"===type?"black":"none";paintColor=selectedElement.getAttribute(type)||defColor}apply&&(svgCanvas.setColor(type,paintColor,!0),svgCanvas.setPaintOpacity(type,paintOpacity,!0)),paintOpacity*=100;var paint=getPaint(paintColor,paintOpacity,type);this.setPaint(paint)}},this.prep=function(){var ptype=this.paint.type;switch(ptype){case"linearGradient":case"radialGradient":var paint=new $.jGraduate.Paint({copy:this.paint});svgCanvas.setPaint(type,paint)}}};paintBox.fill=new PaintBox("#fill_color","fill"),paintBox.stroke=new PaintBox("#stroke_color","stroke"),$("#stroke_width").val(curConfig.initStroke.width),$("#group_opacity").val(100*curConfig.initOpacity);var testEl=paintBox.fill.rect.cloneNode(!1);testEl.setAttribute("style","vector-effect:non-scaling-stroke"),supportsNonSS="non-scaling-stroke"===testEl.style.vectorEffect,testEl.removeAttribute("style");var svgdocbox=paintBox.fill.rect.ownerDocument,blurTest=svgdocbox.createElementNS(svgedit.NS.SVG,"feGaussianBlur");void 0===blurTest.stdDeviationX&&$("#tool_blur").hide(),$(blurTest).remove(),function(){var pre="-"+uaPrefix.toLowerCase()+"-zoom-",zoom=pre+"in";workarea.css("cursor",zoom),workarea.css("cursor")===zoom&&(zoomInIcon=zoom,zoomOutIcon=pre+"out"),workarea.css("cursor","auto")}(),setTimeout(function(){svgCanvas.embedImage(curConfig.imgPath+"logo.png",function(datauri){datauri||($("#image_save_opts [value=embed]").attr("disabled","disabled"),$("#image_save_opts input").val(["ref"]),$.pref("img_save","ref"),$("#image_opt_embed").css("color","#666").attr("title",uiStrings.notification.featNotSupported))})},1e3),$("#fill_color, #tool_fill .icon_label").click(function(){colorPicker($("#fill_color")),updateToolButtonState()}),$("#stroke_color, #tool_stroke .icon_label").click(function(){colorPicker($("#stroke_color")),updateToolButtonState()}),$("#group_opacityLabel").click(function(){$("#opacity_dropdown button").mousedown(),$(window).mouseup()}),$("#zoomLabel").click(function(){$("#zoom_dropdown button").mousedown(),$(window).mouseup()}),$("#tool_move_top").mousedown(function(evt){$("#tools_stacking").show(),evt.preventDefault()}),$(".layer_button").mousedown(function(){$(this).addClass("layer_buttonpressed")}).mouseout(function(){$(this).removeClass("layer_buttonpressed")}).mouseup(function(){$(this).removeClass("layer_buttonpressed")}),$(".push_button").mousedown(function(){$(this).hasClass("disabled")||$(this).addClass("push_button_pressed").removeClass("push_button")}).mouseout(function(){$(this).removeClass("push_button_pressed").addClass("push_button")}).mouseup(function(){$(this).removeClass("push_button_pressed").addClass("push_button")}),$("#layer_new").click(function(){var uniqName,i=svgCanvas.getCurrentDrawing().getNumLayers();do uniqName=uiStrings.layers.layer+" "+ ++i;while(svgCanvas.getCurrentDrawing().hasLayer(uniqName));$.prompt(uiStrings.notification.enterUniqueLayerName,uniqName,function(newName){if(newName){if(svgCanvas.getCurrentDrawing().hasLayer(newName))return void $.alert(uiStrings.notification.dupeLayerName);svgCanvas.createLayer(newName),updateContextPanel(),populateLayers()}})}),$("#layer_delete").click(deleteLayer),$("#layer_up").click(function(){moveLayer(-1)}),$("#layer_down").click(function(){moveLayer(1)}),$("#layer_rename").click(function(){var oldName=$("#layerlist tr.layersel td.layername").text();$.prompt(uiStrings.notification.enterNewLayerName,"",function(newName){if(newName){if(oldName==newName||svgCanvas.getCurrentDrawing().hasLayer(newName))return void $.alert(uiStrings.notification.layerHasThatName);svgCanvas.renameCurrentLayer(newName),populateLayers()}})});var SIDEPANEL_MAXWIDTH=300,SIDEPANEL_OPENWIDTH=150,sidedrag=-1,sidedragging=!1,allowmove=!1,changeSidePanelWidth=function(delta){var rulerX=$("#ruler_x");$("#sidepanels").width("+="+delta),$("#layerpanel").width("+="+delta),rulerX.css("right",parseInt(rulerX.css("right"),10)+delta),workarea.css("right",parseInt(workarea.css("right"),10)+delta),svgCanvas.runExtensions("workareaResized")},resizeSidePanel=function(evt){if(allowmove&&-1!=sidedrag){sidedragging=!0;var deltaX=sidedrag-evt.pageX,sideWidth=$("#sidepanels").width();sideWidth+deltaX>SIDEPANEL_MAXWIDTH?(deltaX=SIDEPANEL_MAXWIDTH-sideWidth,sideWidth=SIDEPANEL_MAXWIDTH):2>sideWidth+deltaX&&(deltaX=2-sideWidth,sideWidth=2),0!=deltaX&&(sidedrag-=deltaX,changeSidePanelWidth(deltaX))}},toggleSidePanel=function(close){var w=$("#sidepanels").width(),deltaX=(w>2||close?2:SIDEPANEL_OPENWIDTH)-w;changeSidePanelWidth(deltaX)};$("#sidepanel_handle").mousedown(function(evt){sidedrag=evt.pageX,$(window).mousemove(resizeSidePanel),allowmove=!1,setTimeout(function(){allowmove=!0},20)}).mouseup(function(){sidedragging||toggleSidePanel(),sidedrag=-1,sidedragging=!1}),$(window).mouseup(function(){sidedrag=-1,sidedragging=!1,$("#svg_editor").unbind("mousemove",resizeSidePanel)}),populateLayers();var centerCanvas=function(){workarea.css("line-height",workarea.height()+"px")};$(window).bind("load resize",centerCanvas),$("#resolution").change(function(){var wh=$("#canvas_width,#canvas_height");if(this.selectedIndex)if("content"==this.value)wh.val("fit").attr("disabled","disabled");else{var dims=this.value.split("x");$("#canvas_width").val(dims[0]),$("#canvas_height").val(dims[1]),wh.removeAttr("disabled")}else"fit"==$("#canvas_width").val()&&wh.removeAttr("disabled").val(100)}),$("input,select").attr("autocomplete","off"),Actions=function(){var tool_buttons=[{sel:"#tool_select",fn:clickSelect,evt:"click",key:["V",!0]},{sel:"#tool_fhpath",fn:clickFHPath,evt:"click",key:["Q",!0]},{sel:"#tool_line",fn:clickLine,evt:"click",key:["L",!0]},{sel:"#tool_rect",fn:clickRect,evt:"mouseup",key:["R",!0],parent:"#tools_rect",icon:"rect"},{sel:"#tool_square",fn:clickSquare,evt:"mouseup",parent:"#tools_rect",icon:"square"},{sel:"#tool_fhrect",fn:clickFHRect,evt:"mouseup",parent:"#tools_rect",icon:"fh_rect"},{sel:"#tool_ellipse",fn:clickEllipse,evt:"mouseup",key:["E",!0],parent:"#tools_ellipse",icon:"ellipse"},{sel:"#tool_circle",fn:clickCircle,evt:"mouseup",parent:"#tools_ellipse",icon:"circle"},{sel:"#tool_fhellipse",fn:clickFHEllipse,evt:"mouseup",parent:"#tools_ellipse",icon:"fh_ellipse"},{sel:"#tool_path",fn:clickPath,evt:"click",key:["P",!0]},{sel:"#tool_text",fn:clickText,evt:"click",key:["T",!0]},{sel:"#tool_image",fn:clickImage,evt:"mouseup"},{sel:"#tool_zoom",fn:clickZoom,evt:"mouseup",key:["Z",!0]},{sel:"#tool_clear",fn:clickClear,evt:"mouseup",key:["N",!0]},{sel:"#tool_save",fn:function(){editingsource?saveSourceEditor():clickSave()},evt:"mouseup",key:["S",!0]},{sel:"#tool_export",fn:clickExport,evt:"mouseup"},{sel:"#tool_open",fn:clickOpen,evt:"mouseup",key:["O",!0]},{sel:"#tool_import",fn:clickImport,evt:"mouseup"},{sel:"#tool_source",fn:showSourceEditor,evt:"click",key:["U",!0]},{sel:"#tool_wireframe",fn:clickWireframe,evt:"click",key:["F",!0]},{sel:"#tool_source_cancel,.overlay,#tool_docprops_cancel,#tool_prefs_cancel",fn:cancelOverlays,evt:"click",key:["esc",!1,!1],hidekey:!0},{sel:"#tool_source_save",fn:saveSourceEditor,evt:"click"},{sel:"#tool_docprops_save",fn:saveDocProperties,evt:"click"},{sel:"#tool_docprops",fn:showDocProperties,evt:"mouseup"},{sel:"#tool_prefs_save",fn:savePreferences,evt:"click"},{sel:"#tool_prefs_option",fn:function(){return showPreferences(),!1},evt:"mouseup"},{sel:"#tool_delete,#tool_delete_multi",fn:deleteSelected,evt:"click",key:["del/backspace",!0]},{sel:"#tool_reorient",fn:reorientPath,evt:"click"},{sel:"#tool_node_link",fn:linkControlPoints,evt:"click"},{sel:"#tool_node_clone",fn:clonePathNode,evt:"click"},{sel:"#tool_node_delete",fn:deletePathNode,evt:"click"},{sel:"#tool_openclose_path",fn:opencloseSubPath,evt:"click"},{sel:"#tool_add_subpath",fn:addSubPath,evt:"click"},{sel:"#tool_move_top",fn:moveToTopSelected,evt:"click",key:"ctrl+shift+]"},{sel:"#tool_move_bottom",fn:moveToBottomSelected,evt:"click",key:"ctrl+shift+["},{sel:"#tool_topath",fn:convertToPath,evt:"click"},{sel:"#tool_make_link,#tool_make_link_multi",fn:makeHyperlink,evt:"click"},{sel:"#tool_undo",fn:clickUndo,evt:"click",key:["Z",!0]},{sel:"#tool_redo",fn:clickRedo,evt:"click",key:["Y",!0]},{sel:"#tool_clone,#tool_clone_multi",fn:clickClone,evt:"click",key:["D",!0]},{sel:"#tool_group_elements",fn:clickGroup,evt:"click",key:["G",!0]},{sel:"#tool_ungroup",fn:clickGroup,evt:"click"},{sel:"#tool_unlink_use",fn:clickGroup,evt:"click"},{sel:"[id^=tool_align]",fn:clickAlign,evt:"click"},{sel:"#tool_bold",fn:clickBold,evt:"mousedown"},{sel:"#tool_italic",fn:clickItalic,evt:"mousedown"},{sel:"#sidepanel_handle",fn:toggleSidePanel,key:["X"]},{sel:"#copy_save_done",fn:cancelOverlays,evt:"click"},{key:"ctrl+left",fn:function(){rotateSelected(0,1)}},{key:"ctrl+right",fn:function(){rotateSelected(1,1)}},{key:"ctrl+shift+left",fn:function(){rotateSelected(0,5)}},{key:"ctrl+shift+right",fn:function(){rotateSelected(1,5)}},{key:"shift+O",fn:selectPrev},{key:"shift+P",fn:selectNext},{key:[modKey+"up",!0],fn:function(){zoomImage(2)}},{key:[modKey+"down",!0],fn:function(){zoomImage(.5)}},{key:[modKey+"]",!0],fn:function(){moveUpDownSelected("Up")}},{key:[modKey+"[",!0],fn:function(){moveUpDownSelected("Down")}},{key:["up",!0],fn:function(){moveSelected(0,-1)}},{key:["down",!0],fn:function(){moveSelected(0,1)}},{key:["left",!0],fn:function(){moveSelected(-1,0)}},{key:["right",!0],fn:function(){moveSelected(1,0)}},{key:"shift+up",fn:function(){moveSelected(0,-10)}},{key:"shift+down",fn:function(){moveSelected(0,10)}},{key:"shift+left",fn:function(){moveSelected(-10,0)}},{key:"shift+right",fn:function(){moveSelected(10,0)}},{key:["alt+up",!0],fn:function(){svgCanvas.cloneSelectedElements(0,-1)}},{key:["alt+down",!0],fn:function(){svgCanvas.cloneSelectedElements(0,1)}},{key:["alt+left",!0],fn:function(){svgCanvas.cloneSelectedElements(-1,0)}},{key:["alt+right",!0],fn:function(){svgCanvas.cloneSelectedElements(1,0)}},{key:["alt+shift+up",!0],fn:function(){svgCanvas.cloneSelectedElements(0,-10)}},{key:["alt+shift+down",!0],fn:function(){svgCanvas.cloneSelectedElements(0,10)}},{key:["alt+shift+left",!0],fn:function(){svgCanvas.cloneSelectedElements(-10,0)}},{key:["alt+shift+right",!0],fn:function(){svgCanvas.cloneSelectedElements(10,0)}},{key:"A",fn:function(){svgCanvas.selectAllInCurrentLayer()}},{key:modKey+"z",fn:clickUndo},{key:modKey+"shift+z",fn:clickRedo},{key:modKey+"y",fn:clickRedo},{key:modKey+"x",fn:cutSelected},{key:modKey+"c",fn:copySelected},{key:modKey+"v",fn:pasteInCenter}],key_assocs={"4/Shift+4":"#tools_rect_show","5/Shift+5":"#tools_ellipse_show"};return{setAll:function(){var flyouts={};$.each(tool_buttons,function(i,opts){var btn;if(opts.sel){if(btn=$(opts.sel),0==btn.length)return!0;if(opts.evt&&(svgedit.browser.isTouch()&&"click"===opts.evt&&(opts.evt="mousedown"),btn[opts.evt](opts.fn)),opts.parent&&0!=$(opts.parent+"_show").length){var f_h=$(opts.parent);f_h.length||(f_h=makeFlyoutHolder(opts.parent.substr(1))),f_h.append(btn),$.isArray(flyouts[opts.parent])||(flyouts[opts.parent]=[]),flyouts[opts.parent].push(opts)}}if(opts.key){var keyval,disInInp=!0,fn=opts.fn,pd=!1;if($.isArray(opts.key)?(keyval=opts.key[0],opts.key.length>1&&(pd=opts.key[1]),opts.key.length>2&&(disInInp=opts.key[2])):keyval=opts.key,keyval+="",$.each(keyval.split("/"),function(i,key){$(document).bind("keydown",key,function(e){return fn(),pd&&e.preventDefault(),!1})}),opts.sel&&!opts.hidekey&&btn.attr("title")){var newTitle=btn.attr("title").split("[")[0]+" ("+keyval+")";key_assocs[keyval]=opts.sel,btn.parents("#main_menu").length||btn.attr("title",newTitle)}}}),setupFlyouts(flyouts),$(".attr_changer, #image_url").bind("keydown","return",function(evt){$(this).change(),evt.preventDefault()}),$(window).bind("keydown","tab",function(e){"canvas"===ui_context&&(e.preventDefault(),selectNext())}).bind("keydown","shift+tab",function(e){"canvas"===ui_context&&(e.preventDefault(),selectPrev())}),$("#tool_zoom").dblclick(dblclickZoom)},setTitles:function(){$.each(key_assocs,function(keyval,sel){var menu=$(sel).parents("#main_menu").length;$(sel).each(function(){var t;t=menu?$(this).text().split(" [")[0]:this.title.split(" [")[0];var key_str="";$.each(keyval.split("/"),function(i,key){var mod_bits=key.split("+"),mod="";mod_bits.length>1&&(mod=mod_bits[0]+"+",key=mod_bits[1]),key_str+=(i?"/":"")+mod+(uiStrings["key_"+key]||key)}),menu?this.lastChild.textContent=t+" ["+key_str+"]":this.title=t+" ["+key_str+"]"})})},getButtonData:function(sel){var b;return $.each(tool_buttons,function(i,btn){btn.sel===sel&&(b=btn)}),b}}}(),Actions.setAll(),editor.ready(function(){var tool,itool=curConfig.initTool,container=$("#tools_left, #svg_editor .tools_flyout"),pre_tool=container.find("#tool_"+itool),reg_tool=container.find("#"+itool);tool=pre_tool.length?pre_tool:reg_tool.length?reg_tool:$("#tool_select"),tool.click().mouseup(),curConfig.wireframe&&$("#tool_wireframe").click(),curConfig.showlayers&&toggleSidePanel(),$("#rulers").toggle(!!curConfig.showRulers),curConfig.showRulers&&($("#show_rulers")[0].checked=!0),curConfig.baseUnit&&$("#base_unit").val(curConfig.baseUnit),curConfig.gridSnapping&&($("#grid_snapping_on")[0].checked=!0),curConfig.snappingStep&&$("#grid_snapping_step").val(curConfig.snappingStep),curConfig.gridColor&&$("#grid_color").val(curConfig.gridColor)}),$("#rect_rx").SpinButton({min:0,max:1e3,callback:changeRectRadius}),$("#stroke_width").SpinButton({min:0,max:99,smallStep:.1,callback:changeStrokeWidth}),$("#angle").SpinButton({min:-180,max:180,step:5,callback:changeRotationAngle}),$("#font_size").SpinButton({min:.001,stepfunc:stepFontSize,callback:changeFontSize}),$("#group_opacity").SpinButton({min:0,max:100,step:5,callback:changeOpacity}),$("#blur").SpinButton({min:0,max:10,step:.1,callback:changeBlur}),$("#zoom").SpinButton({min:.001,max:1e4,step:50,stepfunc:stepZoom,callback:changeZoom}).val(100*svgCanvas.getZoom()),$("#workarea").contextMenu({menu:"cmenu_canvas",inSpeed:0},function(action){switch(action){case"delete":deleteSelected();break;case"cut":cutSelected();break;case"copy":copySelected();break;case"paste":svgCanvas.pasteElements();break;case"paste_in_place":svgCanvas.pasteElements("in_place");break;case"group_elements":svgCanvas.groupSelectedElements();break;case"ungroup":svgCanvas.ungroupSelectedElement();break;case"move_front":moveToTopSelected();break;case"move_up":moveUpDownSelected("Up");break;case"move_down":moveUpDownSelected("Down");break;case"move_back":moveToBottomSelected();break;default:svgedit.contextmenu&&svgedit.contextmenu.hasCustomHandler(action)&&svgedit.contextmenu.getCustomHandler(action).call()}svgCanvas.clipBoard.length&&canv_menu.enableContextMenuItems("#paste,#paste_in_place")});var lmenu_func=function(action){switch(action){case"dupe":cloneLayer();break;case"delete":deleteLayer();break;case"merge_down":mergeLayer();break;case"merge_all":svgCanvas.mergeAllLayers(),updateContextPanel(),populateLayers()}};if($("#layerlist").contextMenu({menu:"cmenu_layers",inSpeed:0},lmenu_func),$("#layer_moreopts").contextMenu({menu:"cmenu_layers",inSpeed:0,allowLeft:!0},lmenu_func),$(".contextMenu li").mousedown(function(ev){ev.preventDefault()}),$("#cmenu_canvas li").disableContextMenu(),canv_menu.enableContextMenuItems("#delete,#cut,#copy"),window.addEventListener("beforeunload",function(e){return 0===undoMgr.getUndoStackSize()&&(editor.showSaveWarning=!1),!curConfig.no_save_warning&&editor.showSaveWarning?(e.returnValue=uiStrings.notification.unsavedChanges,uiStrings.notification.unsavedChanges):void 0},!1),editor.openPrep=function(func){$("#main_menu").hide(),0===undoMgr.getUndoStackSize()?func(!0):$.confirm(uiStrings.notification.QwantToOpen,func)},window.FileReader){var importImage=function(e){$.process_cancel(uiStrings.notification.loadingImage),e.stopPropagation(),e.preventDefault(),$("#workarea").removeAttr("style"),$("#main_menu").hide();var file="drop"==e.type?e.dataTransfer.files[0]:this.files[0];if(file&&-1!=file.type.indexOf("image")){var reader=new FileReader;reader.onerror=function(){$.alert("Couldn't read file!\n"+reader.error)},-1!=file.type.indexOf("svg")?(reader.onloadend=function(e){svgCanvas.importSvgString(e.target.result,!0),svgCanvas.ungroupSelectedElement(),svgCanvas.ungroupSelectedElement(),svgCanvas.groupSelectedElements(),svgCanvas.alignSelectedElements("m","page"),svgCanvas.alignSelectedElements("c","page"),$.main_dialog_hide()},reader.readAsText(file)):(reader.onloadend=function(e){var insertNewImage=function(width,height){var newImage=svgCanvas.addSvgElementFromJson({element:"image",attr:{x:0,y:0,width:width,height:height,id:svgCanvas.getNextId(),style:"pointer-events:inherit"}});svgCanvas.setHref(newImage,e.target.result),svgCanvas.selectOnly([newImage]),svgCanvas.alignSelectedElements("m","page"),svgCanvas.alignSelectedElements("c","page"),updateContextPanel(),$.main_dialog_hide()},imgWidth=100,imgHeight=100,img=new Image;img.src=e.target.result,img.style.opacity=0,img.onload=function(){imgWidth=img.offsetWidth,imgHeight=img.offsetHeight,insertNewImage(imgWidth,imgHeight)}},reader.readAsDataURL(file))}};workarea[0].addEventListener("dragenter",onDragEnter,!1),workarea[0].addEventListener("dragover",onDragOver,!1),workarea[0].addEventListener("dragleave",onDragLeave,!1),workarea[0].addEventListener("drop",importImage,!1);var open=$('<input type="file">').change(function(){var f=this;editor.openPrep(function(ok){if(ok&&(svgCanvas.clear(),1===f.files.length)){$.process_cancel(uiStrings.notification.loadingImage);var reader=new FileReader;reader.onloadend=function(e){loadSvgString(e.target.result),updateCanvas()},reader.readAsText(f.files[0])}})});$("#tool_open").show().prepend(open);var imgImport=$('<input type="file">').change(importImage);$("#tool_import").show().prepend(imgImport)}updateCanvas(!0),$(function(){window.svgCanvas=svgCanvas,svgCanvas.ready=editor.ready}),editor.setLang=function(lang,allStrings){if(editor.langChanged=!0,$.pref("lang",lang),$("#lang_select").val(lang),allStrings){var oldLayerName=$("#layerlist tr.layersel td.layername").text(),rename_layer=oldLayerName==uiStrings.common.layer+" 1";if($.extend(uiStrings,allStrings),svgCanvas.setUiStrings(allStrings),Actions.setTitles(),rename_layer&&(svgCanvas.renameCurrentLayer(uiStrings.common.layer+" 1"),populateLayers()),extsPreLang.length)for(;extsPreLang.length;){var ext=extsPreLang.shift();ext.langReady({lang:lang,uiStrings:uiStrings})}else svgCanvas.runExtensions("langReady",{lang:lang,uiStrings:uiStrings});svgCanvas.runExtensions("langChanged",lang),setFlyoutTitles();var elems={"#stroke_color":"#tool_stroke .icon_label, #tool_stroke .color_block","#fill_color":"#tool_fill label, #tool_fill .color_block","#linejoin_miter":"#cur_linejoin","#linecap_butt":"#cur_linecap"};$.each(elems,function(source,dest){$(dest).attr("title",$(source)[0].title)}),$("#multiselected_panel div[id^=tool_align]").each(function(){$("#tool_pos"+this.id.substr(10))[0].title=this.title})}}},editor.ready=function(cb){isReady?cb():callbacks.push(cb)},editor.runCallbacks=function(){$.each(callbacks,function(){this()}),isReady=!0},editor.loadFromString=function(str){editor.ready(function(){loadSvgString(str)})},editor.disableUI=function(){},editor.loadFromURL=function(url,opts){opts||(opts={});var cache=opts.cache,cb=opts.callback;editor.ready(function(){$.ajax({url:url,dataType:"text",cache:!!cache,beforeSend:function(){$.process_cancel(uiStrings.notification.loadingImage)},success:function(str){loadSvgString(str,cb)},error:function(xhr,stat,err){404!=xhr.status&&xhr.responseText?loadSvgString(xhr.responseText,cb):$.alert(uiStrings.notification.URLloadFail+": \n"+err,cb)},complete:function(){$("#dialog_box").hide()}})})},editor.loadFromDataURI=function(str){editor.ready(function(){var base64=!1,pre=str.match(/^data:image\/svg\+xml;base64,/);pre?base64=!0:pre=str.match(/^data:image\/svg\+xml(?:;(?:utf8)?)?,/),pre&&(pre=pre[0]);var src=str.slice(pre.length);loadSvgString(base64?Utils.decode64(src):decodeURIComponent(src))})},editor.addExtension=function(){var args=arguments;$(function(){svgCanvas&&svgCanvas.addExtension.apply(this,args)})},editor}(jQuery),$(svgEditor.init))}();var svgEditor=function($,editor){"use strict";function setStrings(type,obj,ids){var i,sel,val,$elem,elem,node,parent=$("#svg_editor").parent();for(sel in obj)if(val=obj[sel],val||console.log(sel),ids&&(sel="#"+sel),$elem=parent.find(sel),$elem.length)switch(elem=parent.find(sel)[0],type){case"content":for(i=0;i<elem.childNodes.length;i++)if(node=elem.childNodes[i],3===node.nodeType&&node.textContent.replace(/\s/g,"")){node.textContent=val;break}break;case"title":elem.title=val}else console.log("Missing: "+sel)}var lang_param;return editor.readLang=function(langData){var more=editor.canvas.runExtensions("addlangData",lang_param,!0);if($.each(more,function(i,m){m.data&&(langData=$.merge(langData,m.data)),m.tools&&langData.tools&&(langData.tools=$.extend(!1,langData.tools,m.tools))}),langData.tools){var tools=langData.tools,properties=(langData.misc,langData.properties),config=langData.config,layers=langData.layers,common=langData.common,ui=langData.ui;setStrings("content",{curve_segments:properties.curve_segments,fitToContent:tools.fitToContent,fit_to_all:tools.fit_to_all,fit_to_canvas:tools.fit_to_canvas,fit_to_layer_content:tools.fit_to_layer_content,fit_to_sel:tools.fit_to_sel,icon_large:config.icon_large,icon_medium:config.icon_medium,icon_small:config.icon_small,icon_xlarge:config.icon_xlarge,image_opt_embed:config.image_opt_embed,image_opt_ref:config.image_opt_ref,includedImages:config.included_images,largest_object:tools.largest_object,layersLabel:layers.layers,page:tools.page,relativeToLabel:tools.relativeTo,selLayerLabel:layers.move_elems_to,selectedPredefined:config.select_predefined,selected_objects:tools.selected_objects,smallest_object:tools.smallest_object,straight_segments:properties.straight_segments,svginfo_bg_url:config.editor_img_url+":",svginfo_bg_note:config.editor_bg_note,svginfo_change_background:config.background,svginfo_dim:config.doc_dims,svginfo_editor_prefs:config.editor_prefs,svginfo_height:common.height,svginfo_icons:config.icon_size,svginfo_image_props:config.image_props,svginfo_lang:config.language,svginfo_title:config.doc_title,svginfo_width:common.width,tool_docprops_cancel:common.cancel,tool_docprops_save:common.ok,tool_source_cancel:common.cancel,tool_source_save:common.ok,tool_prefs_cancel:common.cancel,tool_prefs_save:common.ok,sidepanel_handle:layers.layers.split("").join(" "),tool_clear:tools.new_doc,tool_docprops:tools.docprops,tool_export:tools.export_img,tool_import:tools.import_doc,tool_imagelib:tools.imagelib,tool_open:tools.open_doc,tool_save:tools.save_doc,svginfo_units_rulers:config.units_and_rulers,svginfo_rulers_onoff:config.show_rulers,svginfo_unit:config.base_unit,svginfo_grid_settings:config.grid,svginfo_snap_onoff:config.snapping_onoff,svginfo_snap_step:config.snapping_stepsize,svginfo_grid_color:config.grid_color},!0);var o,cats={};for(o in langData.shape_cats)cats['#shape_cats [data-cat="'+o+'"]']=langData.shape_cats[o];setTimeout(function(){setStrings("content",cats)},2e3);var opts={};$.each(["cut","copy","paste","paste_in_place","delete","group","ungroup","move_front","move_up","move_down","move_back"],function(){opts['#cmenu_canvas a[href="#'+this+'"]']=tools[this]}),$.each(["dupe","merge_down","merge_all"],function(){opts['#cmenu_layers a[href="#'+this+'"]']=layers[this]}),opts['#cmenu_layers a[href="#delete"]']=layers.del,setStrings("content",opts),setStrings("title",{align_relative_to:tools.align_relative_to,circle_cx:properties.circle_cx,circle_cy:properties.circle_cy,circle_r:properties.circle_r,cornerRadiusLabel:properties.corner_radius,ellipse_cx:properties.ellipse_cx,ellipse_cy:properties.ellipse_cy,ellipse_rx:properties.ellipse_rx,ellipse_ry:properties.ellipse_ry,fill_color:properties.fill_color,font_family:properties.font_family,idLabel:properties.id,image_height:properties.image_height,image_url:properties.image_url,image_width:properties.image_width,layer_delete:layers.del,layer_down:layers.move_down,layer_new:layers["new"],layer_rename:layers.rename,layer_moreopts:common.more_opts,layer_up:layers.move_up,line_x1:properties.line_x1,line_x2:properties.line_x2,line_y1:properties.line_y1,line_y2:properties.line_y2,linecap_butt:properties.linecap_butt,linecap_round:properties.linecap_round,linecap_square:properties.linecap_square,linejoin_bevel:properties.linejoin_bevel,linejoin_miter:properties.linejoin_miter,linejoin_round:properties.linejoin_round,main_icon:tools.main_menu,mode_connect:tools.mode_connect,tools_shapelib_show:tools.mode_shapelib,palette:ui.palette_info,zoom_panel:ui.zoom_level,path_node_x:properties.node_x,path_node_y:properties.node_y,rect_height_tool:properties.rect_height,rect_width_tool:properties.rect_width,seg_type:properties.seg_type,selLayerNames:layers.move_selected,selected_x:properties.pos_x,selected_y:properties.pos_y,stroke_color:properties.stroke_color,stroke_style:properties.stroke_style,stroke_width:properties.stroke_width,svginfo_title:config.doc_title,text:properties.text_contents,toggle_stroke_tools:ui.toggle_stroke_tools,tool_add_subpath:tools.add_subpath,tool_alignbottom:tools.align_bottom,tool_aligncenter:tools.align_center,tool_alignleft:tools.align_left,tool_alignmiddle:tools.align_middle,tool_alignright:tools.align_right,tool_aligntop:tools.align_top,tool_angle:properties.angle,tool_blur:properties.blur,tool_bold:properties.bold,tool_circle:tools.mode_circle,tool_clone:tools.clone,tool_clone_multi:tools.clone,tool_delete:tools.del,tool_delete_multi:tools.del,tool_ellipse:tools.mode_ellipse,tool_eyedropper:tools.mode_eyedropper,tool_fhellipse:tools.mode_fhellipse,tool_fhpath:tools.mode_fhpath,tool_fhrect:tools.mode_fhrect,tool_font_size:properties.font_size,tool_group_elements:tools.group_elements,tool_make_link:tools.make_link,tool_link_url:tools.set_link_url,tool_image:tools.mode_image,tool_italic:properties.italic,tool_line:tools.mode_line,tool_move_bottom:tools.move_bottom,tool_move_top:tools.move_top,tool_node_clone:tools.node_clone,tool_node_delete:tools.node_delete,tool_node_link:tools.node_link,tool_opacity:properties.opacity,tool_openclose_path:tools.openclose_path,tool_path:tools.mode_path,tool_position:tools.align_to_page,tool_rect:tools.mode_rect,tool_redo:tools.redo,tool_reorient:tools.reorient_path,tool_select:tools.mode_select,tool_source:tools.source_save,tool_square:tools.mode_square,tool_text:tools.mode_text,tool_topath:tools.to_path,tool_undo:tools.undo,tool_ungroup:tools.ungroup,tool_wireframe:tools.wireframe_mode,view_grid:tools.toggle_grid,tool_zoom:tools.mode_zoom,url_notice:tools.no_embed},!0),editor.setLang(lang_param,langData)
}},editor.putLocale=function(given_param,good_langs){if(given_param)lang_param=given_param;else{if(lang_param=$.pref("lang"),!lang_param&&(navigator.userLanguage?lang_param=navigator.userLanguage:navigator.language&&(lang_param=navigator.language),null==lang_param))return;console.log("Lang: "+lang_param),-1===$.inArray(lang_param,good_langs)&&"test"!==lang_param&&(lang_param="en")}var conf=editor.curConfig,url=conf.langPath+"lang."+lang_param+".js";$.getScript(url,function(d){if(!d){var s=document.createElement("script");s.src=url,document.querySelector("head").appendChild(s)}})},editor}(jQuery,svgEditor),svgedit=svgedit||{};!function(){var self=this;svgedit.contextmenu||(svgedit.contextmenu={}),self.contextMenuExtensions={};var menuItemIsValid=function(menuItem){return menuItem&&menuItem.id&&menuItem.label&&menuItem.action&&"function"==typeof menuItem.action},addContextMenuItem=function(menuItem){return menuItemIsValid(menuItem)?menuItem.id in self.contextMenuExtensions?void console.error('Cannot add extension "'+menuItem.id+'", an extension by that name already exists"'):(console.log("Registed contextmenu item: {id:"+menuItem.id+", label:"+menuItem.label+"}"),void(self.contextMenuExtensions[menuItem.id]=menuItem)):void console.error("Menu items must be defined and have at least properties: id, label, action, where action must be a function")},hasCustomHandler=function(handlerKey){return self.contextMenuExtensions[handlerKey]&&!0},getCustomHandler=function(handlerKey){return self.contextMenuExtensions[handlerKey].action},injectExtendedContextMenuItemIntoDom=function(menuItem){0===Object.keys(self.contextMenuExtensions).length&&$("#cmenu_canvas").append("<li class='separator'>");var shortcut=menuItem.shortcut||"";$("#cmenu_canvas").append("<li class='disabled'><a href='#"+menuItem.id+"'>"+menuItem.label+"<span class='shortcut'>"+shortcut+"</span></a></li>")};svgEditor.ready(function(){var menuItem;for(menuItem in contextMenuExtensions)injectExtendedContextMenuItemIntoDom(contextMenuExtensions[menuItem])}),svgedit.contextmenu.resetCustomMenus=function(){self.contextMenuExtensions={}},svgedit.contextmenu.add=addContextMenuItem,svgedit.contextmenu.hasCustomHandler=hasCustomHandler,svgedit.contextmenu.getCustomHandler=getCustomHandler}();